<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <script>
    /* ===== EFFETTO FADE NAVIGAZIONE (solo .content-section, fix visibilità completa) ===== */
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const target = tab.getAttribute('data-target');
          const current = document.querySelector('.content-section.active');
          const next = document.getElementById(target);
          if (!next || current === next) return;

          if (current) {
            current.style.opacity = '0';
            current.style.pointerEvents = 'none';
            setTimeout(() => {
              current.classList.remove('active');
              next.classList.add('active');
              next.style.opacity = '0';
              next.style.pointerEvents = 'all';
              setTimeout(() => { next.style.opacity = '1'; }, 50);
            }, 400);
          } else {
            next.classList.add('active');
            next.style.opacity = '1';
            next.style.pointerEvents = 'all';
          }

          // Aggiorna contenuto dinamico
          if (target === 'classifica-section' && typeof loadClassifica === 'function') {
            setTimeout(() => loadClassifica(), 600);
          }
        });
      });
      
      const firstSection = document.querySelector('.content-section') || document.querySelector('section');
      if (firstSection) firstSection.classList.add('active');
    });
  </script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }
    
    /* NUOVI STILI: Barre Voto */
    .voto-bar-container{
        background: #f0f0f0;
        border-radius: 8px;
        height: 8px;
        overflow: hidden;
        margin-top: 4px;
    }
    .voto-bar{
        height: 100%;
        transition: width var(--duration) var(--ease);
    }
    .voto-bar.red{ background-color: var(--red); }
    .voto-bar.yellow{ background-color: var(--yellow); }
    .voto-bar.green{ background-color: #0e7a0d; }

    /* NUOVI STILI: Risultati Squadra (Prestazioni) */
    .risultato-card {
        border-left: 6px solid transparent;
        transition: background-color var(--duration) var(--ease), border-left-color var(--duration) var(--ease);
    }
    .risultato-card.esito-vittoria {
        background-color: rgba(40, 167, 69, 0.1); /* Sfondo verde chiaro (10% opacità) */
        border-left-color: #28a745; /* Bordo verde scuro */
    }
    .risultato-card.esito-sconfitta {
        background-color: rgba(220, 53, 69, 0.1); /* Sfondo rosso chiaro (10% opacità) */
        border-left-color: #dc3545; /* Bordo rosso scuro */
    }
    .risultato-card.esito-pareggio {
        background-color: rgba(108, 117, 125, 0.1); /* Sfondo grigio chiaro (10% opacità) */
        border-left-color: #6c757d; /* Bordo grigio scuro */
    }


    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  

/* === Effetti di transizione per le sezioni visibili (.content-section) === */
.content-section {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
}
.content-section.active {
  opacity: 1;
  pointer-events: all;
}


</style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; // Usato nella sezione admin-video-section

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section', 'prestazioni-partita-section', 'video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section', // Mantenuto per la logica di showFormazioneForm
      'admin-statistiche-section', // Mantenuta per il form "Risultato"
      'admin-prestazioni-partita-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section'
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; // Includo il login per nasconderlo

    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      ALL_SECTIONS.forEach(secId => { 
        const el = byId(secId); 
        if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
      });
      document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
      document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dall'admin
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); // Protezione base
        
        ALL_SECTIONS.forEach(secId => { 
          const el = byId(secId); 
          if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dal pubblico
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
            t.setAttribute('aria-current', t.dataset.adminTarget===id ? 'page' : 'false');
        });

        // Ricarica i dati specifici per la sezione admin (dal tuo codice originale)
        if(id==='admin-calendario-section'){ window.loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ loadCandidature(); }
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') loadPartitePerVideoAdmin(); 
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             // Se l'admin fa logout, torna alla sezione pubblica di default
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); // Nasconde il form di login dopo lo stato di auth
      toggleAdminUI(); // Aggiorna la UI
      
      // Assicura che una sezione sia visibile al cambio di stato
      if(user && isAdmin) {
         // Se admin loggato, mostra la sezione predefinita admin (es. inserimento giocatori)
         if(byId('admin-inserimento-giocatori-section').style.display === 'none'){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         // Se loggout o utente normale, mostra la sezione pubblica predefinita
         window.showPublicSection('rosa-section');
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          // Ricarica la sezione pubblica dopo il logout
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded',()=>{
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) – usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      window.showPublicSection('rosa-section');
      loadRosa(); 
      window.loadProssimeGiornate(false); // Carica calendario
      loadStatistiche(); // Carica solo risultati
      window.loadPrestazioniAggregato(); // Carica aggregato giocatori
      window.loadClassifica(); // Carica classifica da cache
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);

      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
      byId('rosa-tab')?.addEventListener('click', loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => window.loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', () => {
          loadStatistiche(); 
          window.loadPrestazioniAggregato();
      });
      byId('video-tab')?.addEventListener('click', loadVideoList);
      byId('classifica-tab')?.addEventListener('click', window.loadClassifica);
    });
    
    
    /**
     * NUOVA Funzione Classifica:
     * Legge SOLO dalla cache di Firebase.
     */
    window.loadClassifica = async () => {
      const classificaContent = byId('classifica-content');
      if (!classificaContent) return;
      classificaContent.innerHTML = `<div class="help">Caricamento classifica...</div>`;
      try {
        const snap = await get(ref(db, 'classifica_cache'));
        const cache = (snap.exists() && snap.val()) ? snap.val() : {};
        if (cache.html) {
          classificaContent.innerHTML = cache.html;
        } else {
          classificaContent.innerHTML = `<div class="help">Classifica non ancora disponibile. L'amministratore deve aggiornarla.</div>`;
        }
      } catch (e) {
        console.error("Errore caricamento classifica:", e);
        classificaContent.innerHTML = `<div class="help" style="color:red">Errore caricamento classifica.</div>`;
      }
    };

    /**
     * NUOVA Funzione Admin:
     * Aggiorna la classifica dal sito e la salva su Firebase.
     */
    window.updateClassificaFromSito = async () => {
      if (!isAdmin) return alert('Accesso negato. Solo gli amministratori possono aggiornare la classifica.');
      
      alert('Aggiornamento classifica in corso... Attendere prego.');

      try {
        const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
        const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
        const response = await fetch(proxy);
        const data = await response.json();

        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "text/html");

        const remoteTable = doc.querySelector(".table-responsive table, table.table, table");
        if (!remoteTable) {
          alert('Errore: Impossibile trovare la tabella della classifica sul sito remoto.');
          return;
        }

        // Riduci loghi
        remoteTable.querySelectorAll("img").forEach(img => {
          img.style.maxWidth = "25px";
          img.style.height = "auto";
          img.style.verticalAlign = "middle";
        });

        // Estrai intestazioni e righe
        const headerNodes = remoteTable.querySelectorAll("thead th");
        const headers = headerNodes.length ? Array.from(headerNodes).map(th => th.textContent.trim())
          : Array.from(remoteTable.querySelectorAll("tr:first-child th, tr:first-child td")).map(el => el.textContent.trim());

        const rows = remoteTable.querySelectorAll("tbody tr");
        const bodyRows = rows.length ? Array.from(rows) : Array.from(remoteTable.querySelectorAll("tr")).slice(1);

        // Calcola numero colonne e larghezze uniformi
        const colCount = headers.length || (bodyRows[0]?.children.length || 8);
        const widthPercent = (100 / colCount).toFixed(4) + '%';

        // Costruisci thead
        let theadHTML = '';
        if (headers.length) {
          theadHTML = '<thead><tr>' + headers.map(h => 
            `<th style="width:${widthPercent};padding:8px;text-align:center;border-bottom:2px solid #ccc;background:#8B0000;color:#fff;font-weight:600;font-size:14px;word-wrap:break-word">${h}</th>`
          ).join('') + '</tr></thead>';
        }

        // Costruisci tbody con celle uniformi
        const tbodyHTML = bodyRows.map((tr, idx) => {
          const cells = Array.from(tr.children);
          const rowHTML = cells.map(td => 
            `<td style="width:${widthPercent};padding:8px;text-align:center;border-bottom:1px solid #ddd;font-size:13px;word-wrap:break-word">${td.innerHTML}</td>`
          ).join('');
          const bg = idx % 2 === 1 ? ' style="background:#f8f8f8"' : '';
          return `<tr${bg}>${rowHTML}</tr>`;
        }).join('');

        const normalizedHTML = `
          <div class="help">Classifica aggiornata manualmente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
          <div style="overflow-x:auto">
            <table class="table" style="width:100%;border-collapse:collapse;table-layout:fixed;margin-top:8px">
              ${theadHTML}
              <tbody>${tbodyHTML}</tbody>
            </table>
          </div>
          <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
        `;

        // Salva cache
        await set(ref(db, 'classifica_cache'), {
          html: normalizedHTML,
          timestamp: Date.now()
        });

        // Aggiorna la vista
        await window.loadClassifica();
        alert('Classifica aggiornata con successo!');

      } catch (e) {
        console.error('Errore aggiornamento classifica:', e);
        alert('Errore durante l\'aggiornamento della classifica: ' + e.message);
      }
    };


    /* ===== NUOVE FUNZIONI VIDEO (INTEGRATE) ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; // Ferma la riproduzione
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); // Usa 'calendario' come il resto del tuo codice
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => {
          const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const dateA = toDate(partite[a].data);
          const dateB = toDate(partite[b].data);
          return dateB - dateA;
        });

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="window.openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    // Carica le partite per il menu a tendina Admin (solo quelle concluse)
    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // Aggiorna il campo input quando la partita selezionata cambia
    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    // Salva il link video nel database
    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");

      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");

      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;

        await update(ref(db), updates);

        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); // Aggiorna anche la sezione pubblica immediatamente
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Originali dell'Utente (Integrate) ===== */
    
    async function loadRosa(){
      const ul = byId('rosa-list'); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const val = snap.val() || {};
      const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      if(!rows.length){ ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>'; return; }
      ul.className='grid cols-2';
      rows.forEach(([id,g])=>{
        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
              <div class="player-sub">Ruolo: <b>${g.ruolo}</b> • Stato: <b>${g.stato}</b></div>
            </div>
          </div>`;
        ul.appendChild(li);
      });
    }

    /**
     * FUNZIONE loadProssimeGiornate (SPOSTATA QUI)
     * Include il pulsante "Prestazioni" (pubblico) e RIMUOVE "Valuta" (admin)
     * Layout pulsanti pubblici corretto (singola riga)
     */
    window.loadProssimeGiornate = async function(asAdmin){
      const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
      const ul = byId(listId); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'calendario'));
      const val = snap.val() || {};
      let entries = Object.entries(val);
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      const today = new Date(); today.setHours(0,0,0,0);
      entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
      if(!entries.length){ ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; return; }
      ul.className='grid cols-3';
      for(const [matchId,m] of entries){
        const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
        const cand = candSnap.val() || {};
        const candCount = Object.values(cand).filter(Boolean).length;
        const isPublished = m.formazionePubblicata === true;
        const matchDate = toDate(m.data);
        const isPast = matchDate < today;

        // Candidatura
        let candButton = '';
        if (isPast) {
          candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`;
        } else {
          candButton = `<button class="btn btn--accent" onclick="candidati('${matchId}')">Candidatura</button>`;
        }

        // Prestazioni: sempre mostrato. Attivo solo se partita passata con risultato valido.
        let prestazioniBtn = '';
        const risultatoValido = (m.risultato && m.risultato !== 'N/D');
        if (isPast && risultatoValido) {
          // Passa anche il nome avversaria alla funzione
          prestazioniBtn = `<button class="btn" onclick="showPrestazioniPubbliche('${matchId}','${escapeHtml(m.avversaria || 'Avversario')}')">Prestazioni</button>`;
        } else if (isPast && !risultatoValido) {
           prestazioniBtn = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Risultato Manca</button>`;
        } else {
           prestazioniBtn = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Non Giocata</button>`;
        }

        // Formazione
        let formazioneBtn = '';
        if (isPublished) {
          formazioneBtn = `<button class="btn" onclick="showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria || 'Avversario')}')">Formazione</button>`;
        } else if (isPast) {
          formazioneBtn = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Formazione Manca</button>`;
        } else {
          formazioneBtn = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Non Pubblicata</button>`;
        }
        
        // Admin Actions
        let adminButtons = '';
        if(asAdmin){
          const adminPrestazioniBtn = risultatoValido ? `<button class="btn btn--admin" onclick="showValutazionePartitaForm('${matchId}','${escapeHtml(m.avversaria || 'Avversario')}')">Valuta</button>` : `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Valuta (Risultato N/D)</button>`;
          const adminRisultatoBtn = isPast ? `<button class="btn btn--admin" onclick="showRisultatoForm('${matchId}','${escapeHtml(m.avversaria || 'Avversario')}')">Risultato</button>` : `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Risultato (Attesa)</button>`;
          const adminFormazioneBtn = !isPast ? `<button class="btn btn--admin" onclick="showFormazioneForm('${matchId}','${escapeHtml(m.avversaria || 'Avversario')}')">Formazione</button>` : `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Formazione (Scaduta)</button>`;
          const adminCandidatureBtn = `<button class="btn btn--admin" onclick="showCandidatureForm('${matchId}')">Candidature (${candCount})</button>`;
          const adminDeleteBtn = `<button class="btn" style="background:#dc3545; color:#fff" onclick="deleteMatch('${matchId}')">Elimina</button>`;
          
          adminButtons = `
            <div class="row" style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px;">
              ${adminRisultatoBtn}
              ${adminFormazioneBtn}
              ${adminPrestazioniBtn}
              ${adminCandidatureBtn}
              ${adminDeleteBtn}
            </div>
          `;
        }

        let resultText = risultatoValido ? `Risultato: <b>${m.risultato}</b>` : 'Risultato: N/D';
        const candInfo = asAdmin ? `Candidati: <b>${candCount}</b>` : '';

        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div>
            <div class="player-title">vs ${escapeHtml(m.avversaria)}</div>
            <div class="player-sub">
              ${escapeHtml(m.data)} ${escapeHtml(m.orario)} (${m.casa ? 'Casa' : 'Trasferta'})
              <br>
              Campo: <b>${escapeHtml(m.campo || '?')}</b>
              <br>
              ${resultText} ${candInfo}
            </div>
          </div>
          <div class="row" style="margin-top:10px; justify-content:flex-start;">
             ${prestazioniBtn}
             ${formazioneBtn}
             ${candButton}
          </div>
          ${adminButtons}`;
        ul.appendChild(li);
      }
    };
    
    // Funzione per candidarsi alla partita (pre-esistente)
    window.candidati = async(matchId)=>{ 
      const user = auth.currentUser; 
      if(!user){ 
        showLogin(); 
        alert('Per candidarti devi effettuare il login.'); 
        return; 
      } 
      await set(ref(db,`calendario/${matchId}/candidature/${user.uid}`), true); 
      alert('Disponibilità inviata.'); 
      window.loadProssimeGiornate(false); 
    };

    /**
     * Helper per determinare l'esito della partita e la classe CSS.
     * Estrae i dati dal risultato della partita letto dal nodo Firebase.
     */
    function getMatchOutcome(risultato) {
        if (!risultato || risultato === 'N/D') return { esito: 'N/D', classe: 'esito-nd' };
        // Assumendo il formato "nostri-loro" (es. "3-1")
        const [golNoi, golLoro] = risultato.split('-').map(n => parseInt(n.trim(), 10));

        if (isNaN(golNoi) || isNaN(golLoro)) return { esito: 'N/D', classe: 'esito-nd' };

        let esito;
        let classe;

        if (golNoi > golLoro) {
            esito = 'Vittoria';
            classe = 'esito-vittoria';
        } else if (golNoi < golLoro) {
            esito = 'Sconfitta';
            classe = 'esito-sconfitta';
        } else {
            esito = 'Pareggio';
            classe = 'esito-pareggio';
        }

        return { esito, classe };
    }


    /**
     * FUNZIONE loadStatistiche (MODIFICATA)
     * 1. Ordina dalla più recente alla più vecchia.
     * 2. Inserisce l'esito (Vittoria/Sconfitta/Pareggio) con colori e bordi.
     */
    async function loadStatistiche(){
        const rl = byId('statistiche-risultati-list'); if(rl){ rl.innerHTML=''; }
        // 1. Estrae i dati dal nodo 'calendario' di Firebase
        const snapCal = await get(ref(db,'calendario')); const cal = snapCal.val()||{};
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };

        // Ordina dalla più recente alla più vecchia
        const rows = Object.entries(cal)
            .sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));

        if(rl){ 
            const partiteConcluse = rows.filter(([k,m]) => m.risultato && m.risultato !== 'N/D');

            if(!partiteConcluse.length) {
                rl.innerHTML = '<div class="help">Ancora nessun risultato.</div>'; 
                return;
            }

            let finalHtml = '';

            partiteConcluse.forEach(([k, m]) => {
                const data = escapeHtml(m.data || '?');
                const orario = escapeHtml(m.orario || '?');
                const campo = m.campo ? escapeHtml(m.campo) : '?';
                const avversario = m.avversaria ? escapeHtml(m.avversaria) : 'Avversario sconosciuto';
                const risultato = escapeHtml(m.risultato || 'N/D');
                const candidaturaCount = Object.values(m.candidature || {}).filter(Boolean).length;
                
                // 2. Calcola esito e classe usando il risultato del nodo Firebase
                const { esito, classe } = getMatchOutcome(m.risultato);

                finalHtml += `
                    <li class="card risultato-card ${classe}" style="margin-bottom: 12px; padding: 14px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <div style="flex: 1 1 50%;">
                                <strong style="font-size: 1.1rem;">vs ${avversario}</strong>
                                <div class="player-sub">
                                    Data: <b>${data}</b> | Campo: <b>${campo}</b> | Orario: <b>${orario}</b>
                                </div>
                            </div>
                            <div style="text-align: right; flex: 0 0 auto;">
                                <div style="font-size: 1.2rem; font-weight: 800; line-height: 1;">${risultato}</div>
                                <div class="pill" style="margin-top: 4px; font-size: 0.75rem; background: var(--card); color: var(--ink); box-shadow: 0 0 0 1px var(--line);">${esito}</div>
                            </div>
                        </div>
                        <div class="help" style="margin-top: 8px; border-top: 1px solid var(--line); padding-top: 8px;">
                            Candidature: <b>${candidaturaCount}</b>
                        </div>
                    </li>
                `;
            });
            
            rl.innerHTML = finalHtml;
        }
    }


    /* FUNZIONI PRESTAZIONI AGGREGATE E PARTITA (rimaste invariate) */
    
    // La funzione loadPrestazioniAggregato e showPrestazioniPubbliche non sono state modificate ma sono mantenute in contesto.
    
    window.loadPrestazioniAggregato = async function(){
      const aggrContent = byId('prestazioni-aggregate-content');
      if (!aggrContent) return;
      aggrContent.querySelector('.help').textContent = 'Caricamento...';
      try {
        const snapCal = await get(ref(db, 'calendario'));
        const calendario = snapCal.val() || {};
        const snapRosa = await get(ref(db, 'rosa'));
        const rosa = snapRosa.val() || {};

        let giocatoriStat = {};

        // Inizializza le statistiche per tutti i giocatori
        Object.entries(rosa).forEach(([id, g]) => {
          giocatoriStat[id] = {
            nome: g.nome,
            cognome: g.cognome,
            numero: g.numero,
            totaleVoti: 0,
            conteggioVoti: 0,
            goal: 0,
            presenze: g.presenze || 0,
            ruolo: g.ruolo
          };
        });

        // Aggrega i dati delle partite
        Object.values(calendario).forEach(match => {
          if (match.valutazioni) {
            Object.entries(match.valutazioni).forEach(([playerId, dati]) => {
              if (giocatoriStat[playerId]) {
                // Voto
                if (dati.voto > 0) {
                  giocatoriStat[playerId].totaleVoti += dati.voto;
                  giocatoriStat[playerId].conteggioVoti += 1;
                }
                // Goal
                giocatoriStat[playerId].goal += dati.goal || 0;
              }
            });
          }
        });

        // Calcola medie e prepara l'HTML
        let html = `
          <h3>Riepilogo Giocatori</h3>
          <div class="help">Calcolo basato sui voti e i goal registrati nelle partite concluse.</div>
          <table class="table" style="margin-top: 12px;">
            <thead>
              <tr>
                <th>#</th>
                <th>Nome</th>
                <th>Ruolo</th>
                <th>Media Voto (Partite Votate)</th>
                <th>Goal Totali</th>
                <th>Presenze</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        const sortedStats = Object.values(giocatoriStat).sort((a, b) => b.mediaVoto - a.mediaVoto);

        sortedStats.forEach(stat => {
          const mediaVoto = stat.conteggioVoti > 0 ? (stat.totaleVoti / stat.conteggioVoti).toFixed(2) : 'N/D';
          const mediaPillClass = mediaVoto === 'N/D' ? 'yellow' : (parseFloat(mediaVoto) >= 7.5 ? 'green' : (parseFloat(mediaVoto) >= 6.5 ? 'yellow' : 'red'));
          const mediaVotoPercent = mediaVoto !== 'N/D' ? ((parseFloat(mediaVoto) / 10) * 100).toFixed(2) + '%' : '0%';

          html += `
            <tr>
              <td><span class="pill">#${stat.numero}</span></td>
              <td style="font-weight:700">${stat.nome} ${stat.cognome}</td>
              <td class="player-sub">${stat.ruolo}</td>
              <td>
                <div style="font-weight:700">${mediaVoto} <span class="player-sub">(${stat.conteggioVoti} voti)</span></div>
                <div class="voto-bar-container"><div class="voto-bar ${mediaPillClass}" style="width:${mediaVotoPercent}"></div></div>
              </td>
              <td style="font-weight:700">${stat.goal}</td>
              <td style="font-weight:700">${stat.presenze}</td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        aggrContent.innerHTML = html;

      } catch (e) {
        console.error("Errore aggregazione prestazioni:", e);
        aggrContent.innerHTML = `<div class="help" style="color:red">Errore durante l'aggregazione dei dati.</div>`;
      }
    };
    
    window.showPrestazioniPubbliche = async function(matchId, avv) {
      const content = byId('prestazioni-partita-content');
      if (!content) return;
      
      window.showPublicSection('prestazioni-partita-section');
      content.innerHTML = `<h2>Prestazioni vs ${avv}</h2><div class="help">Caricamento dettagli partita...</div>`;

      try {
        const snapMatch = await get(ref(db, `calendario/${matchId}`));
        const match = snapMatch.val();
        if (!match || !match.valutazioni) {
          content.innerHTML = `<h2>Prestazioni vs ${avv}</h2><div class="help">Nessun dato prestazione disponibile per questa partita.</div>`;
          return;
        }

        const snapRosa = await get(ref(db, 'rosa'));
        const rosa = snapRosa.val() || {};

        let html = `<table class="table"><thead><tr><th>Giocatore</th><th>Ruolo</th><th>Voto</th><th>Goal</th></tr></thead><tbody>`;

        const valutazioniSorted = Object.entries(match.valutazioni)
          .map(([id, dati]) => ({ id, ...dati, ...rosa[id] }))
          .filter(d => d.nome) // Filtra solo i giocatori ancora in rosa (o ignora i dati orfani)
          .sort((a, b) => (b.voto || 0) - (a.voto || 0)); // Ordina per voto

        valutazioniSorted.forEach(d => {
          const voto = d.voto > 0 ? d.voto.toFixed(1) : 'N/D';
          const goal = d.goal || 0;
          const mediaPillClass = voto === 'N/D' ? 'yellow' : (parseFloat(voto) >= 7.5 ? 'green' : (parseFloat(voto) >= 6.5 ? 'yellow' : 'red'));
          const mediaVotoPercent = voto !== 'N/D' ? ((parseFloat(voto) / 10) * 100).toFixed(2) + '%' : '0%';

          html += `
            <tr>
              <td><span style="font-weight:700">${d.nome} ${d.cognome}</span> <span class="pill">#${d.numero}</span></td>
              <td class="player-sub">${d.ruolo}</td>
              <td>
                <div style="font-weight:700">${voto}</div>
                <div class="voto-bar-container"><div class="voto-bar ${mediaPillClass}" style="width:${mediaVotoPercent}"></div></div>
              </td>
              <td style="font-weight:700">${goal}</td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        content.innerHTML = `
          <h2>Prestazioni vs ${avv} (${match.risultato})</h2>
          <div class="help">Dettagli voto e goal registrati.</div>
          ${html}
        `;

      } catch (e) {
        console.error("Errore caricamento prestazioni partita:", e);
        content.innerHTML = `<h2>Prestazioni vs ${avv}</h2><div class="help" style="color:red">Errore durante il caricamento dei dati prestazione.</div>`;
      }
    };


    /* Posizioni modulo 3-3-1 */
    const POS_331 = { 'Portiere': { top:'90%', left:'50%' }, 'Difensore centrale': { top:'70%', left:'50%' }, 'Terzino sinistro': { top:'70%', left:'25%' }, 'Terzino destro': { top:'70%', left:'75%' }, 'Centrocampista centrale': { top:'45%', left:'50%' }, 'Centrocampista sinistro': { top:'45%', left:'25%' }, 'Centrocampista destro': { top:'45%', left:'75%' }, 'Attaccante centrale': { top:'15%', left:'50%' }};

    // Altre funzioni admin (invariate)
    window.showFormazionePubblica = async (matchId, avv) => {
      const content = byId('formazione-pubblica-content');
      if (!content) return;
      window.showPublicSection('formazione-pubblica-section');
      content.innerHTML = `<h2>Formazione vs ${avv}</h2><div class="help">Caricamento formazione...</div>`;

      try {
        const snapMatch = await get(ref(db, `calendario/${matchId}`));
        const match = snapMatch.val();
        if (!match || !match.formazione || !match.formazionePubblicata) {
          content.innerHTML = `<h2>Formazione vs ${avv}</h2><div class="help">Formazione non ancora pubblicata.</div>`;
          return;
        }
        
        const snapRosa = await get(ref(db, 'rosa'));
        const rosa = snapRosa.val() || {};

        const getPlayerDetails = (id) => rosa[id] ? `${rosa[id].nome} ${rosa[id].cognome} (#${rosa[id].numero})` : 'Giocatore Sconosciuto';
        const getPlayerRole = (id) => rosa[id] ? rosa[id].ruolo : 'N/D';

        let titolariHTML = '';
        const panchinaList = match.formazione.panchina ? Object.keys(match.formazione.panchina) : [];
        let panchinaHTML = 'Nessuna riserva.';
        let campoHTML = '';

        if (match.formazione.titolari) {
          titolariHTML = Object.keys(match.formazione.titolari).map(id => 
             `<li>${getPlayerDetails(id)} - ${getPlayerRole(id)}</li>`
          ).join('');
          
          campoHTML = `
            <div class="field">
              <div class="marker" style="top:5%; left:50%; background:#DA0000; color:#fff; border-color:#fff;">AC TUSCOLANO</div>
              <div class="marker" style="top:5%; left:5%; background:#fff; color:#111; border-color:#fff;">vs ${avv}</div>
          `;
          
          Object.keys(match.formazione.titolari).forEach(id => {
            const dettagli = rosa[id];
            if (dettagli && POS_331[dettagli.ruolo]) {
              const pos = POS_331[dettagli.ruolo];
              campoHTML += `<div class="marker" style="top:${pos.top}; left:${pos.left};">${dettagli.nome.charAt(0)}.${dettagli.cognome} (#${dettagli.numero})</div>`;
            }
          });
          campoHTML += `</div>`;
        } else {
            titolariHTML = 'Nessun titolare selezionato.';
        }
        
        if (panchinaList.length > 0) {
            panchinaHTML = panchinaList.map(id => `<li>${getPlayerDetails(id)}</li>`).join('');
        }
        
        let sostituzioniHTML = 'Nessuna sostituzione registrata.';
        if (match.formazione.sostituzioni) {
            sostituzioniHTML = Object.values(match.formazione.sostituzioni).map(s => 
               `<li>${getPlayerDetails(s.out)} Sostituito da ${getPlayerDetails(s.in)} al ${s.minuto}'</li>`
            ).join('');
        }


        content.innerHTML = `
          <h2>Formazione Ufficiale vs ${avv}</h2>
          ${campoHTML}
          
          <div class="grid cols-2" style="margin-top:14px">
            <div>
              <h3>Titolari</h3>
              <ul style="list-style:disc; margin-left:20px;">${titolariHTML}</ul>
            </div>
            <div>
              <h3>Panchina</h3>
              <ul style="list-style:disc; margin-left:20px;">${panchinaHTML}</ul>
            </div>
          </div>
          
          <h3>Sostituzioni</h3>
          <ul style="list-style:disc; margin-left:20px;">${sostituzioniHTML}</ul>
          
          <div class="help" style="margin-top:14px">Formazione pubblicata il ${match.formazioneDataPubblicazione}</div>
        `;

      } catch (e) {
        console.error("Errore caricamento formazione:", e);
        content.innerHTML = `<h2>Formazione vs ${avv}</h2><div class="help" style="color:red">Errore durante il caricamento della formazione.</div>`;
      }
    };
    
    // ... (restanti funzioni admin CRUD e form)
    
    window.addPlayer = async (e)=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const newPlayer = {
            nome: v('giocatore-nome'),
            cognome: v('giocatore-cognome'),
            numero: parseInt(v('giocatore-numero')),
            ruolo: v('giocatore-ruolo'),
            stato: v('giocatore-titolare'),
            presenze: 0
        };
        try{
            await push(ref(db,'rosa'), newPlayer);
            alert('Giocatore aggiunto!');
            e.target.reset();
            loadRosa();
        }catch(err){ alert('Errore: '+err.message); }
    };

    window.addMatch = async (e)=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const newMatch = {
            avversaria: v('match-avversaria'),
            data: v('match-data'),
            orario: v('match-orario'),
            campo: v('match-campo'),
            casa: v('match-casa') === 'true',
            risultato: 'N/D',
            formazionePubblicata: false,
            linkVideo: ''
        };
        try{
            await push(ref(db,'calendario'), newMatch);
            alert('Partita aggiunta!');
            e.target.reset();
            window.loadProssimeGiornate(true);
        }catch(err){ alert('Errore: '+err.message); }
    };

    window.deleteMatch = async (matchId)=>{
        if(!isAdmin || !confirm('Sei sicuro di voler eliminare questa partita?')) return;
        try{
            await remove(ref(db,`calendario/${matchId}`));
            alert('Partita eliminata!');
            window.loadProssimeGiornate(true);
        }catch(err){ alert('Errore: '+err.message); }
    };
    
    window.showRisultatoForm = async (matchId, avv) => {
        if (!isAdmin) return;
        window.showAdminSection('admin-statistiche-section');
        const content = byId('risultato-content');
        
        const snap = await get(ref(db, `calendario/${matchId}`));
        const match = snap.val() || {};
        const [golNoi = '', golLoro = ''] = (match.risultato && match.risultato !== 'N/D') ? match.risultato.split('-') : ['', ''];

        content.innerHTML = `
            <h2>Admin · Risultato Partita vs ${escapeHtml(avv)}</h2>
            <form id="risultato-form" onsubmit="saveRisultato(event, '${matchId}')">
                <label>Goal AC Tuscolano</label>
                <input id="risultato-noi" type="number" min="0" value="${golNoi.trim()}" required />
                <label>Goal Avversaria</label>
                <input id="risultato-loro" type="number" min="0" value="${golLoro.trim()}" required />
                <div class="actions">
                    <button class="btn btn--admin" type="submit">Salva Risultato</button>
                    <button class="btn" type="button" onclick="showAdminSection('admin-calendario-section')">Annulla</button>
                </div>
            </form>
        `;
    };

    window.saveRisultato = async (e, matchId) => {
        e.preventDefault();
        if (!isAdmin) return;
        const golNoi = parseInt(v('risultato-noi'), 10);
        const golLoro = parseInt(v('risultato-loro'), 10);

        if (isNaN(golNoi) || isNaN(golLoro)) return alert("Inserisci numeri validi.");
        
        const risultato = `${golNoi}-${golLoro}`;
        try {
            await update(ref(db, `calendario/${matchId}`), { risultato: risultato });
            alert('Risultato salvato!');
            showAdminSection('admin-calendario-section');
        } catch (err) {
            alert('Errore salvataggio: ' + err.message);
        }
    };
    
    window.showFormazioneForm = async (matchId,avv)=>{
      if (!isAdmin) return;
      window.showAdminSection('admin-formazione-section');
      const content = byId('formazione-content');
      content.innerHTML = `<h2>Formazione vs ${avv}</h2><div class="help">Caricamento...</div>`;
      
      const [snapRosa, snapMatch] = await Promise.all([
          get(ref(db, 'rosa')),
          get(ref(db, `calendario/${matchId}`))
      ]);
      const rosa = snapRosa.val() || {};
      const match = snapMatch.val() || {};
      const giocatori = Object.entries(rosa).map(([id, g]) => ({ id, ...g })).sort((a, b) => (a.numero || 0) - (b.numero || 0));
      const currentFormazione = match.formazione || {};
      const titolari = currentFormazione.titolari ? Object.keys(currentFormazione.titolari) : [];
      const panchina = currentFormazione.panchina ? Object.keys(currentFormazione.panchina) : [];
      const sostituzioni = Object.values(currentFormazione.sostituzioni || {});
      const isPubblicata = match.formazionePubblicata;
      
      let giocatoriOptions = '';
      giocatori.forEach(g => {
        const isTitolare = titolari.includes(g.id);
        const isPanchina = panchina.includes(g.id);
        const status = isTitolare ? ' (Titolare)' : (isPanchina ? ' (Panchina)' : '');
        giocatoriOptions += `<option value="${g.id}" ${isTitolare ? 'data-titolare="true"' : ''} ${isPanchina ? 'data-panchina="true"' : ''}>#${g.numero} ${g.nome} ${g.cognome} (${g.ruolo}) ${status}</option>`;
      });

      let titolariList = titolari.map(id => {
        const g = rosa[id];
        return g ? `<li data-id="${id}" data-ruolo="${g.ruolo}" class="card row" style="justify-content:space-between; margin-bottom:4px">#${g.numero} ${g.nome} ${g.cognome} (${g.ruolo}) <button class="btn" style="padding:4px 8px; font-size:0.8rem" onclick="movePlayer('${id}', 'titolari', 'panchina')">Panchina</button></li>` : '';
      }).join('');
      let panchinaList = panchina.map(id => {
        const g = rosa[id];
        return g ? `<li data-id="${id}" data-ruolo="${g.ruolo}" class="card row" style="justify-content:space-between; margin-bottom:4px">#${g.numero} ${g.nome} ${g.cognome} <button class="btn btn--accent" style="padding:4px 8px; font-size:0.8rem" onclick="movePlayer('${id}', 'panchina', 'titolari')">Titolare</button></li>` : '';
      }).join('');

      // Sostituzioni esistenti
      let sostituzioniHTML = sostituzioni.map((s, index) => {
        const outPlayer = rosa[s.out];
        const inPlayer = rosa[s.in];
        return `
          <li data-index="${index}" class="card row" style="justify-content:space-between; margin-bottom:4px; font-size:0.9rem">
            ${outPlayer.cognome} sostituito da ${inPlayer.cognome} al ${s.minuto}'
            <button class="btn" style="background:#dc3545; color:#fff; padding:4px 8px; font-size:0.8rem" onclick="deleteSostituzione('${matchId}', ${index})">Elimina</button>
          </li>
        `;
      }).join('');

      content.innerHTML = `
        <h2>Admin · Formazione vs ${avv}</h2>
        
        <form id="formazione-editor" onsubmit="saveFormation(event, '${matchId}', '${escapeHtml(avv)}')">
            <div class="grid cols-2">
                <div>
                    <h3>Titolari (Max 8)</h3>
                    <ul id="titolari-list" style="min-height:100px; border:1px solid var(--line); border-radius:12px; padding:8px">${titolariList || '<div class="help">Trascina qui i titolari.</div>'}</ul>
                </div>
                <div>
                    <h3>Panchina</h3>
                    <ul id="panchina-list" style="min-height:100px; border:1px solid var(--line); border-radius:12px; padding:8px">${panchinaList || '<div class="help">Trascina qui le riserve.</div>'}</ul>
                </div>
            </div>
            
            <label for="giocatore-drag">Giocatori disponibili:</label>
            <select id="giocatore-drag" multiple size="10" style="max-width:100%; height:200px">
                ${giocatoriOptions}
            </select>
            <div class="help">Trascina (o usa i pulsanti) per spostare i giocatori tra Titolari e Panchina.</div>

            <h3 style="margin-top:20px">Gestione Sostituzioni</h3>
            <form id="sostituzione-form" onsubmit="addSostituzione(event, '${matchId}')">
              <div class="grid cols-3" style="grid-template-columns:1fr 1fr 100px; gap:8px">
                  <div><label>Esce:</label><select id="sostituzione-out" required>${giocatoriOptions}</select></div>
                  <div><label>Entra:</label><select id="sostituzione-in" required>${giocatoriOptions}</select></div>
                  <div><label>Minuto:</label><input id="sostituzione-minuto" type="number" min="1" max="90" required /></div>
              </div>
              <div class="actions" style="margin-top:10px"><button class="btn btn--admin" type="submit">Aggiungi Sostituzione</button></div>
            </form>
            
            <h4 style="margin-top:14px">Sostituzioni Registrate</h4>
            <ul id="sostituzioni-list">${sostituzioniHTML || '<div class="help">Nessuna sostituzione ancora.</div>'}</ul>

            <label style="margin-top:20px">
                <input type="checkbox" id="formazione-pubblicata" ${isPubblicata ? 'checked' : ''} style="width:auto; max-width:none" /> 
                Pubblica la formazione (Rendila visibile a tutti)
            </label>

            <div class="actions">
                <button class="btn btn--admin" type="submit">Salva Formazione & Sostituzioni</button>
                <button class="btn" type="button" onclick="showAdminSection('admin-calendario-section')">Annulla</button>
            </div>
        </form>
      `;
      // Inizializza jQuery UI Sortable/Draggable
      $("#titolari-list, #panchina-list").sortable({ connectWith: ".connected-sortable" }).disableSelection();
      $("#giocatore-drag option").draggable({ 
          connectToSortable: "#titolari-list, #panchina-list", 
          helper: "clone",
          revert: "invalid",
          start: function(event, ui) {
             ui.helper.data('id', $(this).val());
             ui.helper.data('ruolo', $(this).data('ruolo'));
          }
      });
      $("#titolari-list, #panchina-list").on("sortreceive", function(event, ui) {
          const id = ui.item.data('id');
          const ruolo = ui.item.data('ruolo');
          const listId = $(this).attr('id');
          movePlayer(id, listId === 'titolari-list' ? 'panchina' : 'titolari', listId === 'titolari-list' ? 'titolari' : 'panchina', ui.item);
      });
      // Rimuovi l'elemento clone creato da jQuery UI dopo l'aggiunta
      $("#titolari-list, #panchina-list").on("sortstop", function(event, ui) {
          if (ui.item.is('option')) {
              ui.item.remove();
          }
      });
      // La logica di movePlayer gestisce già l'HTML nel list
    };

    window.movePlayer = (id, fromList, toList, listItem) => {
        const g = rosa[id];
        if (!g) return;

        const targetListId = `${toList}-list`;
        const sourceListId = `${fromList}-list`;
        const $targetList = $(`#${targetListId}`);
        const $sourceList = $(`#${sourceListId}`);
        const maxTitolari = 8;
        
        let $item = listItem || $(`#${sourceListId} li[data-id="${id}"]`);
        
        if (toList === 'titolari' && $targetList.children('li').length >= maxTitolari && !$item.parent().is($targetList)) {
            alert(`Non puoi avere più di ${maxTitolari} titolari.`);
            return false; // Blocca lo spostamento
        }
        
        if ($item.length) {
            // Se l'elemento esiste già (spostamento da lista a lista)
            $item.remove();
        }
        
        let newButtonHtml;
        let newListItemHtml;

        if (toList === 'titolari') {
            newButtonHtml = `<button class="btn" style="padding:4px 8px; font-size:0.8rem" onclick="movePlayer('${id}', 'titolari', 'panchina')">Panchina</button>`;
            newListItemHtml = `<li data-id="${id}" data-ruolo="${g.ruolo}" class="card row" style="justify-content:space-between; margin-bottom:4px">#${g.numero} ${g.nome} ${g.cognome} (${g.ruolo}) ${newButtonHtml}</li>`;
        } else { // toList === 'panchina'
            newButtonHtml = `<button class="btn btn--accent" style="padding:4px 8px; font-size:0.8rem" onclick="movePlayer('${id}', 'panchina', 'titolari')">Titolare</button>`;
            newListItemHtml = `<li data-id="${id}" data-ruolo="${g.ruolo}" class="card row" style="justify-content:space-between; margin-bottom:4px">#${g.numero} ${g.nome} ${g.cognome} ${newButtonHtml}</li>`;
        }
        
        $targetList.append(newListItemHtml);
        
        // Rimuovi i messaggi "help" se la lista è piena
        $(`#titolari-list, #panchina-list`).each(function() {
            if ($(this).children('li').length > 0) {
                $(this).children('.help').remove();
            }
        });
        
        return true;
    };
    
    window.addSostituzione = async (e, matchId) => {
      e.preventDefault();
      if (!isAdmin) return;
      
      const outId = v('sostituzione-out');
      const inId = v('sostituzione-in');
      const minuto = parseInt(v('sostituzione-minuto'), 10);
      
      if (outId === inId) return alert("Il giocatore in uscita non può essere lo stesso di quello in entrata.");
      if (isNaN(minuto) || minuto < 1 || minuto > 90) return alert("Inserisci un minuto valido (1-90).");
      
      // Carica il match corrente
      const snapMatch = await get(ref(db, `calendario/${matchId}`));
      const match = snapMatch.val() || {};
      const sostituzioniArray = Object.values(match.formazione?.sostituzioni || {});
      const nextIndex = sostituzioniArray.length; // Usa l'indice successivo come key
      
      const newSostituzione = {
        out: outId,
        in: inId,
        minuto: minuto
      };
      
      try {
        const updates = {};
        updates[`/calendario/${matchId}/formazione/sostituzioni/${nextIndex}`] = newSostituzione;
        await update(ref(db), updates);
        
        alert('Sostituzione aggiunta! Salva la formazione per rendere permanente l\'aggiornamento.');
        
        // Ricarica solo il componente sostituzioni se possibile o l'intero form
        showFormazioneForm(matchId, match.avversaria); // Ricarica l'intero form per aggiornare la lista
      } catch (err) {
        alert('Errore aggiunta sostituzione: ' + err.message);
      }
    };
    
    window.deleteSostituzione = async (matchId, index) => {
        if (!isAdmin || !confirm('Sei sicuro di voler eliminare questa sostituzione?')) return;
        
        try {
            await remove(ref(db, `/calendario/${matchId}/formazione/sostituzioni/${index}`));
            
            // Riordina gli indici per evitare buchi (opzionale ma consigliato)
            const snapMatch = await get(ref(db, `calendario/${matchId}/formazione/sostituzioni`));
            const sostituzioniObj = snapMatch.val() || {};
            const sostituzioniArray = Object.values(sostituzioniObj);
            
            // Crea un nuovo oggetto con indici consecutivi
            let newSostituzioni = {};
            sostituzioniArray.filter((s, i) => i !== index).forEach((s, newIndex) => {
                newSostituzioni[newIndex] = s;
            });
            
            const updates = {};
            updates[`/calendario/${matchId}/formazione/sostituzioni`] = newSostituzioni;
            await update(ref(db), updates);

            alert('Sostituzione eliminata e indici riordinati. Salva la formazione per rendere permanente l\'aggiornamento.');
            
            // Ricarica l'intero form
            const snapMatchAfter = await get(ref(db, `calendario/${matchId}`));
            showFormazioneForm(matchId, snapMatchAfter.val().avversaria);

        } catch (err) {
            alert('Errore eliminazione sostituzione: ' + err.message);
        }
    };


    window.saveFormation = async (e,matchId,avv)=>{
        e.preventDefault();
        if(!isAdmin) return;
        
        const titolari = {};
        $('#titolari-list li').each(function() {
            const id = $(this).data('id');
            const ruolo = $(this).data('ruolo');
            if (id) titolari[id] = { ruolo: ruolo };
        });

        const panchina = {};
        $('#panchina-list li').each(function() {
            const id = $(this).data('id');
            if (id) panchina[id] = true;
        });
        
        if (Object.keys(titolari).length === 0) return alert("Seleziona almeno un titolare.");
        
        const isPubblicata = byId('formazione-pubblicata').checked;

        try {
            // Aggiorna le presenze (solo se è la prima pubblicazione o il numero di titolari è cambiato)
            const snapMatch = await get(ref(db, `calendario/${matchId}`));
            const match = snapMatch.val() || {};
            const oldTitolariCount = match.formazione?.titolari ? Object.keys(match.formazione.titolari).length : 0;
            const newTitolariCount = Object.keys(titolari).length;
            
            // Se la formazione non era pubblicata e ora lo è, incrementa le presenze per i titolari
            if (!match.formazionePubblicata && isPubblicata) {
               // Aggiorna presenze solo per i titolari attuali
               await incrementPresenzeInRosa(new Set(Object.keys(titolari)));
            } 
            // In un sistema più complesso si dovrebbe gestire il decremento se i titolari cambiano e la formazione è già stata pubblicata.

            const updates = {};
            updates[`/calendario/${matchId}/formazione/titolari`] = titolari;
            updates[`/calendario/${matchId}/formazione/panchina`] = panchina;
            updates[`/calendario/${matchId}/formazione/modulo`] = '3-3-1'; // Modulo fisso
            updates[`/calendario/${matchId}/formazionePubblicata`] = isPubblicata;
            updates[`/calendario/${matchId}/formazioneDataPubblicazione`] = new Date().toLocaleString("it-IT");
            
            // Nota: Le sostituzioni sono già salvate in tempo reale da addSostituzione.
            
            await update(ref(db), updates);
            
            alert('Formazione salvata e aggiornata!');
            window.showAdminSection('admin-calendario-section');

        } catch (err) {
            alert('Errore salvataggio formazione: ' + err.message);
        }
    };
    
    async function incrementPresenzeInRosa(playerIdsSet){
        const updates = {};
        playerIdsSet.forEach(id => {
            // Usa una transazione per incrementare se necessario in un contesto multi-utente, ma qui semplifichiamo
            updates[`/rosa/${id}/presenze`] = firebase.database.ServerValue.increment(1); // Questo richiede firebase.database.ServerValue, usiamo un approccio base

            // Approccio base v9 (meno sicuro per concorrenza ma più semplice)
            get(ref(db, `rosa/${id}/presenze`)).then(snap => {
                const currentPresenze = snap.val() || 0;
                update(ref(db, `rosa/${id}`), { presenze: currentPresenze + 1 });
            }).catch(e => console.error("Errore incremento presenze:", e));
        });
    }

    async function loadCandidature(){
        const ul = byId('candidature-list'); if(!ul) return; ul.innerHTML='';
        const snap = await get(ref(db,'calendario'));
        const cal = snap.val() || {};
        const snapUtenti = await get(ref(db,'utenti'));
        const utenti = snapUtenti.val() || {};
        
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        const entries = Object.entries(cal).sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));

        if(!entries.length){ ul.innerHTML = '<div class="help">Nessuna partita.</div>'; return; }

        let html = '';
        entries.forEach(([matchId,m])=>{
            const cand = m.candidature || {};
            const candList = Object.entries(cand).filter(([,val])=>val===true);
            const candNames = candList.map(([uid]) => {
                const u = utenti[uid];
                return u ? `${u.nome} ${u.cognome}` : `Utente Sconosciuto (${uid.substring(0,4)}...)`;
            }).join(', ');
            
            html += `
              <li class="card">
                <div class="player-title">vs ${escapeHtml(m.avversaria)} (${m.data})</div>
                <div class="player-sub">Candidati (${candList.length}):</div>
                <div class="help">${candNames || 'Nessuno ha dato disponibilità.'}</div>
                <div class="row" style="margin-top:8px">
                  <button class="btn btn--admin" onclick="showCandidatureForm('${matchId}','${escapeHtml(m.avversaria)}')">Modifica Candidature</button>
                </div>
              </li>
            `;
        });
        ul.innerHTML = html;
    }
    
    // Funzione reindirizzata per coerenza con l'interfaccia
    window.showCandidatureForm = (matchId, avv) => {
        window.loadCandidatureEditor(matchId, avv);
    };

    window.loadCandidatureEditor = async (matchId, avv) => {
      if (!isAdmin) return;
      
      const panel = byId('crud-candidature-panel');
      panel.style.display = 'flex';
      
      // Carica i dati necessari
      const [snapRosa, snapMatch] = await Promise.all([
          get(ref(db, 'rosa')),
          get(ref(db, `calendario/${matchId}`))
      ]);
      const rosa = snapRosa.val() || {};
      const match = snapMatch.val() || {};
      const candidati = match.candidature || {};
      
      // Prepara i dati del giocatore (giocatoreId -> uid associato)
      let playerUidMap = {};
      const snapUtenti = await get(ref(db, 'utenti'));
      const utenti = snapUtenti.val() || {};
      
      Object.entries(utenti).forEach(([uid, u]) => {
          // Cerca il giocatore corrispondente per nome e cognome
          const playerId = Object.keys(rosa).find(id => rosa[id].nome === u.nome && rosa[id].cognome === u.cognome);
          if (playerId) {
              playerUidMap[playerId] = uid;
          }
      });

      // Costruisce la tabella
      const tbody = byId('crud-candidature-body');
      byId('crud-candidature-match-name').textContent = avv;
      tbody.innerHTML = '';
      
      const giocatori = Object.entries(rosa).map(([id, g]) => ({ id, ...g })).sort((a, b) => (a.numero || 0) - (b.numero || 0));

      giocatori.forEach(g => {
          const uid = playerUidMap[g.id];
          const isCandidato = uid && candidati[uid] === true;
          const tr = document.createElement('tr');
          tr.dataset.playerId = g.id;
          tr.dataset.uid = uid;
          tr.innerHTML = `
              <td>#${g.numero} ${g.nome} ${g.cognome}</td>
              <td>${uid ? uid.substring(0, 8) + '...' : 'N/D'}</td>
              <td>
                  <input type="checkbox" data-uid="${uid}" ${isCandidato ? 'checked' : ''} ${!uid ? 'disabled' : ''} />
              </td>
          `;
          tbody.appendChild(tr);
      });
      
      // Associa l'evento di salvataggio
      const saveBtn = byId('crud-candidature-save');
      saveBtn.onclick = () => saveCandidature(matchId, avv);

      // Mostra la sezione
      byId('crud-candidature').style.display = 'block';
      byId('crud-giocatori').style.display = 'none';
      byId('crud-partite').style.display = 'none';

      // Nascondi le sezioni CRUD standard quando è aperto il pop-up (gestito dal CSS del panel)
    };

    window.saveCandidature = async (matchId, avv) => {
        if (!isAdmin) return;
        
        const updates = {};
        const checkboxes = byId('crud-candidature-body').querySelectorAll('input[type="checkbox"]:not(:disabled)');
        
        checkboxes.forEach(cb => {
            const uid = cb.dataset.uid;
            if (uid) {
                updates[`/calendario/${matchId}/candidature/${uid}`] = cb.checked;
            }
        });
        
        try {
            await update(ref(db), updates);
            alert('Candidature aggiornate con successo!');
            closeCandidatureEditor();
            loadCandidature();
        } catch(err) {
            alert('Errore salvataggio candidature: ' + err.message);
        }
    };
    
    window.closeCandidatureEditor = ()=>{
        byId('crud-candidature-panel').style.display='none';
        byId('crud-candidature').style.display='none';
        byId('crud-giocatori').style.display='block';
        window.loadCrudGiocatori(); // Ritorna alla lista CRUD di default
    };

    window.loadCrudGiocatori = async ()=>{
        const tbody = byId('crud-giocatori-body'); if(!tbody) return; tbody.innerHTML='';
        const snap = await get(ref(db,'rosa'));
        const val = snap.val() || {};
        const rows = Object.entries(val);
        rows.sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
        
        rows.forEach(([id,g])=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" id="crud-nome-${id}" value="${escapeHtml(g.nome)}" /></td>
                <td><input type="text" id="crud-cognome-${id}" value="${escapeHtml(g.cognome)}" /></td>
                <td><input type="number" id="crud-numero-${id}" value="${g.numero}" min="1" max="99" /></td>
                <td><input type="text" id="crud-ruolo-${id}" value="${escapeHtml(g.ruolo)}" /></td>
                <td><input type="text" id="crud-stato-${id}" value="${escapeHtml(g.stato)}" /></td>
                <td>${g.presenze || 0}</td>
                <td>
                    <button class="btn btn--accent" style="padding:4px 8px; font-size:0.8rem" onclick="crudSaveGiocatore('${id}')">Salva</button>
                    <button class="btn" style="background:#dc3545; color:#fff; padding:4px 8px; font-size:0.8rem" onclick="crudDeleteGiocatore('${id}')">Elimina</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    };

    window.crudSaveGiocatore = async (id)=>{
        if(!isAdmin) return;
        const updates = {
            nome: v(`crud-nome-${id}`),
            cognome: v(`crud-cognome-${id}`),
            numero: parseInt(v(`crud-numero-${id}`), 10),
            ruolo: v(`crud-ruolo-${id}`),
            stato: v(`crud-stato-${id}`)
        };
        try{
            await update(ref(db,`rosa/${id}`), updates);
            alert('Giocatore aggiornato!');
            loadCrudGiocatori(); loadRosa();
        }catch(err){ alert('Errore: '+err.message); }
    };

    window.crudDeleteGiocatore = async (id)=>{
        if(!isAdmin || !confirm('Sei sicuro di voler eliminare questo giocatore?')) return;
        try{
            await remove(ref(db,`rosa/${id}`));
            alert('Giocatore eliminato!');
            loadCrudGiocatori(); loadRosa();
        }catch(err){ alert('Errore: '+err.message); }
    };
    
    window.loadCrudPartite = async ()=>{
        const tbody = byId('crud-partite-body'); if(!tbody) return; tbody.innerHTML='';
        const snap = await get(ref(db,'calendario'));
        const val = snap.val() || {};
        const rows = Object.entries(val);
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        rows.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
        
        rows.forEach(([id,m])=>{
            const isCasa = m.casa === true;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" id="crud-avversaria-${id}" value="${escapeHtml(m.avversaria)}" /></td>
                <td><input type="text" id="crud-data-${id}" value="${escapeHtml(m.data)}" /></td>
                <td><input type="time" id="crud-orario-${id}" value="${escapeHtml(m.orario)}" /></td>
                <td><input type="text" id="crud-campo-${id}" value="${escapeHtml(m.campo || '')}" /></td>
                <td><input type="text" id="crud-risultato-${id}" value="${escapeHtml(m.risultato || 'N/D')}" /></td>
                <td>
                    <select id="crud-casa-${id}">
                        <option value="true" ${isCasa ? 'selected' : ''}>Sì</option>
                        <option value="false" ${!isCasa ? 'selected' : ''}>No</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn--accent" style="padding:4px 8px; font-size:0.8rem" onclick="crudSavePartita('${id}')">Salva</button>
                    <button class="btn" style="background:#dc3545; color:#fff; padding:4px 8px; font-size:0.8rem" onclick="crudDeletePartita('${id}')">Elimina</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    };

    window.crudSavePartita = async (id)=>{
        if(!isAdmin) return;
        const updates = {
            avversaria: v(`crud-avversaria-${id}`),
            data: v(`crud-data-${id}`),
            orario: v(`crud-orario-${id}`),
            campo: v(`crud-campo-${id}`),
            risultato: v(`crud-risultato-${id}`),
            casa: v(`crud-casa-${id}`) === 'true'
        };
        try{
            await update(ref(db,`calendario/${id}`), updates);
            alert('Partita aggiornata!');
            loadCrudPartite(); window.loadProssimeGiornate(true); loadStatistiche();
        }catch(err){ alert('Errore: '+err.message); }
    };

    window.crudDeletePartita = async (id)=>{
        if(!isAdmin || !confirm('Sei sicuro di voler eliminare questa partita?')) return;
        try{
            await remove(ref(db,`calendario/${id}`));
            alert('Partita eliminata!');
            loadCrudPartite(); window.loadProssimeGiornate(true); loadStatistiche();
        }catch(err){ alert('Errore: '+err.message); }
    };
    
    window.showValutazionePartitaForm = async (matchId, avv) => {
        if (!isAdmin) return;
        window.showAdminSection('admin-prestazioni-partita-section');
        const content = byId('prestazioni-form-content');
        
        const [snapRosa, snapMatch] = await Promise.all([
            get(ref(db, 'rosa')),
            get(ref(db, `calendario/${matchId}`))
        ]);
        const rosa = snapRosa.val() || {};
        const match = snapMatch.val() || {};
        const currentValutazioni = match.valutazioni || {};

        let html = `
            <h2>Admin · Valutazione Prestazioni vs ${escapeHtml(avv)} (${match.risultato})</h2>
            <div class="help">Inserisci voto (min. 1, max. 10) e goal per ciascun giocatore.</div>
            <form onsubmit="saveValutazioni(event, '${matchId}')">
                <table class="table" style="margin-top:12px">
                    <thead><tr><th>#</th><th>Nome</th><th>Ruolo</th><th>Voto</th><th>Goal</th></tr></thead>
                    <tbody>
        `;

        const giocatori = Object.entries(rosa).map(([id, g]) => ({ id, ...g })).sort((a, b) => (a.numero || 0) - (b.numero || 0));

        giocatori.forEach(g => {
            const currentVoto = currentValutazioni[g.id]?.voto || '';
            const currentGoal = currentValutazioni[g.id]?.goal || 0;
            
            html += `
                <tr>
                    <td><span class="pill">#${g.numero}</span></td>
                    <td><span style="font-weight:700">${g.nome} ${g.cognome}</span></td>
                    <td class="player-sub">${g.ruolo}</td>
                    <td>
                        <input type="number" id="voto-${g.id}" value="${currentVoto}" min="1" max="10" step="0.5" style="max-width:80px" />
                    </td>
                    <td>
                        <input type="number" id="goal-${g.id}" value="${currentGoal}" min="0" style="max-width:60px" />
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
                <div class="actions">
                    <button class="btn btn--admin" type="submit">Salva Valutazioni</button>
                    <button class="btn" type="button" onclick="showAdminSection('admin-calendario-section')">Annulla</button>
                </div>
            </form>
        `;
        content.innerHTML = html;
    };

    window.saveValutazioni = async (e, matchId) => {
        e.preventDefault();
        if (!isAdmin) return;
        
        const updates = {};
        const giocatori = Object.keys(rosa); // Usa l'oggetto rosa caricato in showValutazionePartitaForm (attenzione alla scope)
        // Se `rosa` non è globale o non definita qui, dovrei ricaricarla. Assumo per ora che i giocatori siano presi dal DOM.

        const tableRows = byId('prestazioni-form-content').querySelectorAll('tbody tr');
        let isValid = true;

        tableRows.forEach(row => {
            const playerId = row.querySelector('input[type="number"]').id.split('-')[1]; // Estrae l'ID dal campo Voto
            const votoInput = byId(`voto-${playerId}`);
            const goalInput = byId(`goal-${playerId}`);
            
            const voto = parseFloat(votoInput.value);
            const goal = parseInt(goalInput.value, 10);

            if (votoInput.value !== '' && (isNaN(voto) || voto < 1 || voto > 10)) {
                isValid = false;
                alert(`Voto non valido per il giocatore con ID ${playerId}.`);
                return;
            }
            if (goalInput.value !== '' && (isNaN(goal) || goal < 0)) {
                isValid = false;
                alert(`Goal non validi per il giocatore con ID ${playerId}.`);
                return;
            }
            
            // Salva solo se c'è almeno un voto o un goal
            if (votoInput.value !== '' || goal > 0) {
               updates[playerId] = {
                   voto: voto || 0,
                   goal: goal || 0
               };
            }
        });
        
        if (!isValid) return;

        try {
            await update(ref(db, `calendario/${matchId}`), { valutazioni: updates });
            alert('Valutazioni salvate!');
            window.loadPrestazioniAggregato(); // Ricarica aggregato
            showAdminSection('admin-calendario-section');
        } catch (err) {
            alert('Errore salvataggio valutazioni: ' + err.message);
        }
    };
    
</script>
</head>
<body>
  <header>
    <div class="hero" role="banner">
      <img src="Logo.png" alt="Logo AC Tuscolano" />
      <div class="brand">
        <h1 class="club">AC Tuscolano</h1>
        <p class="tag">Football Club</p>
      </div>
    </div>
  </header>
  <nav aria-label="Navigazione principale">
    <div class="nav-wrap">
      <button id="rosa-tab" class="tab" data-target="rosa-section" aria-current="page" onclick="showPublicSection('rosa-section')">La nostra Rosa</button>
      <button id="calendario-tab" class="tab" data-target="calendario-section" onclick="showPublicSection('calendario-section')">Calendario & Partite</button>
      <button id="classifica-tab" class="tab" data-target="classifica-section" onclick="showPublicSection('classifica-section')">Classifica</button>
      <button id="statistiche-tab" class="tab" data-target="statistiche-section" onclick="showPublicSection('statistiche-section')">Statistiche & Prestazioni</button>
      <button id="video-tab" class="tab" data-target="video-section" onclick="showPublicSection('video-section')">Video</button>
      <button id="auth-toggle-btn" class="btn">Login</button>
    </div>
  </nav>

  <nav id="admin-menu" aria-label="Menu Amministrazione">
    <div class="nav-wrap">
      <button class="tab btn--admin" data-admin-target="admin-inserimento-giocatori-section" onclick="showAdminSection('admin-inserimento-giocatori-section')">Giocatori</button>
      <button class="tab btn--admin" data-admin-target="admin-inserimento-giornate-section" onclick="showAdminSection('admin-inserimento-giornate-section')">Nuova Giornata</button>
      <button class="tab btn--admin" data-admin-target="admin-calendario-section" onclick="showAdminSection('admin-calendario-section')">Gestione Giornate</button>
      <button class="tab btn--admin" data-admin-target="admin-gestione-dati-section" onclick="showAdminSection('admin-gestione-dati-section')">Gestione Dati</button>
      <button class="tab btn--admin" data-admin-target="admin-video-section" onclick="showAdminSection('admin-video-section')">Gestione Video</button>
      <button class="tab btn--admin" data-admin-target="admin-utenti-section" onclick="showAdminSection('admin-utenti-section')">Utenti</button>
    </div>
  </nav>

  <main>
    <section id="login-section">
      <h2>Login</h2>
      <form id="login-form">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required />
        <label for="login-password">Password</label>
        <input type="password" id="login-password" required />
        <div class="actions"><button class="btn btn--accent" type="submit">Accedi</button></div>
      </form>
      <div class="help">Accedi con le tue credenziali per accedere all’area Admin.</div>
    </section>

    <section id="rosa-section">
      <h2>Rosa</h2>
      <ul id="rosa-list" class="grid cols-2"></ul>
    </section>

    <section id="calendario-section" style="display:none">
      <h2>Prossime giornate</h2>
      <div class="help">Premi “Candidatura” per dare disponibilità. Se pubblicata, puoi vedere la formazione ufficiale. Ordinato dalla più recente.</div>
      <ul id="calendario-list" class="grid cols-3"></ul>
    </section>

    <section id="classifica-section" style="display:none">
      <h2>Classifica</h2>
      <div id="classifica-content" style="overflow-x:auto;"> 
        </div>
    </section>

    <section id="statistiche-section" style="display:none">
      <h2>Prestazioni</h2>
      <h3>Risultati squadra</h3>
      <div class="help">Lista ordinata dalla partita più recente. **Lo sfondo della riga e il bordo laterale indicano l'esito: Verde (Vittoria), Rosso (Sconfitta), Grigio (Pareggio).**</div>
      <ul id="statistiche-risultati-list"> 
        </ul>
      <div id="prestazioni-aggregate-content">
        <h3>Riepilogo Giocatori</h3>
        <div class="help">Calcolo media voti e goal in corso…</div>
      </div>
    </section>

    <section id="video-section" style="display:none">
      <h2>Video Partite Concluse</h2>
      <ul id="video-list-ul" style="display:grid; gap:16px;"> 
        </ul>
    </section>

    <section id="formazione-pubblica-section" style="display:none">
      <h2>Formazione Ufficiale</h2>
      <div id="formazione-pubblica-content"></div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showPublicSection('calendario-section')">Torna al calendario</button></div>
    </section>

    <section id="prestazioni-partita-section" style="display:none">
      <h2>Prestazioni Partita</h2>
      <div id="prestazioni-partita-content"></div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showPublicSection('calendario-section')">Torna al calendario</button></div>
    </section>
    
    <section id="admin-inserimento-giocatori-section" style="display:none">
      <h2>Admin · Inserimento giocatori</h2>
      <form id="giocatore-form" onsubmit="addPlayer(event)">
        <label>Nome</label><input id="giocatore-nome" required />
        <label>Cognome</label><input id="giocatore-cognome" required />
        <label>Numero di maglia</label><input id="giocatore-numero" type="number" min="1" max="99" required />
        <label>Ruolo</label>
        <select id="giocatore-ruolo" required>
          <option value="">Seleziona ruolo</option>
          <option>Portiere</option>
          <option>Difensore centrale</option>
          <option>Terzino sinistro</option>
          <option>Terzino destro</option>
          <option>Centrocampista centrale</option>
          <option>Centrocampista sinistro</option>
          <option>Centrocampista destro</option>
          <option>Attaccante centrale</option>
        </select>
        <label>Stato</label>
        <select id="giocatore-titolare" required>
          <option>Titolare</option>
          <option>Riserva</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Aggiungi giocatore</button></div>
      </form>
    </section>
    
    <section id="admin-inserimento-giornate-section" style="display:none">
      <h2>Admin · Inserimento Giornate</h2>
      <form id="match-form" onsubmit="addMatch(event)">
        <label>Squadra Avversaria</label><input id="match-avversaria" required />
        <label>Data Partita (GG/MM/AAAA)</label><input id="match-data" required />
        <label>Orario Partita</label><input id="match-orario" type="time" required />
        <label>Campo di gioco</label><input id="match-campo" required />
        <label>Partita giocata in casa?</label>
        <select id="match-casa" required>
          <option value="true">Sì</option>
          <option value="false">No</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Aggiungi partita</button></div>
      </form>
    </section>
    
    <section id="admin-calendario-section" style="display:none">
      <h2>Admin · Gestione Giornate</h2>
      <div class="help">Risultato/Formazione/Valuta sono pulsanti contestuali che si attivano in base allo stato della partita.</div>
      <ul id="admin-calendario-list" class="grid cols-3"></ul>
    </section>

    <section id="admin-statistiche-section" style="display:none">
      <h2>Admin · Inserimento Risultato</h2>
      <div id="risultato-content">
        </div>
    </section>

    <section id="admin-formazione-section" style="display:none">
      <h2>Admin · Inserimento Formazione</h2>
      <div id="formazione-content">
        </div>
    </section>

    <section id="admin-prestazioni-partita-section" style="display:none">
      <h2>Admin · Valutazione Prestazioni</h2>
      <div id="prestazioni-form-content">
        </div>
    </section>

    <section id="admin-candidature-section" style="display:none">
      <h2>Admin · Gestione Candidature (Compact)</h2>
      <div class="help">Elenco disponibilità inviate dagli utenti (Visualizzazione rapida). Per impostare a nome usa **Gestione dati**.</div>
      <ul id="candidature-list" class="grid cols-2"></ul>
    </section>

    <section id="admin-gestione-dati-section" style="display:none">
      <h2>Admin · Gestione dati</h2>
      <div class="card" style="margin-bottom:14px">
        <div class="row">
          <button class="tab" aria-current="page" onclick="document.getElementById('crud-giocatori').style.display='block';document.getElementById('crud-partite').style.display='none';document.getElementById('crud-candidature').style.display='none';loadCrudGiocatori()">Giocatori</button>
          <button class="tab" onclick="document.getElementById('crud-giocatori').style.display='none';document.getElementById('crud-partite').style.display='block';document.getElementById('crud-candidature').style.display='none';loadCrudPartite()">Partite</button>
          <button class="tab" onclick="updateClassificaFromSito()">Aggiorna Classifica</button>
        </div>
      </div>
      
      <div id="crud-giocatori">
        <h3>Modifica Giocatori</h3>
        <table class="table">
          <thead>
            <tr><th>Nome</th><th>Cognome</th><th>#</th><th>Ruolo</th><th>Stato</th><th>Presenze</th><th>Azioni</th></tr>
          </thead>
          <tbody id="crud-giocatori-body"></tbody>
        </table>
      </div>
      
      <div id="crud-partite" style="display:none">
        <h3>Modifica Partite</h3>
        <table class="table">
          <thead>
            <tr><th>Avversaria</th><th>Data</th><th>Orario</th><th>Campo</th><th>Risultato</th><th>Casa</th><th>Azioni</th></tr>
          </thead>
          <tbody id="crud-partite-body"></tbody>
        </table>
      </div>
      
      <div id="crud-candidature" style="display:none">
        <h3>Modifica Candidature (Partita: <span id="crud-candidature-match-name"></span>)</h3>
        <div class="actions" style="margin-bottom:10px">
           <button class="btn btn--accent" id="crud-candidature-save">Salva Candidature</button>
           <button class="btn" onclick="closeCandidatureEditor()">Chiudi</button>
        </div>
        <table class="table">
          <thead>
            <tr><th>Giocatore</th><th>UID Utente</th><th>Disponibile</th></tr>
          </thead>
          <tbody id="crud-candidature-body"></tbody>
        </table>
      </div>
      
      <div id="crud-candidature-panel" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.7); z-index:90; align-items:center; justify-content:center">
        </div>
    </section>
    
    <section id="admin-video-section" style="display:none">
      <h2>Admin · Gestione Video</h2>
      <div class="help">Seleziona una partita conclusa e incolla l'URL del video YouTube.</div>
      <label for="video-partita-select">Partita Conclusa</label>
      <select id="video-partita-select" required></select>
      
      <label for="video-link-input">Link YouTube</label>
      <input id="video-link-input" type="url" placeholder="Esempio: https://www.youtube.com/watch?v=VIDEOID" />
      
      <div class="actions">
        <button class="btn btn--admin" id="save-video-btn" disabled>Salva Link Video</button>
      </div>
    </section>

    <section id="admin-utenti-section" style="display:none">
      <h2>Admin · Inserimento utenti</h2>
      <form id="create-user-form">
        <label>Nome Giocatore</label><input id="new-nome" required />
        <label>Cognome Giocatore</label><input id="new-cognome" required />
        <label>Email</label><input id="new-email" type="email" required />
        <label>Password</label><input id="new-password" type="password" required />
        <div class="actions"><button class="btn btn--admin" type="submit">Crea utenza</button></div>
      </form>
      <div class="help">L’admin resta connesso durante la creazione grazie all’autenticazione secondaria.</div>
    </section>
  </main>
  
  <div id="video-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 20px;">
    <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button" style="position:absolute; top:-10px; right:-10px; z-index:110; font-size:1.2rem; line-height:1.2;">×</button>
      <div id="video-iframe-container" style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; border-radius: var(--radius); overflow: hidden;">
        </div>
    </div>
  </div>

  <footer>
    © 2024 AC Tuscolano. Tutti i diritti riservati.
  </footer>
</body>
</html>
