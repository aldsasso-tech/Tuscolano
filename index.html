<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <script>
    /* ===== SCHEDULAZIONE: refresh giornaliero alle 23:00 ===== */
    function msUntilNext(hour, minute = 0, second = 0) {
      const now = new Date();
      const next = new Date(now);
      next.setHours(hour, minute, second, 0);
      if (next <= now) next.setDate(next.getDate() + 1);
      return next - now;
    }

    window.scheduleDailyClassificaRefresh = () => {
      const ms = msUntilNext(23, 0, 0);
      const infoEl = document.getElementById('classifica-next-run');
      if (infoEl) {
        const when = new Date(Date.now() + ms).toLocaleString('it-IT');
        infoEl.textContent = `Prossimo aggiornamento: ${when}`;
      }
      setTimeout(async function tick() {
        if (typeof window.loadClassifica === 'function') {
           await window.loadClassifica();
        }
        window.scheduleDailyClassificaRefresh();
      }, ms);
    };
  </script>
  
  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }

    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  

    /* === Effetti di transizione per le sezioni visibili (.content-section) === */
    .content-section {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      display: none; /* Aggiunto per coerenza con lo script modulo */
    }
    .content-section.active {
      opacity: 1;
      pointer-events: all;
      display: block; /* Aggiunto per coerenza con lo script modulo */
    }
  </style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; 

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section','video-section', 'classifica-section','prestazioni-partita-section'];
    const ADMIN_SECTIONS = ['admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section',
      'admin-statistiche-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section',
      'admin-prestazioni-section' // AGGIUNTO
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; 

    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      ALL_SECTIONS.forEach(secId => { 
        const el = byId(secId); 
        if (el) {
             el.style.display = (secId === id) ? 'block' : 'none'; 
             // Gestione classe active per eventuale CSS transition
             if (secId === id) {
                 el.classList.add('active');
             } else {
                 el.classList.remove('active');
             }
        }
      });
      document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
      document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dall'admin
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); 
        
        ALL_SECTIONS.forEach(secId => { 
          const el = byId(secId); 
          if (el) {
              el.style.display = (secId === id) ? 'block' : 'none'; 
              if (secId === id) {
                 el.classList.add('active');
             } else {
                 el.classList.remove('active');
             }
          }
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); 
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
            t.setAttribute('aria-current', t.dataset.adminTarget===id ? 'page' : 'false');
        });

        // Ricarica i dati specifici per la sezione admin
        if(id==='admin-calendario-section'){ window.loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ window.loadCandidature(); }
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') window.loadPartitePerVideoAdmin(); 
        if (id === 'admin-prestazioni-section') window.adminLoadPartiteConcluseForPrestazioni(); // NUOVO

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); 
      toggleAdminUI(); 
      
      if(user && isAdmin) {
         if(byId('admin-inserimento-giocatori-section').style.display === 'none'){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         window.showPublicSection('rosa-section');
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    // Placeholder function for the old structure to avoid errors. The module functions will implement the logic.
    window.loadStatistiche = () => {};

    // =================================================================================
    // LOGICHE PRESTAZIONI & STATISTICHE (Aggiornate e Globali)
    // =================================================================================

    // Aggregato pubblico per tab "Statistiche": calcola per-giocatore media voto e goal totali
    window.loadPrestazioniAggregato = async () => {
      window.showPublicSection('statistiche-section'); // Assicura che la sezione sia attiva
      const list = document.getElementById('statistiche-voti-list'); // Contenitore per la lista giocatori
      if (list) list.innerHTML = '';
      
      const wrapId = 'prest-agg-wrap';
      let wrap = document.getElementById(wrapId);
      if (!wrap) {
        wrap = document.createElement('div');
        wrap.id = wrapId;
        document.getElementById('statistiche-section').prepend(wrap);
      }
      wrap.innerHTML = '<div class="help">Calcolo in corso…</div>';

      try{
        const [snapRosa, snapPrest] = await Promise.all([
          get(ref(db,'rosa')),
          get(ref(db,'prestazioni'))
        ]);
        const rosa = snapRosa.val()||{};
        const prestazioni = snapPrest.val()||{};

        // Aggrega: per playerId => {partite, sommaVoti, goal, assist}
        const agg = {};
        Object.entries(prestazioni).forEach(([matchId, perMatch])=>{
          Object.entries(perMatch||{}).forEach(([pid, rec])=>{
            if (!agg[pid]) agg[pid] = {partite:0, sommaVoti:0, goal:0, assist:0};
            agg[pid].partite += 1;
            agg[pid].sommaVoti += Number(rec.voto||0);
            agg[pid].goal += Number(rec.goal||0);
            agg[pid].assist += Number(rec.assist||0); // AGGIUNTO ASSIST
          });
        });

        // Render tabella
        const rows = Object.entries(rosa).map(([pid, g])=>{
          const a = agg[pid] || {partite:0,sommaVoti:0,goal:0,assist:0};
          const media = a.partite ? (a.sommaVoti/a.partite) : 0;
          return {
            pid,
            nome: `${g.nome||''} ${g.cognome||''}`.trim(),
            numero: g.numero||'',
            partite: a.partite,
            mediaVoto: Number(media.toFixed(2)),
            goal: a.goal,
            assist: a.assist // AGGIUNTO ASSIST
          };
        }).sort((a,b)=> b.mediaVoto - a.mediaVoto || b.goal - a.goal || a.nome.localeCompare(b.nome));

        const tableHtml = [
          '<h2>Riepilogo Prestazioni Giocatori</h2><p class="help">Indicatori totali delle prestazioni per singolo giocatore.</p><table class="table"><thead><tr>',
          '<th>#</th><th>Giocatore</th><th>Partite</th><th>Media voto</th><th>Goal</th><th>Assist</th>',
          '</tr></thead><tbody>',
          ...rows.map(r=>`<tr><td>${r.numero}</td><td>${r.nome}</td><td>${r.partite}</td><td>${r.mediaVoto}</td><td>${r.goal}</td><td>${r.assist}</td></tr>`),
          '</tbody></table>'
        ].join('');
        wrap.innerHTML = tableHtml;

        // Ricarica la lista delle partite con i pulsanti "Prestazioni"
        window.loadPartitePerStatistiche();

      }catch(err){
        console.error('Errore aggregato prestazioni:', err);
        wrap.innerHTML = '<div class="help" style="color:red">Errore nel calcolo prestazioni.</div>';
      }
    };
    
    // Carica la lista delle partite concluse con pulsante "Prestazioni" per la sezione Statistiche
    window.loadPartitePerStatistiche = async function(){
        const listId = 'statistiche-risultati-list';
        const ul = byId(listId); if(!ul) return; ul.innerHTML='<div class="help">Caricamento partite...</div>';
        const snap = await get(ref(db,'calendario'));
        const val = snap.val() || {};
        let entries = Object.entries(val);
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        const today = new Date(); today.setHours(0,0,0,0);
        
        // Ordina dalla più recente
        entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
        
        let htmlContent = '<h2>Partite Concluse</h2><p class="help">Visualizza il dettaglio delle prestazioni per ogni partita conclusa.</p><ul class="grid cols-3">';
        let found = false;

        for(const [matchId,m] of entries){
            const matchDate = toDate(m.data);
            const isPast = matchDate < today;
            
            // Filtra solo le partite concluse con risultato
            if (isPast && m.risultato && m.risultato !== 'N/D') {
                found = true;
                const li = document.createElement('li'); li.className='card';
                li.innerHTML = `
                    <div class="row" style="justify-content:space-between;align-items:flex-start;flex-direction:column;gap:8px;">
                        <div>
                            <div style="font-weight:800;font-size:1.05rem">vs ${m.avversaria||'Avversario N/D'}</div>
                            <div class="player-sub">${m.data||'N/D'} • Risultato: <b>${m.risultato}</b></div>
                        </div>
                        <button class="btn btn--accent" onclick="window.showPrestazioniPubbliche('${matchId}')">Prestazioni</button>
                    </div>`;
                ul.appendChild(li);
            }
        }
        
        if (!found) {
            ul.innerHTML = '<div class="help">Nessuna partita conclusa con risultato da analizzare.</div>';
        } else {
             ul.prepend(document.createRange().createContextualFragment(htmlContent));
        }
    }


    // Mostra le prestazioni della singola partita (solo giocatori presenti)
    window.showPrestazioniPubbliche = async (matchId) => {
      const container = byId('prestazioni-partita-content');
      const meta = byId('prestazioni-partita-meta');
      if(!container) return;

      meta.innerHTML = 'Caricamento…';
      container.innerHTML = '';
      window.showPublicSection('prestazioni-partita-section');
      

      try{
        const [snapMatch, snapRosa, snapPrest] = await Promise.all([
          get(ref(db, 'calendario/'+matchId)),
          get(ref(db, 'rosa')),
          get(ref(db, 'prestazioni/'+matchId))
        ]);
        const match = snapMatch.val()||{};
        const rosa = snapRosa.val()||{};
        const prest = snapPrest.val()||{};
        
        meta.innerHTML = `Dettaglio Prestazioni: <b>${match.data||''}</b> vs <b>${match.avversaria||'N/D'}</b> • Risultato: <b>${match.risultato||'N/D'}</b>`;

        // Giocatori presenti = unione di giocatori in formazione in qualunque frame + panchina
        const presentiSet = new Set();
        const formazioni = match.formazioni || {};
        Object.values(formazioni).forEach(f => {
          const fm = f.formazione || {};
          Object.values(fm).forEach(pid => pid && presentiSet.add(pid));
        });
        (match.panchina||[]).forEach(pid => pid && presentiSet.add(pid));

        if (presentiSet.size === 0) {
          container.innerHTML = '<div class="help">Nessuna formazione/presenza registrata per questa partita.</div>';
          return;
        }

        const rows = Array.from(presentiSet).map(pid => {
          const g = rosa[pid] || {};
          const r = prest[pid] || {};
          return {
            pid,
            nome: `${g.nome||''} ${g.cognome||''}`.trim(),
            numero: g.numero||'',
            voto: r.voto ?? '-',
            goal: r.goal ?? 0,
            assist: r.assist ?? 0 // AGGIUNTO ASSIST
          };
        }).sort((a,b)=> (b.voto||0)-(a.voto||0) || b.goal-a.goal);

        const html = [
          '<table class="table"><thead><tr><th>#</th><th>Giocatore</th><th>Voto</th><th>Goal</th><th>Assist</th></tr></thead><tbody>',
          ...rows.map(r=>`<tr><td>${r["numero"]}</td><td>${r["nome"]}</td><td>${r["voto"]}</td><td>${r["goal"]}</td><td>${r["assist"]}</td></tr>`),
          '</tbody></table>'
        ];
        container.innerHTML = html.join('');
      }catch(err){
        console.error('Errore prestazioni partita:', err);
        container.innerHTML = '<div class="help" style="color:red">Errore nel caricamento delle prestazioni della partita.</div>';
      }
    };


    // ADMIN: load partite concluse per il select
    window.adminLoadPartiteConcluseForPrestazioni = async () => {
      const sel = document.getElementById('admin-prest-partita-select');
      if (!sel) return;
      sel.innerHTML = '<option value="">Caricamento…</option>';
      try{
        const snap = await get(ref(db, 'calendario'));
        const val = snap.val()||{};
        const keys = Object.keys(val);
        
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        keys.sort((a,b)=> toDate(val[b].data)-toDate(val[a].data));
        
        let opts = '<option value="">Seleziona una partita conclusa</option>';
        const today = new Date(); today.setHours(0,0,0,0);
        
        keys.forEach(k=>{
          const m = val[k];
          const matchDate = toDate(m.data);
          const isPast = matchDate < today;
          
          if (isPast && m.risultato && m.risultato !== 'N/D') { // Solo partite concluse con risultato
            const tag = m.avversaria ? `vs ${m.avversaria}` : k;
            opts += `<option value="${k}">${m.data||''} ${m.orario||''} — ${tag} — ${m.risultato}</option>`;
          }
        });
        sel.innerHTML = opts;
        
      }catch(err){
        sel.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // ADMIN: carica form prestazioni per i soli presenti
    window.adminCaricaPrestazioni = async () => {
      if (!isAdmin) return alert('Solo admin.');
      const sel = document.getElementById('admin-prest-partita-select');
      const key = sel?.value;
      const wrap = document.getElementById('admin-prestazioni-wrap');
      if (!key) { wrap.innerHTML = '<div class="help">Seleziona una partita.</div>'; return; }
      wrap.innerHTML = 'Caricamento…';

      try{
        const [snapMatch, snapRosa, snapPrest] = await Promise.all([
          get(ref(db, 'calendario/'+key)),
          get(ref(db, 'rosa')),
          get(ref(db, 'prestazioni/'+key))
        ]);
        const match = snapMatch.val()||{};
        const rosa = snapRosa.val()||{};
        const prest = snapPrest.val()||{};

        // Giocatori presenti (Formazione o Panchina)
        const presentiSet = new Set();
        const formazioni = match.formazioni || {};
        Object.values(formazioni).forEach(f => {
          const fm = f.formazione || {};
          Object.values(fm).forEach(pid => pid && presentiSet.add(pid));
        });
        (match.panchina||[]).forEach(pid => pid && presentiSet.add(pid));

        const rows = Array.from(presentiSet).map(pid => {
          const g = rosa[pid] || {};
          const r = prest[pid] || {};
          return {
            pid,
            nome: `${g.nome||''} ${g.cognome||''}`.trim(),
            numero: g.numero||'',
            voto: r.voto ?? '',
            goal: r.goal ?? 0,
            assist: r.assist ?? 0 // AGGIUNTO ASSIST
          };
        }).sort((a,b)=> (a.nome||'').localeCompare(b.nome||''));

        const html = [
          `<div class="help"><b>${match.data||''} ${match.orario||''}</b> — vs <b>${match.avversaria||''}</b> • Risultato: <b>${match.risultato||'N/D'}</b></div>`,
          '<table class="table"><thead><tr><th>#</th><th>Giocatore</th><th>Voto (4-10)</th><th>Goal</th><th>Assist</th><th>Azioni</th></tr></thead><tbody>',
          ...rows.map(r=>`<tr><td>${r["numero"]}</td><td>${r["nome"]}</td>`
            +`<td><input type="number" step="0.5" min="4" max="10" id="voto-${r["pid"]}" value="${r["voto"]}"></td>`
            +`<td><input type="number" step="1" min="0" id="goal-${r["pid"]}" value="${r["goal"]}"></td>`
            +`<td><input type="number" step="1" min="0" id="assist-${r["pid"]}" value="${r["assist"]}"></td>` // AGGIUNTO ASSIST INPUT
            +`<td><button class="btn" onclick="window.adminEliminaPrestazione('${r["pid"]}')">Elimina</button></td></tr>`),
          '</tbody></table>',
          '<div class="actions"><button id="admin-prest-salva" class="btn btn--admin" type="button">Salva Prestazioni</button></div>'
        ].join('');
        wrap.innerHTML = html;
        wrap.dataset.matchId = key;
      }catch(err){
        console.error('Errore adminCaricaPrestazioni:', err);
        wrap.innerHTML = '<div class="help" style="color:red">Errore nel caricamento.</div>';
      }
    };

    window.adminSalvaPrestazioni = async () => {
      if (!isAdmin) return alert('Solo admin.');
      const wrap = document.getElementById('admin-prestazioni-wrap');
      const matchId = wrap?.dataset?.matchId;
      if (!matchId) return alert('Carica prima una partita.');

      const rows = wrap.querySelectorAll('tbody tr');
      const updates = {};
      rows.forEach(tr => {
        // Recupera pid dagli id input
        const votoInput = tr.querySelector('input[id^="voto-"]');
        const goalInput = tr.querySelector('input[id^="goal-"]');
        const assistInput = tr.querySelector('input[id^="assist-"]'); // AGGIUNTO ASSIST INPUT
        
        if (!votoInput || !goalInput || !assistInput) return;
        
        const pid = votoInput.id.replace('voto-','');
        const voto = parseFloat(votoInput.value || '0') || 0;
        const goal = parseInt(goalInput.value || '0', 10) || 0;
        const assist = parseInt(assistInput.value || '0', 10) || 0; // AGGIUNTO ASSIST

        // Salva solo se il voto è stato inserito (oppure potresti voler salvare 0/0/0 anche senza voto)
        if (voto > 0) {
            updates[`/prestazioni/${matchId}/${pid}`] = {voto, goal, assist};
        } else if (voto === 0) {
             // Se il voto è 0, o lo rimuove o lo imposta esplicitamente
             updates[`/prestazioni/${matchId}/${pid}`] = {voto, goal, assist};
        }
      });

      try{
        await update(ref(db), updates);
        alert('Prestazioni salvate.');
      }catch(err){
        alert('Errore salvataggio: ' + (err?.message||err));
      }
    };

    window.adminEliminaPrestazione = async (pid) => {
      if (!isAdmin) return alert('Solo admin.');
      const wrap = document.getElementById('admin-prestazioni-wrap');
      const matchId = wrap?.dataset?.matchId;
      if (!matchId || !pid) return;
      if (!confirm('Eliminare la prestazione per questo giocatore?')) return;
      try{
        await remove(ref(db, `/prestazioni/${matchId}/${pid}`));
        alert('Prestazione eliminata.');
        window.adminCaricaPrestazioni();
      }catch(err){
        alert('Errore eliminazione: ' + (err?.message||err));
      }
    };

    // Admin Prestazioni buttons handler
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'admin-prest-carica') {
        e.preventDefault();
        window.adminCaricaPrestazioni();
      }
      if (e.target && e.target.id === 'admin-prest-salva') {
        e.preventDefault();
        window.adminSalvaPrestazioni();
      }
    });

    // =================================================================================
    // NUOVA loadProssimeGiornate (Include pulsante Prestazioni)
    // =================================================================================

    window.loadProssimeGiornate = async function(asAdmin){
      const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
      const ul = byId(listId); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'calendario'));
      const val = snap.val() || {};
      let entries = Object.entries(val);
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      const today = new Date(); today.setHours(0,0,0,0);
      entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
      if(!entries.length){ ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; return; }
      ul.className='grid cols-3';
      for(const [matchId,m] of entries){
        const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
        const cand = candSnap.val() || {};
        const candCount = Object.values(cand).filter(Boolean).length;
        const isPublished = m.formazionePubblicata === true;
        const matchDate = toDate(m.data);
        const isPast = matchDate < today;
        let candButton = '';
        if (isPast) {
          candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`;
        } else {
          candButton = `<button class="btn btn--accent" onclick="window.candidati('${matchId}')">Candidatura</button>`;
        }
        // PULSANTE PRESTAZIONI AGGIUNTO
        const showPrestBtn = (isPast && m.risultato && m.risultato !== 'N/D') ? `<button class="btn" onclick="window.showPrestazioniPubbliche('${matchId}')">Prestazioni</button>` : '';
        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div style="font-weight:800;font-size:1.05rem">vs ${m.avversaria||''}</div>
              <div class="player-sub">${m.data||''} • ${m.orario||''} • ${m.campo||''} • ${m.casa? 'Casa':'Trasferta'}</div>
              <div class="player-sub">Candidature: <b>${candCount}</b></div>
              <div class="player-sub">Risultato: <b>${m.risultato||'N/D'}</b></div>
            </div>
            <div class="row">
              ${!asAdmin ? `${candButton} ${isPublished ? `<button class="btn" onclick="window.showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria||'')}')">Vedi Formazione</button>` : ''} ${showPrestBtn}`:''}
              ${asAdmin ? `<button class="btn btn--admin" onclick="window.showFormazioneForm('${matchId}','${escapeHtml(m.avversaria||'')}')">Formazione & Sost.</button><button class="btn btn--admin" onclick="window.showRisultatoForm('${matchId}','${escapeHtml(m.avversaria||'')}')">Risultato</button>`:''}
            </div>
          </div>`;
        ul.appendChild(li);
      }
    };


    // =================================================================================
    // ALTRE FUNZIONI (Mantenute e rese globali)
    // =================================================================================

    /* FUNZIONE loadClassifica resa globale per lo scheduler */
    window.loadClassifica = async () => {
      const classificaContent = document.getElementById('classifica-content');
      if (!classificaContent) return;

      classificaContent.innerHTML = `<div class="help">Caricamento classifica in corso...</div>`;

      try {
        const now = new Date();
        const todayKey = now.toISOString().split('T')[0];
        const snap = await get(ref(db, 'classifica_cache'));
        const cache = snap.val() || {};
        const cachedHtml = cache.html;
        const cachedDate = cache.date;

        if (cachedHtml && cachedDate === todayKey) {
          classificaContent.innerHTML = cachedHtml;
          return;
        }
        
        // Simulo la chiamata al proxy per evitare errori CORS (assumendo che sia definito altrove o non necessario)
        // Per il funzionamento offline o in ambienti non-CORS, si potrebbe usare un proxy. 
        // Poiché il codice fornito non include il proxy, uso l'URL diretto come tentativo o fallback.
        const url = "https://www.romatornei.it/romatornei/prestazioni/classifica.php";
        
        // === LOGICA DI SCRAPING E CACHE (Come da codice utente) ===
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const htmlText = await response.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');
        const table = doc.querySelector('table');
        if (!table) throw new Error('Tabella non trovata nella pagina esterna.');

        // Normalizzazione TH
        const thead = table.querySelector('thead');
        const headers = Array.from(thead.querySelectorAll('th'));
        const totalWidth = headers.reduce((sum, th) => sum + parseInt(th.style.width || 0), 0);

        const theadHTML = `<thead><tr>${headers.map(th => {
          const widthPercent = (parseInt(th.style.width || 0) / totalWidth) * 100 + '%';
          return `<th style="width:${widthPercent}">${th.innerHTML}</th>`;
        }).join('')}</tr></thead>`;

        // Normalizzazione TBODY
        const tbody = table.querySelector('tbody');
        const tbodyHTML = Array.from(tbody.querySelectorAll('tr')).map((tr, idx) => {
          const rowHTML = Array.from(tr.querySelectorAll('td')).map((td, tdIdx) => {
             // Utilizza la larghezza calcolata dall'intestazione per le celle
             const headerWidth = headers[tdIdx] ? parseInt(headers[tdIdx].style.width || 0) : 0;
             const widthPercent = (headerWidth / totalWidth) * 100 + '%';
             return `<td style="width:${widthPercent};padding:8px;text-align:center;border-bottom:1px solid #ddd;font-size:13px;word-wrap:break-word">${td.innerHTML}</td>`;
          }).join('');
          const bg = idx % 2 === 1 ? ' style="background:#f8f8f8"' : '';
          return `<tr${bg}>${rowHTML}</tr>`;
        }).join('');

        const normalizedHTML = `
          <div class="help">Classifica aggiornata automaticamente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
          <div style="overflow-x:auto">
            <table class="table" style="width:100%;border-collapse:collapse;table-layout:fixed;margin-top:8px">
              ${theadHTML}
              <tbody>${tbodyHTML}</tbody>
            </table>
          </div>
          <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
          <div id="classifica-next-run" class="help" style="margin-top:4px;"></div>
        `;

        classificaContent.innerHTML = normalizedHTML;

        // Salva cache
        await set(ref(db, 'classifica_cache'), {
          html: normalizedHTML,
          date: todayKey,
          timestamp: Date.now()
        });

      } catch (e) {
        console.error("Errore nel recupero della classifica:", e);
        try {
          const snap2 = await get(ref(db, 'classifica_cache'));
          const cache2 = snap2.val() || {};
          if (cache2.html) {
            classificaContent.innerHTML = cache2.html + '<div class="help" style="color:red;margin-top:8px">Errore nel recupero dati. Caricata la cache.</div>';
          } else {
            classificaContent.innerHTML = '<div class="help" style="color:red">Impossibile caricare i dati della classifica.</div>';
          }
        } catch (e2) {
          console.error("Errore nel caricamento della cache:", e2);
          classificaContent.innerHTML = '<div class="help" style="color:red">Impossibile caricare i dati della classifica.</div>';
        }
      }
    };

    // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
    document.addEventListener('DOMContentLoaded',()=>{
      // Login form handler
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin)
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Event Listeners per le Tab (Ricarica i dati)
      byId('rosa-tab')?.addEventListener('click', window.loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => window.loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', window.loadPrestazioniAggregato); // NUOVO: Carica Riepilogo & Lista Partite
      byId('video-tab')?.addEventListener('click', window.loadVideoList);
      byId('classifica-tab')?.addEventListener('click', window.loadClassifica); 

      // Default: Carico le sezioni pubbliche e mostro la rosa
      window.showPublicSection('rosa-section');
      window.loadRosa(); 
      window.loadProssimeGiornate(false); 
      window.loadStatistiche();
      window.loadClassifica();
      
      // Scheduler start
      if (typeof window.scheduleDailyClassificaRefresh === 'function') {
        window.scheduleDailyClassificaRefresh();
      }
    });

    // ... (Altre funzioni come loadRosa, candidati, loadCrudGiocatori, ecc. dal codice utente non mostrate qui per brevità ma presenti nel file originale)
    
    // placeholder per le funzioni non modificate e già presenti
    window.showFormazionePubblica = async () => {}; 
    window.candidati = async () => {}; 
    window.loadRosa = async () => {};
    window.showFormazioneForm = async () => {};
    window.showRisultatoForm = async () => {};
    window.loadCandidature = async () => {};
    window.loadCrudGiocatori = async () => {};
    window.loadCrudPartite = async () => {};
    window.showValutazioneForm = async () => {};
    window.loadPartitePerVideoAdmin = async () => {};
    window.loadVideoList = async () => {};
    window.saveVideoLink = async () => {};

  </script>
</head>
<body>
  <header>
    <div class="hero">
      <img src="https://via.placeholder.com/150/DA0000/FFD700?text=AC+TUSCOLANO" alt="Logo AC Tuscolano" />
      <div class="brand">
        <h1 class="club">AC TUSCOLANO</h1>
        <p class="tag">La passione, il gioco, l'amicizia.</p>
      </div>
      <button id="auth-toggle-btn" class="btn" onclick="handleAuthToggle()">Login</button>
    </div>
  </header>

  <nav>
    <div class="nav-wrap">
      <button class="tab" data-target="rosa-section" id="rosa-tab" onclick="showPublicSection('rosa-section')" aria-current="page">Rosa</button>
      <button class="tab" data-target="calendario-section" id="calendario-tab" onclick="showPublicSection('calendario-section')">Calendario</button>
      <button class="tab" data-target="classifica-section" id="classifica-tab" onclick="showPublicSection('classifica-section')">Classifica</button>
      <button class="tab" data-target="statistiche-section" id="statistiche-tab" onclick="showPublicSection('statistiche-section')">Prestazioni</button>
      <button class="tab" data-target="video-section" id="video-tab" onclick="showPublicSection('video-section')">Video</button>
    </div>
    <div id="admin-menu">
      <div class="nav-wrap">
        <button class="tab" data-admin-target="admin-inserimento-giocatori-section" onclick="showAdminSection('admin-inserimento-giocatori-section')">Ins. Giocatori</button>
        <button class="tab" data-admin-target="admin-inserimento-giornate-section" onclick="showAdminSection('admin-inserimento-giornate-section')">Ins. Partite</button>
        <button class="tab" data-admin-target="admin-calendario-section" onclick="showAdminSection('admin-calendario-section')">Gest. partite</button>
        <button class="tab" data-admin-target="admin-formazione-section" onclick="showAdminSection('admin-formazione-section')">Formazione & sostit.</button>
        <button class="tab" data-admin-target="admin-candidature-section" onclick="showAdminSection('admin-candidature-section')">Gest. Candidature</button>
        <button class="tab" data-admin-target="admin-gestione-dati-section" onclick="showAdminSection('admin-gestione-dati-section')">Gest. dati</button>
        <button class="tab" data-admin-target="admin-statistiche-section" onclick="showAdminSection('admin-statistiche-section')">Statistiche</button>
        <button class="tab" data-admin-target="admin-prestazioni-section" onclick="showAdminSection('admin-prestazioni-section')">Prestazioni</button>
        <button class="tab" data-admin-target="admin-video-section" onclick="showAdminSection('admin-video-section')">Ins. Video</button>
        <button class="tab" data-admin-target="admin-utenti-section" onclick="showAdminSection('admin-utenti-section')">Ins. utenti</button>
      </div>
    </div>
  </nav>

  <main>
    <section id="login-section" aria-live="polite"> 
      </section>
    
    <section id="rosa-section"> 
      <h2>Rosa</h2> <ul id="rosa-list" class="grid cols-2"></ul> 
    </section>
    
    <section id="calendario-section" style="display:none"> 
      <h2>Prossime giornate</h2> 
      <div class="help">Premi “Candidatura” per dare disponibilità. Se pubblicata, puoi vedere la formazione ufficiale. Ordinato dalla più recente.</div> 
      <ul id="calendario-list" class="grid cols-3"></ul> 
    </section>

    <section id="classifica-section" style="display:none"> 
      <h2>Classifica</h2> 
      <div id="classifica-content" style="overflow-x:auto;"> 
        <div class="help">Caricamento classifica in corso...</div>
      </div> 
    </section>

    <section id="statistiche-section" style="display:none">
      <div id="prest-agg-wrap">
        </div>
      <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--line);">
      <div id="statistiche-risultati-list" class="grid cols-3">
        </div>
    </section>
    
    <section id="prestazioni-partita-section" style="display:none">
        <h2 id="prestazioni-partita-meta">Dettaglio Prestazioni</h2>
        <div class="help">Prestazioni dei soli giocatori presenti nella partita selezionata.</div>
        <div id="prestazioni-partita-content">
            </div>
        <div class="actions" style="margin-top:10px;">
             <button class="btn" onclick="window.showPublicSection('statistiche-section')">Torna a Statistiche</button>
        </div>
    </section>

    <section id="formazione-pubblica-section" style="display:none">
      </section>

    <section id="video-section" style="display:none">
      </section>

    <section id="admin-inserimento-giocatori-section" style="display:none">
      </section>

    <section id="admin-inserimento-giornate-section" style="display:none">
      </section>

    <section id="admin-calendario-section" style="display:none">
      </section>

    <section id="admin-formazione-section" style="display:none">
      </section>

    <section id="admin-candidature-section" style="display:none">
      </section>

    <section id="admin-gestione-dati-section" style="display:none">
      </section>

    <section id="admin-statistiche-section" style="display:none"> 
      </section>
    
    <section id="admin-video-section" style="display:none">
      </section>
    
    <section id="admin-utenti-section" style="display:none">
      </section>

    <section id="admin-prestazioni-section" style="display:none">
      <h2>Admin · Gestione Prestazioni Partita</h2>
      <div class="help">Seleziona una partita conclusa per inserire, modificare o eliminare le prestazioni individuali dei giocatori presenti.</div>
      <label>Seleziona Partita</label>
      <select id="admin-prest-partita-select" onchange="window.adminCaricaPrestazioni()" style="max-width: none; margin-bottom: 12px;">
        <option value="">Caricamento...</option>
      </select>
      <div id="admin-prestazioni-wrap">
        <div class="help">Seleziona una partita per caricare il form.</div>
      </div>
    </section>

  </main>

  <div id="video-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 20px;">
    </div>

  <footer>
    @AC Tuscolano - Direttore Tecnico Aldo Sasso · Direttore Sportivo Danilo Solini · Presidente Davide Broglia
  </footer>
</body>
</html>
