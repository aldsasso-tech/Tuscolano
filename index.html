<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <script>
    /* ===== EFFETTO FADE NAVIGAZIONE (solo .content-section, fix visibilità completa) ===== */
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const target = tab.getAttribute('data-target');
          const current = document.querySelector('.content-section.active');
          const next = document.getElementById(target);
          if (!next || current === next) return;

          if (current) {
            current.style.opacity = '0';
            current.style.pointerEvents = 'none';
            setTimeout(() => {
              current.classList.remove('active');
              next.classList.add('active');
              next.style.opacity = '0';
              next.style.pointerEvents = 'all';
              setTimeout(() => { next.style.opacity = '1'; }, 50);
            }, 400);
          } else {
            next.classList.add('active');
            next.style.opacity = '1';
            next.style.pointerEvents = 'all';
          }

          // Aggiorna contenuto dinamico
          if (target === 'classifica-section' && typeof loadClassifica === 'function') {
            setTimeout(() => loadClassifica(), 600);
          }
        });
      });
      
      const firstSection = document.querySelector('.content-section') || document.querySelector('section');
      if (firstSection) firstSection.classList.add('active');
    });
  </script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
      
      /* NUOVE VARIABILI ESITO */
      --win-color: #4CAF50; /* Green */
      --loss-color: #F44336; /* Red */
      --draw-color: #9E9E9E; /* Gray */
      --bg-alpha: 0.1; /* Transparenza leggera per lo sfondo */
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }
    
    /* NUOVI STILI: Barre Voto */
    .voto-bar-container{
        background: #f0f0f0;
        border-radius: 8px;
        height: 8px;
        overflow: hidden;
        margin-top: 4px;
    }
    .voto-bar{
        height: 100%;
        transition: width var(--duration) var(--ease);
    }
    .voto-bar.red{ background-color: var(--red); }
    .voto-bar.yellow{ background-color: var(--yellow); }
    .voto-bar.green{ background-color: #0e7a0d; }


    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  
/* NUOVI STILI: Risultati Squadra */
#statistiche-risultati-list .card {
    position: relative;
    padding-left: 24px !important; /* Spazio per il bordo laterale */
    transition: background-color var(--duration) var(--ease);
    border-left: 6px solid transparent; /* Bordo laterale base */
}

/* Bordo Laterale e Sfondo Leggero per Vittoria */
.match-win {
    border-left-color: var(--win-color) !important;
    background-color: rgba(76, 175, 80, var(--bg-alpha)) !important; /* Verde leggero */
}
/* Bordo Laterale e Sfondo Leggero per Sconfitta */
.match-loss {
    border-left-color: var(--loss-color) !important;
    background-color: rgba(244, 67, 54, var(--bg-alpha)) !important; /* Rosso leggero */
}
/* Bordo Laterale e Sfondo Leggero per Pareggio */
.match-draw {
    border-left-color: var(--draw-color) !important;
    background-color: rgba(158, 158, 158, var(--bg-alpha)) !important; /* Grigio leggero */
}


/* === Effetti di transizione per le sezioni visibili (.content-section) === */
.content-section {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
}
.content-section.active {
  opacity: 1;
  pointer-events: all;
}


</style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; // Usato nella sezione admin-video-section

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section', 'prestazioni-partita-section', 'video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section', // Mantenuto per la logica di showFormazioneForm
      'admin-statistiche-section', // Mantenuta per il form "Risultato"
      'admin-prestazioni-partita-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section'
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; // Includo il login per nasconderlo

    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      ALL_SECTIONS.forEach(secId => { 
        const el = byId(secId); 
        if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
      });
      document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
      document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dall'admin
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); // Protezione base
        
        ALL_SECTIONS.forEach(secId => { 
          const el = byId(secId); 
          if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dal pubblico
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
            t.setAttribute('aria-current', t.dataset.adminTarget===id ? 'page' : 'false');
        });

        // Ricarica i dati specifici per la sezione admin (dal tuo codice originale)
        if(id==='admin-calendario-section'){ window.loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ loadCandidature(); }
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') loadPartitePerVideoAdmin(); 
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             // Se l'admin fa logout, torna alla sezione pubblica di default
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); // Nasconde il form di login dopo lo stato di auth
      toggleAdminUI(); // Aggiorna la UI
      
      // Assicura che una sezione sia visibile al cambio di stato
      if(user && isAdmin) {
         // Se admin loggato, mostra la sezione predefinita admin (es. inserimento giocatori)
         if(byId('admin-inserimento-giocatori-section').style.display === 'none'){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         // Se loggout o utente normale, mostra la sezione pubblica predefinita
         window.showPublicSection('rosa-section');
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          // Ricarica la sezione pubblica dopo il logout
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded',()=>{
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) – usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      window.showPublicSection('rosa-section');
      loadRosa(); 
      window.loadProssimeGiornate(false); // Carica calendario
      loadStatistiche(); // Carica solo risultati
      window.loadPrestazioniAggregato(); // Carica aggregato giocatori
      window.loadClassifica(); // Carica classifica da cache
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);

      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
      byId('rosa-tab')?.addEventListener('click', loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => window.loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', () => {
          loadStatistiche(); 
          window.loadPrestazioniAggregato();
      });
      byId('video-tab')?.addEventListener('click', loadVideoList);
      byId('classifica-tab')?.addEventListener('click', window.loadClassifica);
    });
    
    
    /**
     * NUOVA Funzione Classifica:
     * Legge SOLO dalla cache di Firebase.
     */
    window.loadClassifica = async () => {
      const classificaContent = byId('classifica-content');
      if (!classificaContent) return;
      classificaContent.innerHTML = `<div class="help">Caricamento classifica...</div>`;
      try {
        const snap = await get(ref(db, 'classifica_cache'));
        const cache = (snap.exists() && snap.val()) ? snap.val() : {};
        if (cache.html) {
          classificaContent.innerHTML = cache.html;
        } else {
          classificaContent.innerHTML = `<div class="help">Classifica non ancora disponibile. L'amministratore deve aggiornarla.</div>`;
        }
      } catch (e) {
        console.error("Errore caricamento classifica:", e);
        classificaContent.innerHTML = `<div class="help" style="color:red">Errore caricamento classifica.</div>`;
      }
    };

    /**
     * NUOVA Funzione Admin:
     * Aggiorna la classifica dal sito e la salva su Firebase.
     */
    window.updateClassificaFromSito = async () => {
      if (!isAdmin) return alert('Accesso negato. Solo gli amministratori possono aggiornare la classifica.');
      
      alert('Aggiornamento classifica in corso... Attendere prego.');

      try {
        const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
        const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
        const response = await fetch(proxy);
        const data = await response.json();

        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "text/html");

        const remoteTable = doc.querySelector(".table-responsive table, table.table, table");
        if (!remoteTable) {
          alert('Errore: Impossibile trovare la tabella della classifica sul sito remoto.');
          return;
        }

        // Riduci loghi
        remoteTable.querySelectorAll("img").forEach(img => {
          img.style.maxWidth = "25px";
          img.style.height = "auto";
          img.style.verticalAlign = "middle";
        });

        // Estrai intestazioni e righe
        const headerNodes = remoteTable.querySelectorAll("thead th");
        const headers = headerNodes.length ? Array.from(headerNodes).map(th => th.textContent.trim())
          : Array.from(remoteTable.querySelectorAll("tr:first-child th, tr:first-child td")).map(el => el.textContent.trim());

        const rows = remoteTable.querySelectorAll("tbody tr");
        const bodyRows = rows.length ? Array.from(rows) : Array.from(remoteTable.querySelectorAll("tr")).slice(1);

        // Calcola numero colonne e larghezze uniformi
        const colCount = headers.length || (bodyRows[0]?.children.length || 8);
        const widthPercent = (100 / colCount).toFixed(4) + '%';

        // Costruisci thead
        let theadHTML = '';
        if (headers.length) {
          theadHTML = '<thead><tr>' + headers.map(h => 
            `<th style="width:${widthPercent};padding:8px;text-align:center;border-bottom:2px solid #ccc;background:#8B0000;color:#fff;font-weight:600;font-size:14px;word-wrap:break-word">${h}</th>`
          ).join('') + '</tr></thead>';
        }

        // Costruisci tbody con celle uniformi
        const tbodyHTML = bodyRows.map((tr, idx) => {
          const cells = Array.from(tr.children);
          const rowHTML = cells.map(td => 
            `<td style="width:${widthPercent};padding:8px;text-align:center;border-bottom:1px solid #ddd;font-size:13px;word-wrap:break-word">${td.innerHTML}</td>`
          ).join('');
          const bg = idx % 2 === 1 ? ' style="background:#f8f8f8"' : '';
          return `<tr${bg}>${rowHTML}</tr>`;
        }).join('');

        const normalizedHTML = `
          <div class="help">Classifica aggiornata manualmente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
          <div style="overflow-x:auto">
            <table class="table" style="width:100%;border-collapse:collapse;table-layout:fixed;margin-top:8px">
              ${theadHTML}
              <tbody>${tbodyHTML}</tbody>
            </table>
          </div>
          <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
        `;

        // Salva cache
        await set(ref(db, 'classifica_cache'), {
          html: normalizedHTML,
          timestamp: Date.now()
        });

        // Aggiorna la vista
        await window.loadClassifica();
        alert('Classifica aggiornata con successo!');

      } catch (e) {
        console.error('Errore aggiornamento classifica:', e);
        alert('Errore durante l\'aggiornamento della classifica: ' + e.message);
      }
    };


    /* ===== NUOVE FUNZIONI VIDEO (INTEGRATE) ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; // Ferma la riproduzione
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); // Usa 'calendario' come il resto del tuo codice
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => {
          const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const dateA = toDate(partite[a].data);
          const dateB = toDate(partite[b].data);
          return dateB - dateA;
        });

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="window.openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    // Carica le partite per il menu a tendina Admin (solo quelle concluse)
    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // Aggiorna il campo input quando la partita selezionata cambia
    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    // Salva il link video nel database
    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");

      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");

      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;

        await update(ref(db), updates);

        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); // Aggiorna anche la sezione pubblica immediatamente
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Originali dell'Utente (Integrate) ===== */
    
    async function loadRosa(){
      const ul = byId('rosa-list'); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const val = snap.val() || {};
      const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      if(!rows.length){ ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>'; return; }
      ul.className='grid cols-2';
      rows.forEach(([id,g])=>{
        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
              <div class="player-sub">Ruolo: <b>${g.ruolo}</b> • Stato: <b>${g.stato}</b></div>
            </div>
          </div>`;
        ul.appendChild(li);
      });
    }

    /**
     * FUNZIONE loadProssimeGiornate (SPOSTATA QUI)
     * Include il pulsante "Prestazioni" (pubblico) e RIMUOVE "Valuta" (admin)
     * Layout pulsanti pubblici corretto (singola riga)
     */
    window.loadProssimeGiornate = async function(asAdmin){
      const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
      const ul = byId(listId); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'calendario'));
      const val = snap.val() || {};
      let entries = Object.entries(val);
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      const today = new Date(); today.setHours(0,0,0,0);
      entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
      if(!entries.length){ ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; return; }
      ul.className='grid cols-3';
      for(const [matchId,m] of entries){
        const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
        const cand = candSnap.val() || {};
        const candCount = Object.values(cand).filter(Boolean).length;
        const isPublished = m.formazionePubblicata === true;
        const matchDate = toDate(m.data);
        const isPast = matchDate < today;

        // Candidatura
        let candButton = '';
        if (isPast) {
          candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`;
        } else {
          candButton = `<button class="btn btn--accent" onclick="candidati('${matchId}')">Candidatura</button>`;
        }

        // Prestazioni: sempre mostrato. Attivo solo se partita passata con risultato valido.
        let prestazioniBtn = '';
        const risultatoValido = (m.risultato && m.risultato !== 'N/D');
        if (isPast && risultatoValido) {
          // Passa anche il nome avversaria alla funzione
          prestazioniBtn = `<button class="btn" onclick="showPrestazioniPubbliche('${matchId}','${escapeHtml(m.avversaria||'')}')">Prestazioni</button>`;
        } else {
          prestazioniBtn = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Prestazioni N/D</button>`;
        }
        
        // Formazione
        let formazioneBtn = '';
        if (isPublished) {
          formazioneBtn = `<button class="btn" onclick="showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria||'')}')">Formazione Ufficiale</button>`;
        } else if (isPast) {
           formazioneBtn = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Formazione conclusa</button>`;
        } else {
           formazioneBtn = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Formazione non pubblicata</button>`;
        }

        const li = document.createElement('li');
        li.className = 'card';
        li.innerHTML = `
          <div style="font-weight:700">${m.data} ${m.orario}</div>
          <div class="player-title">vs ${escapeHtml(m.avversaria||'Sconosciuta')}</div>
          <div class="player-sub">${escapeHtml(m.campo||'Campo N/D')}</div>
          ${risultatoValido ? `<div style="font-weight:700; margin-top:8px;">Risultato: ${m.risultato}</div>` : `<div class="help" style="margin-top:8px;">Risultato: N/D</div>`}
          <div class="help" style="margin-top:4px;">Disponibili: <b>${candCount}</b></div>
          <div class="row" style="margin-top:10px; justify-content:space-between">
              ${candButton}
              ${asAdmin ? 
                  `
                  <button class="btn btn--admin" onclick="showRisultatoPartitaForm('${matchId}','${escapeHtml(m.avversaria||'')}')">Risultato</button>
                  <button class="btn btn--admin" onclick="showValutazionePartitaForm('${matchId}','${escapeHtml(m.avversaria||'')}')">Valuta</button>
                  <button class="btn btn--admin" onclick="showFormazioneForm('${matchId}','${escapeHtml(m.avversaria||'')}')">Formazione</button>
                  <button class="btn btn--admin" onclick="showCandidatureEditor('${matchId}','${escapeHtml(m.avversaria||'')}')">Candidature</button>
                  ` 
                  : `
                  ${formazioneBtn}
                  ${prestazioniBtn}
                  `
              }
          </div>
        `;
        ul.appendChild(li);
      }
    }

    window.candidati = async(matchId)=>{ 
      const user = auth.currentUser; 
      if(!user){ 
        showLogin(); 
        alert('Per candidarti devi effettuare il login.'); 
        return; 
      } 
      await set(ref(db,`calendario/${matchId}/candidature/${user.uid}`), true); 
      alert('Disponibilità inviata.'); 
      window.loadProssimeGiornate(false); 
    }; 
    
    /** * FUNZIONE loadStatistiche (MODIFICATA) 
     * 1. Ordina dalla più recente alla più vecchia. 
     * 2. Inserisce l'esito e la classe CSS. 
     * 3. Aggiunge la colonna Esito (Vittoria/Sconfitta/Pareggio). 
     */ 
    async function loadStatistiche(){ 
      const rl = byId('statistiche-risultati-list'); 
      if(!rl) return;
      
      rl.innerHTML=''; 
      
      const snapCal = await get(ref(db,'calendario')); 
      const cal = snapCal.val()||{}; 
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); }; 
      
      // Ordina dalla più recente alla più vecchia e filtra solo quelle con risultato
      const rows = Object.entries(cal)
        .filter(([,m]) => m.risultato && m.risultato !== 'N/D')
        .sort((a,b)=> toDate(b[1].data)-toDate(a[1].data)); 
      
      if(!rows.length) {
          rl.innerHTML = '<div class="help">Ancora nessun risultato.</div>';
          return;
      }
    
      // Intestazione/Layout tabellare custom (ho aggiornato le colonne per includere Esito)
      let listHtml = `<li class="card" style="font-weight:700; background:var(--yellow); color:var(--ink); margin-bottom: 6px; display:flex; justify-content:space-between; padding: 10px 16px;"> 
          <div style="flex: 0 0 100px;">Data</div> 
          <div style="flex: 1;">Avversaria</div> 
          <div style="flex: 0 0 80px; text-align:center;">Risultato</div>
          <div style="flex: 0 0 120px; text-align:center;">Esito</div> 
          <div style="flex: 0 0 80px; text-align:center;">Pres.</div>
          <div style="flex: 0 0 80px; text-align:center;">G.F.</div>
          <div style="flex: 0 0 80px; text-align:center;">G.S.</div>
      </li>`;

      rows.forEach(([matchId,m])=>{
          const [scoreA, scoreB] = (m.risultato||'0-0').split('-').map(n=>parseInt(n.trim(),10));
          let esito = 'Pareggio';
          let esitoClass = 'match-draw';
          
          if(scoreA > scoreB){
              esito = 'Vittoria';
              esitoClass = 'match-win';
          } else if (scoreA < scoreB){
              esito = 'Sconfitta';
              esitoClass = 'match-loss';
          }
          
          listHtml += `
              <li class="card ${esitoClass}" style="margin-bottom: 6px; display:flex; justify-content:space-between; padding: 10px 16px;">
                  <div style="flex: 0 0 100px;">${escapeHtml(m.data||'')}</div>
                  <div style="flex: 1;">${escapeHtml(m.avversaria||'')}</div>
                  <div style="flex: 0 0 80px; font-weight:700; text-align:center;">${escapeHtml(m.risultato||'N/D')}</div>
                  <div style="flex: 0 0 120px; font-weight:700; text-align:center;">${esito}</div> 
                  <div style="flex: 0 0 80px; text-align:center;">${m.presenze||0}</div>
                  <div style="flex: 0 0 80px; text-align:center;">${m.goalFatti||0}</div>
                  <div style="flex: 0 0 80px; text-align:center;">${m.goalSubiti||0}</div>
              </li>
          `;
      });
      
      rl.innerHTML = listHtml;
      
      // Load aggregato giocatori (pre-esistente)
      window.loadPrestazioniAggregato(); 
    }
    
    /**
     * FUNZIONE loadPrestazioniAggregato (INTEGRATA)
     */
    window.loadPrestazioniAggregato = async function(){
        const content = byId('prestazioni-aggregate-content');
        if(!content) return;
        content.querySelector('.help').textContent = 'Calcolo in corso...';

        const [snapRosa, snapPrestazioni] = await Promise.all([
          get(ref(db,'rosa')),
          get(ref(db,'prestazioni'))
        ]);
        const rosa = snapRosa.val() || {};
        const prestazioni = snapPrestazioni.val() || {}; // {matchId: {playerId: {voto: x, goal: y}}}
        
        // 1. Aggrega i dati
        const agg = {};
        Object.keys(rosa).forEach(pid => {
            agg[pid] = { partite: 0, sommaVoti: 0, goal: 0 };
        });

        Object.keys(prestazioni).forEach(matchId => {
            Object.keys(prestazioni[matchId]).forEach(pid => {
                const rec = prestazioni[matchId][pid];
                if (!agg[pid]) return; // Giocatore non in rosa

                const voto = Number(rec.voto);
                const goal = Number(rec.goal || 0);

                // **CORREZIONE BUG**: Assicurati che il voto sia valido (non null e non NaN)
                if (!Number.isNaN(voto) && rec.voto !== null) {
                    agg[pid].partite += 1;
                    agg[pid].sommaVoti += voto;
                }
                agg[pid].goal += goal;
            });
        });

        // 2. Mappa su /rosa e ordina
        const rows = Object.entries(rosa).map(([pid, g]) => {
            const a = agg[pid] || {partite:0, sommaVoti:0, goal:0};
            const media = a.partite > 0 ? (a.sommaVoti / a.partite) : null;
            return {
                pid,
                nome: `${g.nome||''} ${g.cognome||''}`.trim(),
                numero: g.numero||'',
                partite: a.partite, // Partite con voto
                mediaVoto: media !== null ? Number(media.toFixed(2)) : null,
                goal: a.goal
            };
        }).sort((a,b)=> {
            // Ordina per media voto (decrescente), poi goal (decrescente)
            const am = a.mediaVoto===null ? -1 : a.mediaVoto;
            const bm = b.mediaVoto===null ? -1 : b.mediaVoto;
            if (bm !== am) return bm - am;
            if (b.goal !== a.goal) return b.goal - a.goal;
            return a.nome.localeCompare(b.nome);
        });

        // 3. Genera HTML
        let tableHtml = `<h3 style="margin-top:16px;">Riepilogo Giocatori</h3>
        <div class="help" style="margin-bottom:8px;">Media voti calcolata solo sulle partite in cui il voto è stato inserito.</div>
        <table class="table" style="width:100%"><thead><tr>
            <th style="width:50px">#</th>
            <th>Giocatore</th>
            <th style="width:100px; text-align:center;">Pres. (Voto)</th>
            <th style="width:120px; text-align:center;">Media Voto</th>
            <th style="width:60px; text-align:center;">Goal</th>
        </tr></thead><tbody>`;

        const rowsHtml = rows.map(r => {
            let mediaVotoDisplay = '—';
            let bar = '';
            if (r.mediaVoto !== null) {
                const votoNum = r.mediaVoto;
                mediaVotoDisplay = `<b>${votoNum.toFixed(2)}</b>`; 
                // Calcolo barra
                const perc = Math.max(0, Math.min(100, Math.round((votoNum/10)*100)));
                const color = (votoNum >= 7 ? 'green' : (votoNum >= 6 ? 'yellow' : 'red'));
                bar = `<div class="voto-bar-container"><div class="voto-bar ${color}" style="width:${perc}%"></div></div>`;
            }

            return `<tr>
                <td>${escapeHtml(r.numero)}</td>
                <td>${escapeHtml(r.nome)}</td>
                <td style="text-align:center">${r.partite}</td>
                <td style="text-align:center;">${mediaVotoDisplay}${bar}</td>
                <td style="text-align:center;"><b>${r.goal}</b></td>
            </tr>`;
        }).join('');

        tableHtml += rowsHtml + '</tbody></table>';

        content.innerHTML = tableHtml;
    };
    
    /**
     * FUNZIONE showFormazionePubblica (INTEGRATA)
     */
    window.showFormazionePubblica = async (matchId, avv) => {
      window.showPublicSection('formazione-pubblica-section');
      const content = byId('formazione-pubblica-content');
      content.innerHTML = 'Caricamento...';
      
      const [snapFormazioni, snapRosa] = await Promise.all([
        get(ref(db, `calendario/${matchId}/formazioni`)),
        get(ref(db, 'rosa'))
      ]);
      const formazioni = snapFormazioni.val() || {};
      const rosa = snapRosa.val() || {};
      
      if (Object.keys(formazioni).length === 0) {
        content.innerHTML = `<h3>Formazione vs ${escapeHtml(avv)}</h3><p>Formazione non ancora inserita o pubblicata.</p>`;
        return;
      }

      // Estrai la formazione iniziale (minuto 0)
      const titolari = formazioni['0']?.formazione || {};
      
      // Estrai le sostituzioni (le formazioni successive a 0)
      const sostituzioni = Object.entries(formazioni)
        .filter(([min]) => min !== '0')
        .map(([min, data]) => ({
          minuto: parseInt(min, 10),
          formazione: data.formazione,
          esce: data.esce,
          entra: data.entra
        }))
        .sort((a, b) => a.minuto - b.minuto);
        
      let html = [];
      html.push(`<h3>Formazione Ufficiale vs ${escapeHtml(avv)}</h3>`);
      
      // 1. Titolari iniziali
      html.push(`<h4>Titolari Iniziali</h4><div class="field">`);
      Object.entries(titolari).forEach(([ruolo, pid]) => {
        const pl = rosa[pid];
        const pos = POS_331[ruolo];
        if (pl && pos) {
          html.push(`<div class="marker" style="top:${pos.top}; left:${pos.left};"><b>${escapeHtml(pl.cognome)}</b><br>${ruolo}</div>`);
        }
      });
      html.push(`</div>`);
      
      // 2. Sostituzioni effettuate
      if (sostituzioni.length > 0) {
        html.push(`<h4>Sostituzioni Effettuate</h4><ul class="grid cols-2">`);
        sostituzioni.forEach(s => {
          // Trova nome giocatore
          const plEntra = rosa[s.entra];
          const plEsce = rosa[s.esce];
          html.push(`<li class="card"><div style="font-weight:700">Minuto ${s.minuto}</div>Entra: <b>${plEntra? plEntra.cognome:'?'}</b> • Esce: <b>${plEsce? plEsce.cognome:'?'}</b></li>`);
        });
        html.push(`</ul>`);
      }
      
      content.innerHTML = html.join('');
    };
    
    /**
     * FUNZIONE showPrestazioniPubbliche (INTEGRATA)
     */
    window.showPrestazioniPubbliche = async (matchId, avv) => {
      window.showPublicSection('prestazioni-partita-section');
      const content = byId('prestazioni-partita-content');
      content.innerHTML = 'Caricamento...';

      try {
        const [snapRosa, snapPrest, snapMatch] = await Promise.all([
          get(ref(db, 'rosa')),
          get(ref(db, `prestazioni/${matchId}`)),
          get(ref(db, `calendario/${matchId}`)),
        ]);
        const rosa = snapRosa.val() || {};
        const prestazioni = snapPrest.val() || {};
        const matchData = snapMatch.val() || {};

        const rows = Object.entries(prestazioni)
          .filter(([, data]) => data.voto !== null) // Filtra solo chi ha un voto
          .map(([pid, data]) => {
            const player = rosa[pid] || { nome: 'Giocatore', cognome: 'Sconosciuto', numero: '?' };
            return {
              nome: `${player.nome} ${player.cognome}`,
              numero: player.numero,
              voto: data.voto,
              goal: data.goal || 0
            };
          }).sort((a, b) => (b.voto - a.voto) || (b.goal - a.goal)); // Ordina per Voto (decrescente)

        if (rows.length === 0) {
          content.innerHTML = `<h3>vs ${escapeHtml(avv)}</h3><p>Nessuna prestazione inserita per questa partita.</p>`;
          return;
        }

        // Dati partita (Risultato, campo, ora)
        const matchInfo = `
            <div class="row" style="margin-bottom:12px;">
                <div class="pill">Risultato: ${matchData.risultato || 'N/D'}</div>
                <div class="pill">${matchData.data} ${matchData.orario}</div>
                <div class="pill">${matchData.campo}</div>
            </div>
        `;

        let tableHtml = `<table class="table"><thead><tr><th>#</th><th>Giocatore</th><th>Voto</th><th>Goal</th></tr></thead><tbody>`;
        rows.forEach(r => {
          tableHtml += `<tr><td>${r.numero}</td><td>${escapeHtml(r.nome)}</td><td><b>${r.voto}</b></td><td>${r.goal}</td></tr>`;
        });
        tableHtml += `</tbody></table>`;
        content.innerHTML = `<h3>vs ${escapeHtml(avv)}</h3>` + matchInfo + tableHtml;
      } catch (err) {
        console.error('Errore caricamento prestazioni partita:', err);
        content.innerHTML = `<h3>vs ${escapeHtml(avv)}</h3><p style="color:red">Impossibile caricare le prestazioni.</p>`;
      }
    };

    /* Posizioni modulo 3-3-1 */ 
    const POS_331 = { 
      'Portiere': { top:'90%', left:'50%' }, 
      'Difensore centrale': { top:'70%', left:'50%' }, 
      'Terzino sinistro': { top:'70%', left:'25%' }, 
      'Terzino destro': { top:'70%', left:'75%' }, 
      'Centrocampista centrale': { top:'45%', left:'50%' }, 
      'Centrocampista sinistro': { top:'45%', left:'25%' }, 
      'Centrocampista destro': { top:'45%', left:'75%' }, 
      'Attaccante centrale': { top:'15%', left:'50%' } 
    };

    /* ===== Admin: inserimenti base e funzioni di salvataggio (dal tuo codice) ===== */ 
    window.addPlayer = async (e)=>{ 
      e?.preventDefault(); 
      if(!isAdmin) return alert('Accesso negato.'); 
      const nome = v('giocatore-nome'); 
      const cognome = v('giocatore-cognome'); 
      const numero = parseInt(v('giocatore-numero')||'0',10); 
      const ruolo = v('giocatore-ruolo'); 
      const stato = v('giocatore-titolare'); 
      if(!nome||!cognome||!numero||!ruolo) return alert('Compila tutti i campi'); 
      // Rimosso 'voto:0','presenze:0','goal:0' // Questi dati ora derivano da 'prestazioni' o sono gestiti in 'Gestione Dati' 
      const row = {nome,cognome,numero,ruolo,stato}; 
      await set(push(ref(db,'rosa')),row); 
      alert('Giocatore inserito'); 
      byId('giocatore-form').reset(); 
      loadRosa(); 
    }; 
    
    window.addMatch = async (e)=>{ 
      e?.preventDefault(); 
      if(!isAdmin) return alert('Accesso negato.'); 
      const avversaria = v('match-avversaria'); 
      const data = v('match-data'); 
      const orario = v('match-orario'); 
      const campo = v('match-campo'); 
      const casa = v('match-casa'); 
      if(!avversaria||!data||!orario||!campo) return alert('Compila tutti i campi'); 
      const row = {avversaria,data,orario,campo,casa,risultato:'N/D',presenze:0,goalFatti:0,goalSubiti:0}; 
      await set(push(ref(db,'calendario')),row); 
      alert('Giornata inserita'); 
      byId('match-form').reset(); 
      window.loadProssimeGiornate(true); 
    };

    window.showRisultatoPartitaForm = async (matchId, avv) => {
        if(!isAdmin) return;
        window.showAdminSection('admin-statistiche-section');
        const box = byId('risultato-form-content');
        box.innerHTML = 'Caricamento...';
        
        try {
            const snap = await get(ref(db, `calendario/${matchId}`));
            const data = snap.val() || {};
            const [gf = 0, gs = 0] = (data.risultato || '0-0').split('-').map(n => parseInt(n.trim(), 10));

            box.innerHTML = `
                <h3>Risultato vs ${avv}</h3>
                <form id="risultato-save" onsubmit="saveRisultato(event, '${matchId}', '${avv}')">
                    <label>Goal Fatti (AC Tuscolano)</label>
                    <input type="number" id="risultato-gf" min="0" value="${gf}" required />
                    
                    <label>Goal Subiti</label>
                    <input type="number" id="risultato-gs" min="0" value="${gs}" required />
                    
                    <label>Presenze Totali</label>
                    <input type="number" id="risultato-presenze" min="0" value="${data.presenze || 0}" required />
                    
                    <label>Link Video (URL YouTube)</label>
                    <input type="url" id="risultato-video" value="${escapeHtml(data.linkVideo || '')}" placeholder="Opzionale" />
                    
                    <div class="actions">
                        <button class="btn btn--accent" type="submit">Salva Risultato e Dati</button>
                    </div>
                </form>
            `;
        } catch (e) {
            box.innerHTML = `<p style="color:red">Errore caricamento dati partita.</p>`;
            console.error(e);
        }
    };

    window.saveRisultato = async (e, matchId, avv) => {
        e.preventDefault();
        if(!isAdmin) return;
        
        const gf = parseInt(v('risultato-gf') || '0', 10);
        const gs = parseInt(v('risultato-gs') || '0', 10);
        const presenze = parseInt(v('risultato-presenze') || '0', 10);
        const linkVideo = v('risultato-video').trim();
        
        if (isNaN(gf) || isNaN(gs) || isNaN(presenze) || gf < 0 || gs < 0 || presenze < 0) {
            return alert("I valori inseriti per goal e presenze non sono validi.");
        }
        
        const risultato = `${gf}-${gs}`;
        const updates = {
            risultato: risultato,
            goalFatti: gf,
            goalSubiti: gs,
            presenze: presenze,
            linkVideo: linkVideo // Salva anche il link video da qui
        };

        try {
            await update(ref(db, `calendario/${matchId}`), updates);
            alert(`Risultato ${risultato} e dati per ${avv} salvati.`);
            window.loadProssimeGiornate(true);
            loadStatistiche();
            // Torna alla gestione dati (opzionale)
            window.showAdminSection('admin-calendario-section');
        } catch (e) {
            alert("Errore salvataggio risultato: " + e.message);
            console.error(e);
        }
    };

    // Costanti per la formazione
    const N_SLOTS = 8; // Titolari (3-3-1 + Portiere)
    const N_SOSTITUZIONI = 3; // Sostituzioni libere
    const PARTITA_DURATION = 50; // Durata totale partita in minuti

    window.showFormazioneForm = async (matchId,avv)=>{ 
        if(!isAdmin) return; 
        window.showAdminSection('admin-formazione-section'); 
        const box = byId('formazione-content'); 
        box.innerHTML='Caricamento...'; 
        
        const [snapRosa, snapCandidature, snapUtenti, snapMatch] = await Promise.all([ 
            get(ref(db,'rosa')), 
            get(ref(db,`calendario/${matchId}/candidature`)), 
            get(ref(db,'utenti')), 
            get(ref(db,`calendario/${matchId}`)) 
        ]); 
        
        const val = snapRosa.val()||{}; 
        const candidatureMap = snapCandidature.val()||{}; 
        const utentiMap = snapUtenti.val()||{}; 
        const matchData = snapMatch.val() || {}; 
        
        // La formazione è memorizzata sotto 'formazioni/0/formazione'
        const currentTitolari = matchData.formazioni?.['0']?.formazione || {}; 
        // La panchina è un array di id giocatori
        const currentPanchina = matchData.panchina || []; 
        
        const nameToUid = {}; 
        Object.entries(utentiMap).forEach(([uid,u])=>{ 
            if(u.nome&&u.cognome) nameToUid[`${u.nome} ${u.cognome}`]=uid; 
        }); 
        
        // 1. FILTRARE I GIOCATORI SOLO PER CHI HA DATO DISPONIBILITÀ 
        const availablePlayers = Object.entries(val).map(([id, g]) => { 
            const playerName = `${g.nome} ${g.cognome}`; 
            const uid = nameToUid[playerName]; 
            const isAvailable = uid && candidatureMap[uid] === true; 
            // Recupera 'presenze' da /rosa (come fallback o dato manuale) 
            const presenze = g.presenze || 0; 
            return { 
                id, uid, isAvailable, 
                nome:g.nome, cognome:g.cognome, 
                numero:g.numero, ruolo: g.ruolo, 
                presenze: presenze, 
                label: `${g.nome} ${g.cognome} (#${g.numero}) — ${presenze} pres.` 
            }; 
        }).filter(p => p.isAvailable) 
        .sort((a, b) => (a.presenze - b.presenze) || a.ruolo.localeCompare(b.ruolo)); 

        // Helper per generare le opzioni del select
        const opts = (selectedId) => {
            let options = '<option value="">Seleziona</option>';
            availablePlayers.forEach(p => {
                const selected = (p.id === selectedId) ? 'selected' : '';
                options += `<option value="${p.id}" ${selected}>${p.label}</option>`;
            });
            return options;
        };

        // Helper: raccoglie i giocatori titolari dal form (Mappa: Ruolo -> ID Giocatore)
        const collectTitolariMap = () => {
            const titolariMap = {};
            document.querySelectorAll('#titolari select[data-role="titolari"]').forEach(select => {
                const role = select.id.replace('t-', '');
                titolariMap[role] = select.value;
            });
            return titolariMap;
        };

        // Helper: raccoglie i giocatori in panchina dal form (Array di ID Giocatori)
        const collectPanchina = () => {
            const panchina = [];
            document.querySelectorAll('#panchina select[data-role="panchina"]').forEach(select => {
                if (select.value) {
                    panchina.push(select.value);
                }
            });
            return panchina;
        };

        // Funzione di calcolo e rendering delle sostituzioni
        const calculateSubstitutions = (panchinaIds) => {
            const N_Panchina = panchinaIds.length;
            const N_Tot = N_SLOTS + N_Panchina;
            const T_Player = (N_SLOTS * PARTITA_DURATION + N_Panchina * (PARTITA_DURATION / (N_SOSTITUZIONI + 1))) / N_Tot; // Formula da calcolare

            let subs = [];
            let currentPanchinaCount = 0;
            const subMinutes = [];

            // Calcola i minuti teorici di sostituzione
            for (let i = 1; i <= N_SOSTITUZIONI; i++) {
                subMinutes.push(Math.round(i * (PARTITA_DURATION / (N_SOSTITUZIONI + 1))));
            }

            for (let i = 1; i <= N_SOSTITUZIONI; i++) {
                const minuto = subMinutes[i - 1]; // Usa il minuto calcolato

                // Se non ci sono più riserve, non c'è sostituzione
                if (currentPanchinaCount >= N_Panchina) continue;

                // Trova il giocatore in panchina che entra (il primo disponibile)
                const entraId = panchinaIds[currentPanchinaCount];
                currentPanchinaCount++;
                
                // Cerca la sostituzione già salvata per questo minuto (se esiste)
                const savedSub = matchData.sostituzioni?.find(s => s.minuto === minuto) || {};
                
                // Aggiungi la sostituzione all'array
                subs.push({
                    minuto: minuto,
                    placeholder: `Sostituzione ${i}`,
                    entraId: `entra-${i}`,
                    esceId: `esce-${i}`,
                    entraPlayer: entraId, // ID del giocatore teorico in panchina
                    escePlayer: savedSub.esce || null, // ID del giocatore in campo che esce (se salvato)
                    savedEntra: savedSub.entra || null // ID del giocatore in panchina che entra (se salvato)
                });
            }

            return { subs, N_Tot, T_Player: T_Player.toFixed(2) };
        };

        const renderSubstitutionsUI = () => {
            const panchinaIds = collectPanchina().filter(Boolean);
            const titolariIds = Object.values(collectTitolariMap()).filter(Boolean);
            
            const subsContainer = byId('sostituzioni-container');
            subsContainer.innerHTML = '';
            
            if (panchinaIds.length === 0) {
                subsContainer.innerHTML = '<div class="help">Nessun giocatore in panchina. Impossibile calcolare le sostituzioni.</div>';
                return;
            }

            const { subs, N_Tot, T_Player } = calculateSubstitutions(panchinaIds);
            
            byId('calcoli-teorici').innerHTML = `
                <div class="card" style="margin-top:10px;">
                    <div class="row" style="justify-content: space-around;">
                        <div style="text-align:center;"><b>Giocatori Totali:</b> ${N_Tot}</div>
                        <div style="text-align:center;"><b>Titolari:</b> ${N_SLOTS}</div>
                        <div style="text-align:center;"><b>Riserve:</b> ${panchinaIds.length}</div>
                        <div style="text-align:center;"><b>T Minuti Teorici:</b> ${T_Player} min</div>
                    </div>
                </div>
                <div class="help" style="margin-top:10px;">
                    I minuti e i giocatori in entrata sono calcolati automaticamente in base ai giocatori in panchina, ma l'admin può selezionare chi entra e chi esce.
                    Giocatori in campo: ${titolariIds.length} / ${N_SLOTS}.
                </div>
            `;
            
            // Opzioni per 'ESCE' (solo i titolari selezionati)
            const titolariOptions = titolariIds.map(id => {
                const p = availablePlayers.find(x => x.id === id);
                return p ? `<option value="${id}">${p.label}</option>` : '';
            }).join('');
            
            // Opzioni per 'ENTRA' (solo i giocatori in panchina selezionati e nell'ordine corretto)
            const panchinaOptionsMap = panchinaIds.reduce((map, id, index) => {
                const p = availablePlayers.find(x => x.id === id);
                if (p) map[id] = `<option value="${id}">${p.label}</option>`;
                return map;
            }, {});

            subs.forEach((s, i) => {
                const panchinaPlayer = availablePlayers.find(x => x.id === s.entraPlayer);
                const panchinaPlayerLabel = panchinaPlayer ? panchinaPlayer.label : 'Giocatore N/D';
                
                // Opzioni Entra (per permettere di selezionare un'altra riserva se necessario)
                let entraSelOptions = panchinaIds.map(id => {
                    const selected = (s.savedEntra === id) ? 'selected' : (s.entraPlayer === id && !s.savedEntra) ? 'selected' : '';
                    const p = availablePlayers.find(x => x.id === id);
                    return p ? `<option value="${id}" ${selected}>${p.label}</option>` : '';
                }).join('');
                
                // Opzioni Esce (con preselezione se salvato)
                let esceSelOptions = `<option value="">Seleziona chi esce</option>` + titolariIds.map(id => {
                    const selected = (s.escePlayer === id) ? 'selected' : '';
                    const p = availablePlayers.find(x => x.id === id);
                    return p ? `<option value="${id}" ${selected}>${p.label}</option>` : '';
                }).join('');
                
                const row = document.createElement('div');
                row.className = 'card row';
                row.style.justifyContent = 'space-between';
                row.innerHTML = `
                    <div style="flex: 0 0 80px; font-weight:700;">Minuto ${s.minuto}</div>
                    <div style="flex: 0 0 45%"><label>Entra</label><select id="${s.entraId}" data-sub-key="entra" data-minuto="${s.minuto}" required>${entraSelOptions}</select></div>
                    <div style="flex: 0 0 45%"><label>Esce</label><select id="${s.esceId}" data-sub-key="esce" data-minuto="${s.minuto}" required>${esceSelOptions}</select></div>
                `;
                subsContainer.appendChild(row);
            });
        };

        function updatePreview(){ 
            const map = collectTitolariMap(); 
            const field = byId('preview-field'); 
            field.innerHTML=''; 
            Object.entries(map).forEach(([ruolo, pid])=>{ 
                const p = availablePlayers.find(x=>x.id===pid); 
                const pos = POS_331[ruolo]; 
                if(!p||!pos) return; 
                const mk = document.createElement('div'); 
                mk.className='marker'; 
                mk.style.top = pos.top; 
                mk.style.left = pos.left; 
                const cognome = p.cognome; 
                mk.innerHTML = `<b>${escapeHtml(cognome)}</b><br>${ruolo}`; 
                field.appendChild(mk); 
            }); 
        } 
        
        // --- Rendering HTML --- 
        const formationHTML = `
            <h3>Formazione e sostituzioni vs ${avv}</h3>
            <div class="help">Liste filtrate per <b>disponibilità</b> e ordinate per <b>presenze crescenti</b> (da /rosa).</div>
            
            <form id="formazione-save" onsubmit="saveFormation(event,'${matchId}','${avv}')">
                <h4>Titolari (${N_SLOTS})</h4>
                <div id="titolari" class="grid cols-3">
                    <div><label>Portiere</label><select data-role="titolari" id="t-Portiere" required>${opts(currentTitolari['Portiere'])}</select></div>
                    <div><label>Terzino sinistro</label><select data-role="titolari" id="t-Terzino sinistro" required>${opts(currentTitolari['Terzino sinistro'])}</select></div>
                    <div><label>Difensore centrale</label><select data-role="titolari" id="t-Difensore centrale" required>${opts(currentTitolari['Difensore centrale'])}</select></div>
                    <div><label>Terzino destro</label><select data-role="titolari" id="t-Terzino destro" required>${opts(currentTitolari['Terzino destro'])}</select></div>
                    <div><label>Centrocampista sinistro</label><select data-role="titolari" id="t-Centrocampista sinistro" required>${opts(currentTitolari['Centrocampista sinistro'])}</select></div>
                    <div><label>Centrocampista centrale</label><select data-role="titolari" id="t-Centrocampista centrale" required>${opts(currentTitolari['Centrocampista centrale'])}</select></div>
                    <div><label>Centrocampista destro</label><select data-role="titolari" id="t-Centrocampista destro" required>${opts(currentTitolari['Centrocampista destro'])}</select></div>
                    <div><label>Attaccante centrale</label><select data-role="titolari" id="t-Attaccante centrale" required>${opts(currentTitolari['Attaccante centrale'])}</select></div>
                </div>

                <h4 style="margin-top:20px;">Panchina (${availablePlayers.length - N_SLOTS} disponibili)</h4>
                <div id="panchina" class="grid cols-3">
                    <label>Riserva 1</label><select data-role="panchina" id="p-1">${opts(currentPanchina[0])}</select>
                    <label>Riserva 2</label><select data-role="panchina" id="p-2">${opts(currentPanchina[1])}</select>
                    <label>Riserva 3</label><select data-role="panchina" id="p-3">${opts(currentPanchina[2])}</select>
                    <label>Riserva 4</label><select data-role="panchina" id="p-4">${opts(currentPanchina[3])}</select>
                    <label>Riserva 5</label><select data-role="panchina" id="p-5">${opts(currentPanchina[4])}</select>
                </div>
                
                <h4 style="margin-top:20px;">Anteprima Campo (3-3-1)</h4>
                <div id="preview-field" class="field"></div>
                
                <h4 style="margin-top:20px;">Sostituzioni (${N_SOSTITUZIONI} disponibili)</h4>
                <div id="calcoli-teorici"></div>
                <div id="sostituzioni-container" class="grid cols-1" style="margin-top:10px; gap:8px;"></div>
                
                <div class="actions">
                    <button class="btn btn--accent" type="submit">Salva Formazione e Sostituzioni</button>
                    <button class="btn" type="button" onclick="visualizeAllFormations('${avv}',${JSON.stringify(matchData.formazioni || {})})">Visualizza Formazioni Salvate</button>
                    <label style="display:inline-block; margin-left:16px"><input type="checkbox" id="formazione-pubblica" ${matchData.formazionePubblicata?'checked':''}> Pubblica Formazione Ufficiale</label>
                </div>
            </form>
        `;
        
        box.innerHTML = formationHTML;

        // --- Inizializzazione e Event Listeners --- 
        updatePreview(); 
        renderSubstitutionsUI(); 
        
        // Event listeners per titolari e panchina per ricalcolare e renderizzare le sostituzioni 
        document.querySelectorAll('#titolari select, #panchina select').forEach(sel=>sel.addEventListener('change',()=>{ 
            const titolariIds = Object.values(collectTitolariMap()).filter(Boolean); 
            const panchinaIds = collectPanchina().filter(Boolean); 
            const allSelected = [...titolariIds, ...panchinaIds]; 
            
            // Verifica duplicati (logica di validazione client-side) 
            const uniqueSet = new Set(allSelected); 
            if (allSelected.length !== uniqueSet.size) { 
                alert("Attenzione: un giocatore è stato selezionato più volte (titolare e/o riserva). Correggi la selezione prima di procedere."); 
            } 
            
            updatePreview(); 
            renderSubstitutionsUI(); 
        })); 

        // --- Logica di Salvataggio aggiornata --- 
        window.saveFormation = async (e,matchId,avv)=>{ 
            e.preventDefault(); 
            const tit = collectTitolariMap(); 
            const panchina = collectPanchina(); 
            
            // 1. Validazione Titolari 
            for(const val of Object.values(tit)){ 
                if(!val) return alert('Completa tutti gli 8 titolari.'); 
            } 
            
            // 2. Raccogli Sostituzioni dal form 
            const customSubs = [];
            const panchinaSelections = new Set(panchina); // Giocatori in panchina
            const titolariSelections = new Set(Object.values(tit)); // Giocatori titolari
            
            // La panchina deve essere composta da giocatori non titolari
            if(panchina.some(pid => titolariSelections.has(pid))){
                return alert("Errore: un giocatore è in panchina e titolare.");
            }

            // Raccoglie i dati delle sostituzioni inseriti dall'admin
            document.querySelectorAll('#sostituzioni-container .card').forEach(row => {
                const entraSelect = row.querySelector('select[data-sub-key="entra"]');
                const esceSelect = row.querySelector('select[data-sub-key="esce"]');
                const minuto = parseInt(entraSelect.dataset.minuto, 10);
                
                const entraId = entraSelect.value;
                const esceId = esceSelect.value;
                
                if(!entraId || !esceId) return alert('Completa tutte le sostituzioni');

                // Validazione logica sostituzione
                if (!panchinaSelections.has(entraId)) {
                    return alert(`Errore nella sostituzione al minuto ${minuto}: Il giocatore che entra (ID: ${entraId}) non è stato selezionato in panchina.`);
                }
                if (!titolariSelections.has(esceId)) {
                    return alert(`Errore nella sostituzione al minuto ${minuto}: Il giocatore che esce (ID: ${esceId}) non è un titolare.`);
                }
                
                customSubs.push({
                    minuto,
                    entra: entraId,
                    esce: esceId
                });
            });

            // 3. Calcola mappe di formazione per ogni minuto di sostituzione
            let currentFormation = {...tit};
            const formazioniMappe = { '0': { formazione: {...tit}, esce: null, entra: null } };
            
            const allSubs = [...customSubs].sort((a,b)=>a.minuto - b.minuto);
            
            allSubs.forEach(s => {
                const newFormation = {...currentFormation};
                
                // Rimuovi chi esce e inserisci chi entra (aggiornando il ruolo di chi esce con chi entra)
                let esceRuolo = null;
                for(const [ruolo, pid] of Object.entries(newFormation)){
                    if(pid === s.esce){
                        esceRuolo = ruolo;
                        break;
                    }
                }
                
                if (esceRuolo) {
                    newFormation[esceRuolo] = s.entra; // Sostituzione per ruolo
                    formazioniMappe[s.minuto] = { 
                        formazione: newFormation, 
                        esce: s.esce, 
                        entra: s.entra 
                    };
                    currentFormation = newFormation;
                } else {
                    console.error("Giocatore uscente non trovato in formazione:", s.esce);
                }
            });


            // 4. Salvataggio su Firebase
            const isPubblica = byId('formazione-pubblica')?.checked || false;
            
            const updates = {
                [`calendario/${matchId}/formazioni`]: formazioniMappe,
                [`calendario/${matchId}/panchina`]: panchina,
                [`calendario/${matchId}/sostituzioni`]: allSubs,
                [`calendario/${matchId}/formazionePubblicata`]: isPubblica,
            };
            
            try{
                await update(ref(db), updates);

                // Aggiorna la lista di presenze per i giocatori coinvolti
                const allSelected = [...Object.values(tit), ...panchina];
                await incrementPresenzeInRosa(allSelected);
                
                alert('Formazione salvata e presenze aggiornate!'); 
                window.loadProssimeGiornate(false); 
                visualizeAllFormations(avv,formazioniMappe); 

            } catch(e) {
                alert('Errore salvataggio: '+e.message);
            }
        };

        // Visualizza formazioni salvate (se ci sono)
        if(Object.keys(matchData.formazioni || {}).length > 0){
             visualizeAllFormations(avv,matchData.formazioni);
        }
    }; 
    
    // Funzione per visualizzare tutte le formazioni (pre-esistente) 
    function visualizeAllFormations(avv,formazioni){ 
      const out = document.createElement('div'); 
      out.innerHTML = `<h3>${Object.keys(formazioni).length} formazioni vs ${avv}</h3><div class="help">Titolare (0’) + mappe dopo ogni sostituzione.</div>`; 
      const wrap = document.createElement('div'); 
      wrap.className='grid cols-3'; 
      out.appendChild(wrap); 
      get(ref(db,'rosa')).then(s=>{ 
        const allPlayers = s.val()||{}; 
        Object.keys(formazioni).forEach(min=>{ 
          const pane = document.createElement('div'); 
          pane.className='card'; 
          pane.innerHTML = `<div style="font-weight:800;margin-bottom:6px">Minuto ${min}${min==='0'?' (Titolare)':''}</div><div class="field"></div>`; 
          wrap.appendChild(pane); 
          const field = pane.querySelector('.field'); 
          const f = formazioni[min].formazione; 
          Object.entries(f).forEach(([ruolo,pid])=>{ 
            const pl = allPlayers[pid]; 
            const pos = POS_331[ruolo]; 
            if(!pl||!pos) return; 
            const mk = document.createElement('div'); 
            mk.className='marker'; 
            mk.style.top=pos.top; 
            mk.style.left=pos.left; 
            mk.innerHTML = `<b>${escapeHtml(pl.cognome)}</b><br>${ruolo}`; 
            field.appendChild(mk); 
          }); 
        }); 
      }); 
      const box = byId('formazione-content'); 
      box.innerHTML=''; 
      box.appendChild(out); 
    } 
    
    // Helper: incremento presenze multiplo (in /rosa) 
    async function incrementPresenzeInRosa(playerIdsSet){ 
      const presenti = new Set(playerIdsSet); // Assicura unicità 
      if(presenti.size === 0) return; 
      const snap = await get(ref(db,'rosa')); 
      const rosa = snap.val() || {}; 
      const updates = {}; 
      presenti.forEach(pid => { 
        const g = rosa[pid]; 
        if(g){ 
          updates[`/rosa/${pid}/presenze`] = (g.presenze || 0) + 1; 
        } 
      }); 
      if(Object.keys(updates).length){ 
        await update(ref(db), updates); 
      } 
    } 
    
    // Admin: visualizzazione candidature compatta 
    async function loadCandidature(){ 
      if(!isAdmin) return; 
      const ul = byId('candidature-list'); 
      if(!ul) return; 
      ul.innerHTML = '<li>Caricamento...</li>';

      try{
          const [snapCal, snapUtenti] = await Promise.all([
              get(ref(db, 'calendario')),
              get(ref(db, 'utenti'))
          ]);
          const cal = snapCal.val() || {};
          const utenti = snapUtenti.val() || {};
          
          let html = '';

          // Mappa UID -> Nome Cognome
          const uidToName = {};
          Object.entries(utenti).forEach(([uid, u]) => {
              uidToName[uid] = `${u.nome || ''} ${u.cognome || ''}`.trim();
          });

          // Ordina le partite dalla più recente
          const toDate = (d) => { const [dd, mm, yyyy] = String(d || '').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const partiteOrdinate = Object.entries(cal)
              .sort((a, b) => toDate(b[1].data) - toDate(a[1].data));

          partiteOrdinate.forEach(([matchId, m]) => {
              const candidature = m.candidature || {};
              const disponibiliUids = Object.keys(candidature).filter(uid => candidature[uid] === true);
              
              if (disponibiliUids.length > 0) {
                  const dataOra = `${m.data || 'N/D'} ${m.orario || ''}`;
                  const avversaria = escapeHtml(m.avversaria || 'Sconosciuta');
                  
                  const nomiDisponibili = disponibiliUids
                      .map(uid => uidToName[uid] || uid)
                      .join(', ');

                  html += `
                      <li class="card">
                          <div style="font-weight:700">vs ${avversaria} (${dataOra})</div>
                          <div class="player-sub">Disponibili (${disponibiliUids.length}):</div>
                          <p style="font-size:0.9rem; margin: 4px 0 0 0;">${nomiDisponibili}</p>
                          <button class="btn btn--admin" style="margin-top:8px;" onclick="showCandidatureEditor('${matchId}','${avversaria}')">Modifica Dettagli</button>
                      </li>
                  `;
              }
          });

          ul.innerHTML = html || '<div class="help">Nessuna candidatura inviata.</div>';

      } catch(err){
          console.error("Errore caricamento candidature:", err);
          ul.innerHTML = '<li>Errore durante il caricamento delle candidature.</li>';
      }
    }

    window.crudSaveGiocatore = async (id)=>{ 
        if(!isAdmin) return; 
        const sels = document.querySelectorAll(`[data-gi="${id}"]`); 
        const upd = {}; 
        sels.forEach(i => { 
            const k=i.getAttribute('data-k'); 
            let val=i.value; 
            if(['numero','presenze'].includes(k)) val=+val||0; 
            upd[k]=val; 
        }); 
        await update(ref(db,'rosa/'+id),upd); 
        alert('Salvato.'); 
        loadRosa(); 
    }; 

    window.crudDeleteGiocatore = async (id)=>{ 
        if(!isAdmin) return; 
        if(!confirm('Eliminare questo giocatore?')) return; 
        await remove(ref(db,'rosa/'+id)); 
        alert('Eliminato.'); 
        window.loadCrudGiocatori(); 
        loadRosa(); 
    }; 
    
    window.loadCrudGiocatori = async ()=>{ 
      const body = byId('crud-giocatori-body'); 
      body.innerHTML=''; 
      const snap = await get(ref(db,'rosa')); 
      const data = snap.val()||{}; 
      const rows = Object.entries(data).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0)); 
      
      for(const [id,g] of rows){ 
          const tr = document.createElement('tr'); 
          tr.innerHTML = ` 
              <td><input data-gi="${id}" data-k="nome" value="${escapeHtml(g.nome||'')}" /></td> 
              <td><input data-gi="${id}" data-k="cognome" value="${escapeHtml(g.cognome||'')}" /></td> 
              <td><input data-gi="${id}" data-k="numero" type="number" min="1" max="99" value="${g.numero||''}" style="width:70px" /></td> 
              <td> 
                  <select data-gi="${id}" data-k="ruolo"> 
                      ${['Portiere','Terzino sinistro','Terzino destro','Difensore centrale','Centrocampista centrale','Centrocampista sinistro','Centrocampista destro','Attaccante centrale'] .map(r=>`<option ${g.ruolo===r?'selected':''}>${r}</option>`).join('')} 
                  </select> 
              </td> 
              <td> 
                  <select data-gi="${id}" data-k="stato"> 
                      ${['Titolare','Riserva'].map(s=>`<option ${g.stato===s?'selected':''}>${s}</option>`).join('')} 
                  </select> 
              </td> 
              <td><input data-gi="${id}" data-k="presenze" type="number" value="${g.presenze||0}" style="width:70px" /></td> 
              <td class="row" style="gap:6px"> 
                  <button class="btn btn--admin" onclick="crudSaveGiocatore('${id}')">Salva</button> 
                  <button class="btn" onclick="crudDeleteGiocatore('${id}')">Elimina</button> 
              </td>`; 
          body.appendChild(tr); 
      } 
    }; 

    window.loadCrudPartite = async ()=>{ 
      const body = byId('crud-partite-body'); 
      body.innerHTML=''; 
      const snap = await get(ref(db,'calendario')); 
      const data = snap.val()||{}; 
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); }; 
      const rows = Object.entries(data).sort((a,b)=> toDate(b[1].data)-toDate(a[1].data)); 
      
      for(const [id,m] of rows){ 
          const tr = document.createElement('tr'); 
          const risultato = m.risultato || 'N/D';
          const isPubblicata = m.formazionePubblicata ? 'Si' : 'No';
          
          tr.innerHTML = ` 
              <td><input data-partita="${id}" data-k="avversaria" value="${escapeHtml(m.avversaria||'')}" /></td> 
              <td><input data-partita="${id}" data-k="data" value="${m.data||''}" style="width:100px" /></td> 
              <td><input data-partita="${id}" data-k="orario" value="${m.orario||''}" style="width:80px" /></td> 
              <td><input data-partita="${id}" data-k="campo" value="${escapeHtml(m.campo||'')}" /></td> 
              <td><select data-partita="${id}" data-k="casa"><option value="Casa" ${m.casa==='Casa'?'selected':''}>Casa</option><option value="Trasferta" ${m.casa==='Trasferta'?'selected':''}>Trasferta</option></select></td> 
              <td style="text-align:center">${risultato}</td>
              <td style="text-align:center">${isPubblicata}</td>
              <td class="row" style="gap:6px"> 
                  <button class="btn btn--admin" onclick="crudSavePartita('${id}')">Salva</button> 
                  <button class="btn" onclick="crudDeletePartita('${id}')">Elimina</button> 
              </td>`; 
          body.appendChild(tr); 
      } 
    };

    window.crudSavePartita = async (id)=>{ 
        if(!isAdmin) return; 
        const sels = document.querySelectorAll(`[data-partita="${id}"]`); 
        const upd = {}; 
        sels.forEach(i => { 
            const k=i.getAttribute('data-k'); 
            upd[k]=i.value; 
        }); 
        await update(ref(db,'calendario/'+id),upd); 
        alert('Salvato.'); 
        window.loadCrudPartite(); 
        window.loadProssimeGiornate(true);
        window.loadProssimeGiornate(false); // Aggiorna entrambe le viste
    }; 
    
    window.crudDeletePartita = async (id)=>{ 
        if(!isAdmin) return; 
        if(!confirm('Eliminare questa partita (e tutti i dati associati come formazioni, candidature e prestazioni)?')) return; 
        // 1. Elimina calendario
        await remove(ref(db,'calendario/'+id)); 
        // 2. Elimina prestazioni associate
        await remove(ref(db,'prestazioni/'+id)); 
        
        alert('Partita eliminata.'); 
        window.loadCrudPartite(); 
        window.loadProssimeGiornate(true);
        window.loadProssimeGiornate(false);
    };

    window.showCandidatureEditor = async (matchId, avv) => {
        if(!isAdmin) return;
        document.getElementById('crud-giocatori').style.display='none';
        document.getElementById('crud-partite').style.display='none';
        document.getElementById('crud-candidature').style.display='block';
        document.getElementById('crud-candidature-panel').style.display='block';

        const title = byId('crud-candidature-title');
        title.textContent = `Gestione Candidature vs ${avv}`;
        
        const tbody = byId('crud-candidature-body');
        tbody.innerHTML = '<tr><td colspan="3">Caricamento...</td></tr>';
        
        const [snapRosa, snapCand, snapUtenti] = await Promise.all([
            get(ref(db,'rosa')),
            get(ref(db,`calendario/${matchId}/candidature`)),
            get(ref(db,'utenti'))
        ]);
        
        const rosa = snapRosa.val()||{}; 
        const cand = snapCand.val()||{}; // candidati attuali
        const utenti = snapUtenti.val()||{}; 
        
        // mappa nome cognome -> uid (se registrato) 
        const nameToUid = {}; 
        Object.entries(utenti).forEach(([uid,u])=>{ 
            if(u.nome&&u.cognome) nameToUid[`${u.nome} ${u.cognome}`]=uid; 
        }); 
        
        // Mappa i giocatori della rosa, cercando l'UID associato
        const rows = Object.entries(rosa).map(([pid,g])=>{ 
            const display = `${g.nome} ${g.cognome} (#${g.numero})`; 
            // Cerca l'UID del giocatore, assumendo che nome e cognome siano unici e mappati
            let uid = null;
            for (const [uId, u] of Object.entries(utenti)) {
                if (u.nome === g.nome && u.cognome === g.cognome) {
                    uid = uId;
                    break;
                }
            }
            const checked = uid ? !!cand[uid] : false; 
            return {pid, display, uid, checked}; 
        }).sort((a,b)=> a.display.localeCompare(b.display,'it')); 
        
        tbody.innerHTML = ''; 
        for(const r of rows){ 
            const tr = document.createElement('tr'); 
            tr.innerHTML = ` 
                <td>${escapeHtml(r.display)}</td> 
                <td>${r.uid ? r.uid : '<span class="help">Nessun utente collegato</span>'}</td> 
                <td><input type="checkbox" ${r.checked?'checked':''} data-cand="${r.uid||''}" ${r.uid?'':'disabled'} /></td>`; 
            tbody.appendChild(tr); 
        } 
        
        // Aggancia il pulsante Salva 
        const saveBtn = byId('crud-candidature-save'); 
        saveBtn.onclick = async ()=>{ 
            if(!isAdmin) return; 
            const inputs = tbody.querySelectorAll('input[type="checkbox"][data-cand]'); 
            const updates = {}; 
            inputs.forEach(chk=>{ 
                const uid = chk.getAttribute('data-cand'); 
                if(!uid) return; 
                updates[`/calendario/${matchId}/candidature/${uid}`] = chk.checked; 
            }); 
            
            await update(ref(db), updates); 
            alert('Candidature aggiornate.'); 
            window.loadProssimeGiornate(true); 
            window.loadProssimeGiornate(false); 
        }; 
    }; 

    window.closeCandidatureEditor = ()=>{ 
        byId('crud-candidature-panel').style.display='none'; 
        byId('crud-candidature').style.display='none'; 
        byId('crud-partite').style.display='block'; 
    }; 

    /* ===== NUOVE FUNZIONI ADMIN: GESTIONE PRESTAZIONI PARTITA ===== */ 
    window.showValutazionePartitaForm = async (matchId, avv) => { 
        if(!isAdmin) return; 
        window.showAdminSection('admin-prestazioni-partita-section');
        const box = byId('prestazioni-form-content');
        box.innerHTML = 'Caricamento...';
        
        try {
            const [snapRosa, snapPrest, snapCal] = await Promise.all([
                get(ref(db, 'rosa')),
                get(ref(db, `prestazioni/${matchId}`)),
                get(ref(db, `calendario/${matchId}`))
            ]);
            
            const rosa = snapRosa.val() || {};
            const prestazioni = snapPrest.val() || {};
            const matchData = snapCal.val() || {};
            
            if (!matchData.risultato || matchData.risultato === 'N/D') {
                box.innerHTML = `<h3>Valutazioni vs ${avv}</h3><p style="color:red">Impossibile inserire le prestazioni: il risultato della partita non è ancora stato inserito.</p>`;
                return;
            }
            
            // Filtra solo i giocatori attivi
            const rows = Object.entries(rosa)
                .sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
                
            let tableHtml = `
                <h3>Valutazioni vs ${avv} - Risultato: ${matchData.risultato}</h3>
                <form id="prestazioni-form" onsubmit="saveValutazionePartita(event, '${matchId}')">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Giocatore</th>
                            <th>Ruolo</th>
                            <th style="width:100px;">Voto (1-10)</th>
                            <th style="width:80px;">Goal</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rows.forEach(([pid, g]) => {
                const currentPrest = prestazioni[pid] || {};
                const voto = currentPrest.voto === null ? '' : (currentPrest.voto || ''); // 'null' o 0 per voto non dato
                const goal = currentPrest.goal || 0;
                
                tableHtml += `
                    <tr>
                        <td>${g.numero}</td>
                        <td>${escapeHtml(g.nome)} ${escapeHtml(g.cognome)}</td>
                        <td>${g.ruolo}</td>
                        <td><input data-pid="${pid}" data-key="voto" type="number" min="1" max="10" step="0.5" value="${voto}" placeholder="N/D" /></td>
                        <td><input data-pid="${pid}" data-key="goal" type="number" min="0" value="${goal}" /></td>
                    </tr>
                `;
            });
            
            tableHtml += `</tbody></table>
                <div class="actions">
                    <button class="btn btn--accent" type="submit">Salva Valutazioni</button>
                </div>
                </form>
            `;
            
            box.innerHTML = tableHtml;
            
        } catch (e) {
            box.innerHTML = `<p style="color:red">Errore caricamento dati per valutazioni.</p>`;
            console.error(e);
        }
    };

    window.saveValutazionePartita = async (e, matchId) => { 
        e.preventDefault(); 
        if(!isAdmin) return; 
        
        const inputs = byId('prestazioni-form').querySelectorAll('input[data-pid]'); 
        const updates = {}; 
        
        inputs.forEach(input => { 
            const pid = input.dataset.pid; 
            const key = input.dataset.key; 
            if (!pid || !key) return; 
            
            if (!updates[pid]) updates[pid] = {}; 
            
            let value; 
            if (key === 'voto') { 
                value = (input.value === '') ? null : Number(input.value); // Salva '' come null 
            } else { 
                value = Number(input.value || 0); // Salva '' o 0 come 0 
            } 
            
            updates[pid][key] = (isNaN(value) && value !== null) ? (key === 'voto' ? null : 0) : value; 
        }); 
        
        const finalUpdates = {}; 
        // Filtra i giocatori che hanno almeno un dato (voto o goal) 
        Object.entries(updates).forEach(([pid, data]) => { 
            // Salva se il voto è null (non dato) O è un numero, 
            // E i goal sono un numero (incluso 0) 
            if ((data.voto === null || typeof data.voto === 'number') && typeof data.goal === 'number') { 
                finalUpdates[pid] = data; 
            } 
        }); 
        
        try { 
            await set(ref(db, `prestazioni/${matchId}`), finalUpdates); 
            alert('Valutazioni salvate con successo!'); 
            window.showAdminSection('admin-gestione-dati-section'); 
            // Aggiorna l'aggregato in background 
            window.loadPrestazioniAggregato(); 
        } catch (err) { 
            alert('Errore salvataggio: ' + err.message); 
            console.error(err); 
        } 
    }; 
</script>
</head>
<body>
  <header>
    <div class="hero" role="banner">
      <img src="Logo.png" alt="Logo AC Tuscolano" />
      <div class="brand">
        <h1 class="club">AC Tuscolano</h1>
        <p class="tag">Football Club</p>
      </div>
    </div>
  </header>
  
  <nav aria-label="Navigazione principale">
    <div class="nav-wrap">
      <button id="rosa-tab" class="tab" data-target="rosa-section" aria-current="page" onclick="showPublicSection('rosa-section')">La nostra Rosa</button>
      <button id="calendario-tab" class="tab" data-target="calendario-section" onclick="showPublicSection('calendario-section')">Calendario & Partite</button>
      <button id="classifica-tab" class="tab" data-target="classifica-section" onclick="showPublicSection('classifica-section')">Classifica</button>
      <button id="statistiche-tab" class="tab" data-target="statistiche-section" onclick="showPublicSection('statistiche-section')">Prestazioni</button>
      <button id="video-tab" class="tab" data-target="video-section" onclick="showPublicSection('video-section')">Video</button>
      
      <button id="auth-toggle-btn" class="btn" onclick="handleAuthToggle()">Login</button>
    </div>
  </nav>

  <div id="admin-menu">
    <div class="nav-wrap">
      <button class="tab" data-admin-target="admin-inserimento-giocatori-section" onclick="showAdminSection('admin-inserimento-giocatori-section')">Aggiungi Giocatore</button>
      <button class="tab" data-admin-target="admin-inserimento-giornate-section" onclick="showAdminSection('admin-inserimento-giornate-section')">Aggiungi Partita</button>
      <button class="tab" data-admin-target="admin-calendario-section" onclick="showAdminSection('admin-calendario-section')">Calendario (Admin)</button>
      <button class="tab" data-admin-target="admin-candidature-section" onclick="showAdminSection('admin-candidature-section')">Candidature</button>
      <button class="tab" data-admin-target="admin-gestione-dati-section" onclick="showAdminSection('admin-gestione-dati-section')">Gestione Dati</button>
      <button class="tab" data-admin-target="admin-video-section" onclick="showAdminSection('admin-video-section')">Gestione Video</button>
      <button class="tab" data-admin-target="admin-utenti-section" onclick="showAdminSection('admin-utenti-section')">Utenti</button>
    </div>
  </div>

  <main>
    <section id="login-section">
      <h2>Login Amministratore</h2>
      <form id="login-form">
        <label>Email</label><input id="login-email" type="email" required />
        <label>Password</label><input id="login-password" type="password" required />
        <div class="actions"><button class="btn btn--accent" type="submit">Accedi</button></div>
      </form>
      <div class="help" style="margin-top:10px">Effettua il login per accedere all’area Admin.</div>
    </section>

    <section id="rosa-section">
      <h2>Rosa</h2>
      <ul id="rosa-list" class="grid cols-2"></ul>
    </section>

    <section id="calendario-section" style="display:none">
      <h2>Prossime giornate</h2>
      <div class="help">Premi “Candidatura” per dare disponibilità. Se pubblicata, puoi vedere la formazione ufficiale. Ordinato dalla più recente.</div>
      <ul id="calendario-list" class="grid cols-3"></ul>
    </section>

    <section id="classifica-section" style="display:none">
      <h2>Classifica</h2>
      <div id="classifica-content" style="overflow-x:auto;"> 
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn" onclick="window.loadClassifica()">Ricarica Classifica</button>
      </div>
    </section>

    <section id="statistiche-section" style="display:none">
      <h2>Prestazioni</h2>
      <h3>Risultati squadra</h3>
      <div class="help">Lista ordinata dalla partita più recente.</div>
      <ul id="statistiche-risultati-list"> 
      </ul>
      <div id="prestazioni-aggregate-content">
        <h3>Riepilogo Giocatori</h3>
        <div class="help">Calcolo media voti e goal in corso…</div>
      </div>
    </section>

    <section id="video-section" style="display:none">
      <h2>Video Partite Concluse</h2>
      <ul id="video-list-ul" style="display:grid; gap:16px;"> 
      </ul>
    </section>

    <section id="formazione-pubblica-section" style="display:none">
      <h2>Formazione Ufficiale</h2>
      <div id="formazione-pubblica-content"></div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showPublicSection('calendario-section')">Torna al calendario</button></div>
    </section>

    <section id="prestazioni-partita-section" style="display:none">
      <h2>Prestazioni Partita</h2>
      <div id="prestazioni-partita-content"></div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showPublicSection('calendario-section')">Torna al calendario</button></div>
    </section>

    <section id="admin-inserimento-giocatori-section" style="display:none">
      <h2>Admin · Inserimento giocatori</h2>
      <form id="giocatore-form" onsubmit="addPlayer(event)">
        <label>Nome</label><input id="giocatore-nome" required />
        <label>Cognome</label><input id="giocatore-cognome" required />
        <label>Numero di maglia</label><input id="giocatore-numero" type="number" min="1" max="99" required />
        <label>Ruolo</label>
        <select id="giocatore-ruolo" required>
          <option value="">Seleziona ruolo</option>
          <option>Portiere</option>
          <option>Terzino sinistro</option>
          <option>Terzino destro</option>
          <option>Difensore centrale</option>
          <option>Centrocampista centrale</option>
          <option>Centrocampista sinistro</option>
          <option>Centrocampista destro</option>
          <option>Attaccante centrale</option>
        </select>
        <label>Stato</label>
        <select id="giocatore-titolare" required>
          <option>Titolare</option>
          <option>Riserva</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Aggiungi Giocatore</button></div>
      </form>
    </section>

    <section id="admin-inserimento-giornate-section" style="display:none">
      <h2>Admin · Inserimento Giornate</h2>
      <form id="match-form" onsubmit="addMatch(event)">
        <label>Avversaria</label><input id="match-avversaria" required />
        <label>Data</label><input id="match-data" required />
        <label>Orario</label><input id="match-orario" type="time" required />
        <label>Campo</label><input id="match-campo" required />
        <label>Casa/Trasferta</label>
        <select id="match-casa" required>
          <option>Casa</option>
          <option>Trasferta</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Aggiungi Giornata</button></div>
      </form>
    </section>

    <section id="admin-calendario-section" style="display:none">
      <h2>Admin · Calendario</h2>
      <div class="help">Premi sui bottoni per gestire Partite, Risultati, Valutazioni e Formazioni.</div>
      <ul id="admin-calendario-list" class="grid cols-3"></ul>
    </section>

    <section id="admin-formazione-section" style="display:none">
      <h2>Admin · Formazione & Sostituzioni</h2>
      <div id="formazione-content">Caricamento...</div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showAdminSection('admin-calendario-section')">Torna al calendario</button></div>
    </section>
    
    <section id="admin-statistiche-section" style="display:none">
      <h2>Admin · Inserimento Risultato</h2>
      <div id="risultato-form-content">Caricamento...</div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showAdminSection('admin-calendario-section')">Torna al calendario</button></div>
    </section>

    <section id="admin-prestazioni-partita-section" style="display:none">
      <h2>Admin · Inserimento Prestazioni</h2>
      <div id="prestazioni-form-content">Caricamento...</div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showAdminSection('admin-calendario-section')">Torna al calendario</button></div>
    </section>
    
    <section id="admin-candidature-section" style="display:none">
      <h2>Admin · Gestione Candidature (Compact)</h2>
      <div class="help">Elenco disponibilità inviate dagli utenti (Visualizzazione rapida). Per impostare a nome usa **Gestione dati**.</div>
      <ul id="candidature-list" class="grid cols-2"></ul>
    </section>

    <section id="admin-gestione-dati-section" style="display:none">
      <h2>Admin · Gestione dati</h2>

      <div class="card" style="margin-bottom:14px">
        <div class="row">
          <button class="tab" aria-current="page" onclick="document.getElementById('crud-giocatori').style.display='block';document.getElementById('crud-partite').style.display='none';document.getElementById('crud-candidature').style.display='none';loadCrudGiocatori()">Giocatori</button>
          <button class="tab" onclick="document.getElementById('crud-giocatori').style.display='none';document.getElementById('crud-partite').style.display='block';document.getElementById('crud-candidature').style.display='none';loadCrudPartite()">Partite</button>
          <button class="tab" onclick="updateClassificaFromSito()">Aggiorna Classifica</button>
        </div>
      </div>
      
      <div id="crud-candidature" style="display:none">
        <div id="crud-candidature-panel" class="card" style="margin-bottom:14px">
          <h3 id="crud-candidature-title">Gestione Candidature</h3>
          <div style="overflow-x:auto">
            <table class="table" style="width:100%">
              <thead><tr><th>Giocatore</th><th>UID Utente</th><th style="width:80px">Disponibile</th></tr></thead>
              <tbody id="crud-candidature-body"></tbody>
            </table>
          </div>
          <div class="actions">
            <button class="btn btn--accent" id="crud-candidature-save">Salva Candidature</button>
            <button class="btn" onclick="closeCandidatureEditor()">Chiudi</button>
          </div>
        </div>
      </div>
      
      <div id="crud-giocatori">
        <h3>Modifica Giocatori</h3>
        <div style="overflow-x:auto">
          <table class="table">
            <thead>
              <tr><th>Nome</th><th>Cognome</th><th>#</th><th>Ruolo</th><th>Stato</th><th>Presenze (Manuale)</th><th>Azioni</th></tr>
            </thead>
            <tbody id="crud-giocatori-body"></tbody>
          </table>
        </div>
      </div>
      
      <div id="crud-partite" style="display:none">
        <h3>Modifica Partite</h3>
        <div style="overflow-x:auto">
          <table class="table">
            <thead>
              <tr><th>Avversaria</th><th>Data</th><th>Ora</th><th>Campo</th><th>C/T</th><th style="width:80px; text-align:center;">Risultato</th><th style="width:80px; text-align:center;">Form. Pub.</th><th>Azioni</th></tr>
            </thead>
            <tbody id="crud-partite-body"></tbody>
          </table>
        </div>
      </div>
    </section>
    
    <section id="admin-video-section" style="display:none">
      <h2>Admin · Gestione Link Video</h2>
      <div class="help">Collega un link YouTube (es. Highlights) alla partita conclusa.</div>
      <form onsubmit="event.preventDefault()">
        <label>Seleziona Partita</label>
        <select id="video-partita-select"></select>
        
        <label>Link YouTube (URL completo)</label>
        <input id="video-link-input" type="url" placeholder="Inserisci il link YouTube..." required />
        
        <div class="actions">
          <button class="btn btn--accent" id="save-video-btn" type="button" disabled>Salva Link Video</button>
        </div>
      </form>
    </section>
    
    <section id="admin-utenti-section" style="display:none">
      <h2>Admin · Inserimento utenti</h2>
      <form id="create-user-form">
        <label>Nome Giocatore</label><input id="new-nome" required />
        <label>Cognome Giocatore</label><input id="new-cognome" required />
        <label>Email</label><input id="new-email" type="email" required />
        <label>Password</label><input id="new-password" type="password" required />
        <div class="actions"><button class="btn btn--admin" type="submit">Crea utenza</button></div>
      </form>
      <div class="help">L’admin resta connesso durante la creazione grazie all’autenticazione secondaria.</div>
    </section>
  </main>
  
  <div id="video-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 20px;">
    <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button" style="position:absolute; top:-10px; right:-10px; z-index:110; font-size: 1.2rem; line-height: 1.2;">X</button>
      <div id="video-iframe-container" style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; border-radius: 14px; overflow: hidden;">
        </div>
    </div>
  </div>

  <footer>
    &copy; AC Tuscolano <span id="current-year">2024</span>
  </footer>
  <script>document.getElementById('current-year').textContent = new Date().getFullYear();</script>
</body>
</html>
