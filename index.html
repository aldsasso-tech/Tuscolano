<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.6.1/firebase-app-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.6.1/firebase-database-compat.js"></script>

  <style>
    /* Stili Generali e Reset */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      padding-bottom: 20px;
    }

    /* Navbar ottimizzata per Mobile con Flexbox */
    .navbar {
      display: flex; /* Usa flexbox per una migliore gestione dello spazio */
      overflow-x: auto; /* Permette lo scroll orizzontale su schermi molto stretti */
      background-color: #333;
      border-bottom: 2px solid #007bff;
      white-space: nowrap; /* Impedisce che i link vadano a capo */
    }

    .tab {
      padding: 14px 20px;
      text-decoration: none;
      color: #f4f4f4;
      text-align: center;
      cursor: pointer;
      flex-grow: 1; /* Distribuisce lo spazio equamente */
      transition: background-color 0.3s;
      border-right: 1px solid #444;
    }
    .tab:last-child {
      border-right: none;
    }

    .tab:hover {
      background-color: #555;
    }

    /* Stato ATTIVO della Tab */
    .tab.active {
      background-color: #007bff;
      color: white;
    }

    /* Contenuto delle Sezioni */
    .content-section {
      padding: 20px;
      padding-top: 5px;
      opacity: 0;
      visibility: hidden;
      display: none; /* Nasconde correttamente le sezioni inattive */
      transition: opacity 0.3s, visibility 0s 0.3s;
    }

    /* Stato ATTIVO della Sezione (FIX: attiva la visibilità) */
    .content-section.active {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s, visibility 0s;
      display: block; /* Mostra la sezione attiva */
    }

    /* Stili Tabella */
    .table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin-top: 8px;
    }

    .table th,
    .table td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      word-wrap: break-word; /* Ottimizzazione mobile */
    }

    .table th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
    }

    .table tr:nth-child(even) {
      background-color: #f8f8f8;
    }

    /* Altri Stili */
    .title {
      font-size: 24px;
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .help {
      font-size: 12px;
      color: #777;
      text-align: center;
    }

    .info-card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
  </style>

  <script>
    // Inizializzazione Firebase (DA COMPLETARE CON LE TUE CREDENZIALI)
    const firebaseConfig = {
      // Inserisci qui i tuoi dati di configurazione Firebase
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    if (!window.firebaseApp) {
      window.firebaseApp = firebase.initializeApp(firebaseConfig);
    }
    const db = firebaseApp.database();
    const { ref, get, set } = firebase.database;

    /* ===== SCHEDULAZIONE: refresh giornaliero alle 23:00 ===== */
    function msUntilNext(hour, minute = 0, second = 0) {
      const now = new Date();
      const next = new Date(now);
      next.setHours(hour, minute, second, 0);
      if (next <= now) next.setDate(next.getDate() + 1);
      return next - now;
    }

    window.scheduleDailyClassificaRefresh = () => {
      const ms = msUntilNext(23, 0, 0);
      const infoEl = document.getElementById('classifica-next-run');
      if (infoEl) {
        const when = new Date(Date.now() + ms).toLocaleString('it-IT');
        infoEl.textContent = `Prossimo aggiornamento: ${when}`;
      }
      setTimeout(async function tick() {
        await loadClassifica();
        window.scheduleDailyClassificaRefresh();
      }, ms);
    };

    /* ===== FIX NAVIGAZIONE (CORREZIONE ERRORE) ===== */
    function switchSection(targetId) {
        // Rimuovi la classe 'active' da tutte le tab e sezioni
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

        // Aggiungi la classe 'active' alla tab e alla sezione target
        const targetTab = document.querySelector(`.tab[data-target="${targetId}"]`);
        const targetSection = document.querySelector(targetId);

        if (targetTab) targetTab.classList.add('active');
        if (targetSection) targetSection.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Applica i listener di click alle tab
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.getAttribute('data-target');
                switchSection(target);
                // Aggiorna l'URL senza ricaricare la pagina (opzionale)
                history.pushState(null, '', `#${target.substring(1)}`);
            });
        });

        // Gestisce la navigazione iniziale o tramite URL hash
        const initialHash = window.location.hash || '#sez-home';
        const targetSection = document.querySelector(initialHash);
        
        if (targetSection) {
            switchSection(initialHash);
        } else {
            // Se l'hash non è valido, mostra la sezione predefinita
            switchSection('#sez-home');
        }

        // Avvia il caricamento della classifica e la schedulazione
        loadClassifica();
        window.scheduleDailyClassificaRefresh();
    });

    /* ===== LOGICA CLASSIFICA: Recupero dati da romatornei.it e caching su Firebase ===== */
    async function loadClassifica() {
      const classificaContent = document.getElementById('classifica-content');
      const todayKey = new Date().toISOString().slice(0, 10);
      const url = "https://www.romatornei.it/romatornei/prestazioni/classifica.php";

      try {
        const snap = await get(ref(db, 'classifica_cache'));
        const cache = snap.val() || {};

        // 1. Controlla la Cache
        if (cache.date === todayKey) {
          classificaContent.innerHTML = cache.html;
          console.log("Classifica caricata dalla cache.");
          return;
        }

        // 2. Recupera la Nuova Classifica (Fetch)
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const htmlText = await response.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');
        const table = doc.querySelector('table');
        if (!table) throw new Error('Tabella non trovata nella pagina esterna.');

        // 3. Normalizzazione TH (Intestazioni) per layout mobile
        const thead = table.querySelector('thead');
        const headers = Array.from(thead.querySelectorAll('th'));
        const totalWidth = headers.reduce((sum, th) => sum + parseInt(th.style.width || 0), 0);

        const theadHTML = `<thead><tr>${headers.map(th => {
          const widthPercent = (parseInt(th.style.width || 0) / totalWidth) * 100 + '%';
          return `<th style="width:${widthPercent}">${th.innerHTML}</th>`;
        }).join('')}</tr></thead>`;

        // 4. Normalizzazione TBODY (Corpo della Tabella) per layout mobile
        const tbody = table.querySelector('tbody');
        const tbodyHTML = Array.from(tbody.querySelectorAll('tr')).map((tr, idx) => {
          const rowHTML = Array.from(tr.querySelectorAll('td')).map((td, tdIdx) =>
            // Applica la larghezza calcolata e l'ottimizzazione word-wrap
            `<td style="width:${(parseInt(headers[tdIdx].style.width || 0) / totalWidth) * 100}%;padding:8px;text-align:center;border-bottom:1px solid #ddd;font-size:13px;word-wrap:break-word">${td.innerHTML}</td>`
          ).join('');
          const bg = idx % 2 === 1 ? ' style="background:#f8f8f8"' : '';
          return `<tr${bg}>${rowHTML}</tr>`;
        }).join('');

        // 5. Costruzione HTML Finale
        const normalizedHTML = `
          <div class="help">Classifica aggiornata automaticamente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
          <div style="overflow-x:auto">
            <table class="table" style="width:100%;border-collapse:collapse;table-layout:fixed;margin-top:8px">
              ${theadHTML}
              <tbody>${tbodyHTML}</tbody>
            </table>
          </div>
          <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
          <div id="classifica-next-run" class="help" style="margin-top:4px;"></div>
        `;

        classificaContent.innerHTML = normalizedHTML;

        // 6. Salva in Cache
        await set(ref(db, 'classifica_cache'), {
          html: normalizedHTML,
          date: todayKey,
          timestamp: Date.now()
        });
      } catch (e) {
        console.error("Errore nel recupero della classifica:", e);
        // Tenta di caricare dalla cache in caso di errore
        try {
          const snap2 = await get(ref(db, 'classifica_cache'));
          const cache2 = snap2.val() || {};
          if (cache2.html) {
            classificaContent.innerHTML = cache2.html + '<div class="help" style="color:red;margin-top:8px">Errore nel recupero dati. Caricata la cache.</div>';
          } else {
            classificaContent.innerHTML = '<div class="help" style="color:red">Impossibile caricare i dati della classifica.</div>';
          }
        } catch (e2) {
          console.error("Errore nel caricamento della cache:", e2);
          classificaContent.innerHTML = '<div class="help" style="color:red">Impossibile caricare i dati della classifica.</div>';
        }
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div class="tab active" data-target="#sez-home">Home</div>
      <div class="tab" data-target="#sez-stats">Statistiche</div>
      <div class="tab" data-target="#sez-classifica">Classifica</div>
      <div class="tab" data-target="#sez-info">Info</div>
    </div>

    <div id="sez-home" class="content-section active">
      <h2 class="title">Benvenuto</h2>
      <p>Questa è la pagina di gestione della squadra AC Tuscolano. Usa le tab in alto per navigare tra le sezioni.</p>
    </div>

    <div id="sez-stats" class="content-section">
      <h2 class="title">Statistiche Giocatori</h2>
      <p>Contenuto placeholder per le statistiche dei giocatori.</p>
      <div class="info-card">
        Dati sulle presenze, gol e assist della squadra.
      </div>
    </div>

    <div id="sez-classifica" class="content-section">
      <h2 class="title">Classifica Campionato</h2>
      <div id="classifica-content">
        <div class="help">Caricamento della classifica in corso...</div>
      </div>
    </div>

    <div id="sez-info" class="content-section">
      <h2 class="title">Informazioni Utili</h2>
      <p>Questa sezione contiene informazioni di contatto, calendario e regolamento.</p>
      <div class="info-card">
        Contatta il mister per dettagli sui prossimi allenamenti.
      </div>
    </div>
  </div>
</body>
</html>
