<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js">
/* ===== SCHEDULAZIONE: refresh giornaliero alle 23:00 ===== */
function msUntilNext(hour, minute = 0, second = 0) {
  const now = new Date();
  const next = new Date(now);
  next.setHours(hour, minute, second, 0);
  if (next <= now) next.setDate(next.getDate() + 1);
  return next - now;
}
window.scheduleDailyClassificaRefresh = () => {
  const ms = msUntilNext(23, 0, 0);
  const infoEl = document.getElementById('classifica-next-run');
  if (infoEl) {
    const when = new Date(Date.now() + ms).toLocaleString('it-IT');
    infoEl.textContent = `Prossimo aggiornamento: ${when}`;
  }
  setTimeout(async function tick() {
    await loadClassifica();
    window.scheduleDailyClassificaRefresh();
  }, ms);
};


/* ===== EFFETTO FADE NAVIGAZIONE (solo .content-section, fix visibilitÃ  completa) ===== */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.getAttribute('data-target');
    const current = document.querySelector('.content-section.active');
    const next = document.getElementById(target);
    if (!next || current === next) return;

    if (current) {
      current.style.opacity = '0';
      current.style.pointerEvents = 'none';
      setTimeout(() => {
        current.classList.remove('active');
        next.classList.add('active');
        next.style.opacity = '0';
        next.style.pointerEvents = 'all';
        setTimeout(() => { next.style.opacity = '1'; }, 50);
      }, 400);
    } else {
      next.classList.add('active');
      next.style.opacity = '1';
      next.style.pointerEvents = 'all';
    }

    // Aggiorna contenuto dinamico
    if (target === 'classifica-section' && typeof loadClassifica === 'function') {
      setTimeout(() => loadClassifica(), 600);
    }
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const firstSection = document.querySelector('.content-section') || document.querySelector('section');
  if (firstSection) firstSection.classList.add('active');
  if (typeof window.scheduleDailyClassificaRefresh === 'function') {
    window.scheduleDailyClassificaRefresh();
  }
});
);

document.addEventListener('DOMContentLoaded', () => {
  const firstSection = document.querySelector('section');
  if (firstSection) firstSection.classList.add('active');
  if (typeof window.scheduleDailyClassificaRefresh === 'function') {
    window.scheduleDailyClassificaRefresh();
  }
});

</script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }

    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  

/* === Effetti di transizione per le sezioni visibili (.content-section) === */
.content-section {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
}
.content-section.active {
  opacity: 1;
  pointer-events: all;
}


</style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; // Usato nella sezione admin-video-section

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section','video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section',
      'admin-statistiche-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section' // Aggiunto per il video
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; // Includo il login per nasconderlo

    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      ALL_SECTIONS.forEach(secId => { 
        const el = byId(secId); 
        if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
      });
      document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
      document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dall'admin
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); // Protezione base
        
        ALL_SECTIONS.forEach(secId => { 
          const el = byId(secId); 
          if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dal pubblico
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
            t.setAttribute('aria-current', t.dataset.adminTarget===id ? 'page' : 'false');
        });

        // Ricarica i dati specifici per la sezione admin (dal tuo codice originale)
        if(id==='admin-calendario-section'){ loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ loadCandidature(); }
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') loadPartitePerVideoAdmin(); // Carica per la sezione video

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             // Se l'admin fa logout, torna alla sezione pubblica di default
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); // Nasconde il form di login dopo lo stato di auth
      toggleAdminUI(); // Aggiorna la UI
      
      // Assicura che una sezione sia visibile al cambio di stato
      if(user && isAdmin) {
         // Se admin loggato, mostra la sezione predefinita admin (es. inserimento giocatori)
         if(byId('admin-inserimento-giocatori-section').style.display === 'none'){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         // Se loggout o utente normale, mostra la sezione pubblica predefinita
         window.showPublicSection('rosa-section');
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          // Ricarica la sezione pubblica dopo il logout
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded',()=>{
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) â usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      window.showPublicSection('rosa-section');
      loadRosa(); 
      loadProssimeGiornate(false); 
      loadStatistiche();
      loadClassifica(); // ** NUOVO: Carica la classifica all'avvio
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);

      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
      byId('rosa-tab')?.addEventListener('click', loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', loadStatistiche);
      byId('video-tab')?.addEventListener('click', loadVideoList);
      byId('classifica-tab')?.addEventListener('click', loadClassifica); // ** NUOVO: Evento per la classifica
    });
    
   /* ===== NUOVA FUNZIONE: Classifica Statica (Aggiornata con i dati forniti dall'utente) ===== */
    
/* ===== FUNZIONE: Classifica AC Tuscolano con cache Firebase (solo admin aggiorna) ===== */
const loadClassifica = async () => {
  const classificaContent = document.getElementById('classifica-content');
  if (!classificaContent) return;

  classificaContent.innerHTML = `<div class="help">Caricamento classifica in corso...</div>`;

  try {
    const now = new Date();
    const todayKey = now.toISOString().split('T')[0];
    const snap = await get(ref(db, 'classifica_cache'));
    const cache = snap.val() || {};
    const cachedHtml = cache.html;
    const cachedDate = cache.date;

    if (cachedHtml && cachedDate === todayKey) {
      classificaContent.innerHTML = cachedHtml;
      return;
    }

    if (!isAdmin) {
      if (cachedHtml) {
        classificaContent.innerHTML = cachedHtml;
      } else {
        classificaContent.innerHTML = `<div class="help" style="color:red">La classifica non Ã¨ ancora disponibile. L'amministratore provvederÃ  all'aggiornamento.</div>`;
      }
      return;
    }

    const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
    const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
    const response = await fetch(proxy);
    const data = await response.json();

    const parser = new DOMParser();
    const doc = parser.parseFromString(data.contents, "text/html");
    const table = doc.querySelector(".table-responsive table") || doc.querySelector("table[class*='table']") || doc.querySelector("table");

    if (!table) {
      classificaContent.innerHTML = `<div class="help">Impossibile trovare la classifica sul sito remoto.</div>`;
      return;
    }

    // Stile AC Tuscolano
    table.querySelectorAll("img").forEach(img => {
      img.style.maxWidth = "25px";
      img.style.height = "auto";
      img.style.verticalAlign = "middle";
    });

    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.querySelectorAll("th").forEach(th => {
      th.style.backgroundColor = "#8B0000";
      th.style.color = "#fff";
      th.style.padding = "8px";
      th.style.textAlign = "center";
      th.style.borderBottom = "2px solid #ccc";
    });
    table.querySelectorAll("td").forEach(td => {
      td.style.padding = "8px";
      td.style.textAlign = "center";
      td.style.borderBottom = "1px solid #ddd";
    });
    table.querySelectorAll("tr:nth-child(even)").forEach(tr => {
      tr.style.backgroundColor = "#f8f8f8";
    });

    const htmlContent = `
      <div class="help">Classifica aggiornata automaticamente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
      <div style="overflow-x:auto;">${table.outerHTML}</div>
      <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
      <div id="classifica-next-run" class="help" style="margin-top:4px;"></div>
    `;

    classificaContent.innerHTML = htmlContent;
    await set(ref(db, 'classifica_cache'), {
      html: htmlContent,
      date: todayKey,
      timestamp: Date.now()
    });
  } catch (error) {
    console.error("Errore caricamento classifica:", error);
    const snapFallback = await get(ref(db, 'classifica_cache'));
    const cache = snapFallback.val();
    if (cache && cache.html) {
      classificaContent.innerHTML = cache.html;
    } else {
      classificaContent.innerHTML = `<div class="help" style="color:red">Errore nel recupero della classifica.</div>`;
    }
  }
};



    /* ===== NUOVE FUNZIONI VIDEO (INTEGRATE) ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; // Ferma la riproduzione
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); // Usa 'calendario' come il resto del tuo codice
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => {
          const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const dateA = toDate(partite[a].data);
          const dateB = toDate(partite[b].data);
          return dateB - dateA;
        });

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="window.openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    // Carica le partite per il menu a tendina Admin (solo quelle concluse)
    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // Aggiorna il campo input quando la partita selezionata cambia
    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    // Salva il link video nel database
    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");

      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");

      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;

        await update(ref(db), updates);

        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); // Aggiorna anche la sezione pubblica immediatamente
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Originali dell'Utente (Integrate) ===== */
    
    async function loadRosa(){
      const ul = byId('rosa-list'); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const val = snap.val() || {};
      const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      if(!rows.length){ ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>'; return; }
      ul.className='grid cols-2';
      rows.forEach(([id,g])=>{
        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
              <div class="player-sub">Ruolo: <b>${g.ruolo}</b> â¢ Stato: <b>${g.stato}</b></div>
            </div>
          </div>`;
        ul.appendChild(li);
      });
    }

    async function loadProssimeGiornate(asAdmin){
        const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
        const ul = byId(listId); if(!ul) return; ul.innerHTML='';
        const snap = await get(ref(db,'calendario'));
        const val = snap.val() || {};
        let entries = Object.entries(val);
        
        // Funzione per convertire la data (gg/mm/aaaa)
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        // Data di oggi normalizzata a mezzanotte per confronto
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        
        entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));

        if(!entries.length){ ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; return; }
        ul.className='grid cols-3';

        for(const [matchId,m] of entries){
            const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
            const cand = candSnap.val() || {};
            const candCount = Object.values(cand).filter(Boolean).length;
            const isPublished = m.formazionePubblicata === true;
            
            // Nuovo controllo sulla data della partita
            const matchDate = toDate(m.data);
            // Ã nel passato se la data della partita Ã¨ strettamente precedente a 'today' (normalizzato)
            const isPast = matchDate < today; 

            // Generazione condizionale del pulsante di candidatura
            let candButton = '';
            if (isPast) {
                // Partita passata: bottone disabilitato con testo aggiornato
                candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`;
            } else {
                // Partita futura: bottone attivo
                candButton = `<button class="btn btn--accent" onclick="candidati('${matchId}')">Candidatura</button>`;
            }
            
            const li = document.createElement('li'); li.className='card';
            li.innerHTML = `
              <div class="row" style="justify-content:space-between;align-items:flex-start">
                <div>
                  <div style="font-weight:800;font-size:1.05rem">vs ${m.avversaria}</div>
                  <div class="player-sub">${m.data} â¢ ${m.orario} â¢ ${m.campo} â¢ ${m.casa? 'Casa':'Trasferta'}</div>
                  <div class="player-sub">Candidature: <b>${candCount}</b></div>
                  <div class="player-sub">Risultato: <b>${m.risultato||'N/D'}</b></div>
                </div>
                <div class="row">
                  ${!asAdmin ? `
                    ${candButton}
                    ${isPublished ? `<button class="btn" onclick="showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria)}')">Vedi Formazione</button>` : ''}
                  `:''}
                  ${asAdmin ? `
                    <button class="btn btn--admin" onclick="showFormazioneForm('${matchId}','${escapeHtml(m.avversaria)}')">Formazione & Sost.</button>
                    <button class="btn btn--admin" onclick="showRisultatoForm('${matchId}','${escapeHtml(m.avversaria)}')">Risultato</button>
                  `:''}
                </div>
              </div>`;
            ul.appendChild(li);
        }
    }

    window.candidati = async(matchId)=>{
      const user = auth.currentUser;
      if(!user){ showLogin(); alert('Per candidarti devi effettuare il login.'); return; }
      await set(ref(db,`calendario/${matchId}/candidature/${user.uid}`), true);
      alert('DisponibilitÃ  inviata.');
      loadProssimeGiornate(false);
    };

    async function loadStatistiche(){
      const rl = byId('statistiche-risultati-list'); if(rl){ rl.innerHTML=''; }
      const gl = byId('statistiche-voti-list'); if(gl){ gl.innerHTML=''; }

      const snapCal = await get(ref(db,'calendario')); const cal = snapCal.val()||{};
      const rows = Object.entries(cal);
      if(rl){
        if(!rows.length) rl.innerHTML = '<div class="help">Ancora nessun risultato.</div>';
        rows.forEach(([id,m])=>{
          const li = document.createElement('li'); li.className='card';
          li.innerHTML = `<div><b>${m.data}</b> â¢ vs ${m.avversaria} â Risultato: <b>${m.risultato||'N/D'}</b></div>`;
          rl.appendChild(li);
        });
      }
      
      const snapRosa = await get(ref(db,'rosa')); const rosa = snapRosa.val()||{};
      const rosaRows = Object.entries(rosa);
      if(gl){
        if(!rosaRows.length) gl.innerHTML = '<div class="help">Nessun dato giocatori.</div>';
        const sorted = rosaRows.sort((a,b)=> (b[1].voto||0)-(a[1].voto||0));
        sorted.forEach(([id,g])=>{
          const avgVoto = (g.voto||0) / (g.presenze||1);
          const li = document.createElement('li'); li.className='card';
          li.innerHTML = `
            <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
            <div class="player-sub">
              Presenze: <b>${g.presenze||0}</b> â¢ Goal: <b>${g.goal||0}</b> â¢ Voto Medio: <b>${avgVoto.toFixed(2)}</b>
            </div>`;
          gl.appendChild(li);
        });
      }
    }

    // --- Inserimento/Modifica Partite (Admin) ---
    byId('giornata-form')?.addEventListener('submit',async e=>{
      e.preventDefault(); if(!isAdmin) return alert("Solo admin.");
      const m = {
        avversaria: v('match-avversaria'),
        data: v('match-data'),
        orario: v('match-orario'),
        campo: v('match-campo'),
        casa: v('match-casa')==='true',
        risultato: v('match-risultato') || 'N/D',
        formazionePubblicata: false, // Default: non pubblicata
        linkVideo: '', // Default: nessun link video
      };
      if(!m.avversaria||!m.data||!m.orario) return alert("Compila i campi Avversaria, Data e Orario.");
      try{
        await push(ref(db,'calendario'),m);
        alert('Partita aggiunta!');
        e.target.reset();
        loadProssimeGiornate(true);
      }catch(err){ alert('Errore: '+err.message); }
    });

    // --- Inserimento Giocatori (Admin) ---
    window.addPlayer = async(e)=>{
      e.preventDefault(); if(!isAdmin) return alert("Solo admin.");
      const p = {
        nome: v('giocatore-nome'),
        cognome: v('giocatore-cognome'),
        numero: +v('giocatore-numero'),
        ruolo: v('giocatore-ruolo'),
        stato: v('giocatore-stato'),
        presenze: 0,
        goal: 0,
        voto: 0, // Voto totale per calcolo media
      };
      if(!p.nome||!p.cognome||!p.numero||!p.ruolo||!p.stato) return alert("Compila tutti i campi.");
      try{
        await push(ref(db,'rosa'),p);
        alert('Giocatore aggiunto!');
        e.target.reset();
        loadRosa();
        window.showAdminSection('admin-inserimento-giocatori-section'); // Ricarica la pagina per pulizia
      }catch(err){ alert('Errore: '+err.message); }
    };

    // --- Formazione & Sostituzioni (Admin) ---

    // Configurazione 3-3-1
    const POS_331 = {
      P: 'Portiere',
      Ds: 'Difensore sinistro',
      Dc: 'Difensore centrale',
      Dd: 'Difensore destro',
      Cs: 'Centrocampista sinistro',
      Cc: 'Centrocampista centrale',
      Cd: 'Centrocampista destro',
      A: 'Attaccante',
    };
    const N_SLOTS = Object.keys(POS_331).length; // 8
    const MATCH_DURATION = 50; // Minuti

    window.showFormazioneForm = async(matchId, avversaria)=>{
      if(!isAdmin) return;
      window.showAdminSection('admin-formazione-section');
      byId('formazione-title').textContent = `Admin Â· Formazione vs ${avversaria}`;
      
      const snapRosa = await get(ref(db,'rosa'));
      const rosa = snapRosa.val() || {};
      const snapMatch = await get(ref(db,`calendario/${matchId}/formazione`));
      const currentFormazioneFrames = snapMatch.val() || {};
      
      const availablePlayers = Object.entries(rosa).map(([id,g])=>({
        id: id,
        label: `${g.nome} ${g.cognome} (#${g.numero}) - ${g.ruolo}`,
        ruolo: g.ruolo,
        numero: g.numero
      })).sort((a,b)=>a.numero-b.numero);

      // Estraggo la formazione iniziale e la panchina dalla prima frame se esiste
      const firstFrame = currentFormazioneFrames['0'] || {};
      const currentTitolari = firstFrame.formazione || {};
      const currentPanchina = firstFrame.panchina || [];
      
      // Helper per generare opzioni del select
      const opts = (selectedId) => {
        let options = '<option value="">(Nessuno)</option>';
        options += availablePlayers.map(p => 
          `<option value="${p.id}" ${p.id===selectedId ? 'selected' : ''}>${escapeHtml(p.label)}</option>`).join('');
        return options;
      };

      const box = byId('formazione-content');
      const MAX_BENCH_OPTIONS = availablePlayers.length - N_SLOTS;

      if (MAX_BENCH_OPTIONS < 0) {
        box.innerHTML = `<h3 style="color:var(--red)">Errore: solo ${availablePlayers.length} giocatori disponibili, ne servono almeno ${N_SLOTS}.</h3>`;
        return;
      }
      
      // --- Funzioni Helper locali ---
      function collectTitolariMap(){
        const ids = {};
        Object.keys(POS_331).forEach(r=>{
          ids[r] = byId('t-'+r)?.value || null;
        });
        return ids;
      }
      
      function collectPanchina(){
        const ids = [];
        document.querySelectorAll('#panchina select').forEach(sel => {
          if(sel.value) ids.push(sel.value);
        });
        // Rimuove i duplicati in panchina
        return [...new Set(ids)];
      }
      
      // 2. Calcolo Logica Sostituzioni Dinamiche
      const calculateSubstitutions = (panchinaIds) => {
        const N_Tot = N_SLOTS + panchinaIds.length;
        const N_Sostituzioni = N_SLOTS;
        const T_Player = (N_SLOTS * MATCH_DURATION) / N_Tot; // Tempo di gioco equo per ogni giocatore
        const delta_t = MATCH_DURATION / N_Sostituzioni; // Intervallo tra le N_Sostituzioni
        const subs = [];

        for (let i = 1; i <= N_Sostituzioni; i++) {
          let minuto = Math.round(i * delta_t);
          if (minuto > MATCH_DURATION) minuto = MATCH_DURATION;
          
          // Assegnazione Dinamica Entrante (riserva) e Uscente (titolare) - semplificata per 1:1
          const entranteId = panchinaIds[i-1] || null;
          let uscenteId = null;

          // Per semplicitÃ , ipotizziamo l'uscita a rotazione dei titolari.
          // Se la panchina Ã¨ piÃ¹ corta, le sostituzioni si fermano.
          if (entranteId) {
             // Semplificazione: uscente Ã¨ il titolare che ha giocato piÃ¹ a lungo in quel momento (ma richiede logica complessa).
             // Per non complicare, useremo una rotazione basica basata sull'indice di posizione.
             const posKeys = Object.keys(POS_331);
             const posIndex = (i - 1) % posKeys.length;
             const uscentePos = posKeys[posIndex];
             uscenteId = currentTitolari[uscentePos];
          }

          if (entranteId) {
            subs.push({
              minuto: minuto,
              pos: i < panchinaIds.length ? 'A Rotazione' : 'Finale', // Placeholder per la posizione
              out: uscenteId,
              in: entranteId
            });
          }
        }

        // Output testo informativo per il tempo di gioco
        const playtimeInfo = N_Tot > N_SLOTS 
          ? `(${N_Tot} giocatori in totale): Ogni giocatore giocherÃ  circa ${T_Player.toFixed(1)} minuti`
          : `(8 giocatori in totale): Gioco continuo.`;

        byId('equal-playtime-info').textContent = playtimeInfo;
        return subs;
      };


      // 3. Funzione per generare il markup delle sostituzioni
      function updateSubsDisplay(){
        const panchinaIds = collectPanchina();
        const subs = calculateSubstitutions(panchinaIds);
        const subsBox = byId('subs');
        subsBox.innerHTML = '';

        if(subs.length === 0){
          subsBox.innerHTML = '<div class="help" style="grid-column:1/3">Nessuna riserva. Formazione iniziale giocherÃ  per tutti i 50 minuti.</div>';
          return;
        }

        let html = '';
        subs.forEach((s, index) => {
          const uscentePlayer = availablePlayers.find(p => p.id === s.out);
          const entrantePlayer = availablePlayers.find(p => p.id === s.in);

          if (uscentePlayer && entrantePlayer) {
             html += `
              <div class="card" style="background:#f9f9f9">
                <div style="font-size:1.1rem; font-weight:700">Minuto ${s.minuto}</div>
                <div class="player-sub" style="margin-top:4px">
                  <span style="color:var(--red)">OUT: ${uscentePlayer.label.split(' - ')[0]}</span><br>
                  <span style="color:green">IN: ${entrantePlayer.label.split(' - ')[0]}</span>
                </div>
              </div>`;
          }
        });
        subsBox.innerHTML = html;
      }
      
      // 4. Inizializzazione della Formazione
      let formazioneHTML = Object.entries(POS_331).map(([key, label]) => `
          <div>
            <label>${label} (${key})</label>
            <select id="t-${key}" required onchange="updateSubsDisplay()">
              ${opts(currentTitolari[key] || '')}
            </select>
          </div>
        `).join('');

      let panchinaHTML = Array.from({length: Math.max(0, MAX_BENCH_OPTIONS)}).map((_, i) => `
          <div>
            <label>Riserva ${i + 1}</label>
            <select data-role="panchina" id="p-riserva-${i+1}" onchange="updateSubsDisplay()">
              ${opts(currentPanchina[i] || '')}
            </select>
          </div>
        `).join('');

      box.innerHTML = `
        <form id="formazione-match-form" onsubmit="saveFormazione(event, '${matchId}')">
          <h3>Titolari (Schema 3-3-1)</h3>
          <div class="grid cols-3">${formazioneHTML}</div>
          
          <hr style="margin:18px 0">
          
          <h3>Panchina (${MAX_BENCH_OPTIONS} posti disponibili)</h3>
          <div id="panchina" class="grid cols-3">${panchinaHTML}</div>
          
          <hr style="margin:18px 0">
          
          <h4 id="subs-title">Calcolo Sostituzioni (EquitÃ  Tempo di Gioco)</h4>
          <p class="help" id="equal-playtime-info">...</p>
          <div id="subs" class="grid cols-2"></div>

          <div class="actions">
            <button class="btn btn--admin" type="submit">Salva & genera mappe</button>
            <button class="btn" type="button" onclick="showAdminSection('admin-calendario-section')">Annulla</button>
          </div>
          
          <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--line)">
            <label>Pubblica la formazione?</label>
            <select id="formazione-pubblica-toggle">
              <option value="false" ${!firstFrame.pubblicata ? 'selected' : ''}>No (visibile solo admin)</option>
              <option value="true" ${firstFrame.pubblicata ? 'selected' : ''}>SÃ¬ (visibile a tutti)</option>
            </select>
          </div>

        </form>`;
        
      // Aggiorna il display iniziale delle sostituzioni
      updateSubsDisplay();
    };


    window.saveFormazione = async (e, matchId) => {
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        
        const titolari = collectTitolariMap();
        const panchina = collectPanchina();
        const pubblicata = byId('formazione-pubblica-toggle').value === 'true';

        // 1. Validazione: UnicitÃ 
        const allPlayers = [...Object.values(titolari).filter(Boolean), ...panchina];
        if (new Set(allPlayers).size !== allPlayers.length) {
            return alert("Errore: I giocatori in campo e in panchina devono essere unici. Rimuovi i duplicati.");
        }
        // 2. Validazione: Titolari
        if (Object.values(titolari).filter(Boolean).length !== N_SLOTS) {
            return alert(`Errore: Devi selezionare esattamente ${N_SLOTS} titolari.`);
        }
        
        // 3. Calcolo Sostituzioni (Finali)
        const subs = calculateSubstitutions(panchina);
        
        // 4. Struttura dati finale
        const formazioneFrames = {
          // Frame iniziale (minuto 0)
          '0': {
            formazione: titolari,
            panchina: panchina,
            minuto: 0,
            pubblicata: pubblicata,
          }
          // Qui si possono aggiungere le frame dinamiche basate su `subs`, ma per semplicitÃ 
          // e non implementando la logica di 'chi esce' in modo robusto,
          // ci fermiamo alla Formazione iniziale + lista di sostituzioni.
          // La logica di base `calculateSubstitutions` Ã¨ inclusa come *suggerimento* per l'admin.
        };

        const updates = {};
        updates[`/calendario/${matchId}/formazione`] = formazioneFrames;
        updates[`/calendario/${matchId}/formazionePubblicata`] = pubblicata;
        updates[`/calendario/${matchId}/sostituzioniSuggestite`] = subs; // Salviamo le sostituzioni calcolate

        try {
            await update(ref(db), updates);
            alert('Formazione salvata e suggerimenti sostituzioni generati!');
            await loadProssimeGiornate(true);
            await loadStatistiche();
            window.showAdminSection('admin-calendario-section');
            
            // Incrementa le presenze solo dei titolari della prima frame.
            const presenzeUpdate = {};
            Object.values(titolari).forEach(playerId => {
                if(playerId) presenzeUpdate[playerId] = true;
            });
            await incrementPresenzeForFormazioni({ '0': { formazione: titolari } });

        } catch(err) {
            alert('Errore salvataggio formazione: ' + err.message);
        }
    };

    // Helper: incremento presenze multiplo
    async function incrementPresenzeForFormazioni(formazioni){
      const presenti = new Set();
      Object.values(formazioni).forEach(frame=>{
        const f = frame.formazione || {};
        Object.values(f).forEach(pid=>{
          if(pid) presenti.add(pid);
        });
      });
      if(presenti.size===0) return;

      const snap = await get(ref(db,'rosa'));
      const rosa = snap.val() || {};
      const updates = {};
      
      presenti.forEach(pid=>{
        const g = rosa[pid];
        if(g){
          updates[`/rosa/${pid}/presenze`] = (g.presenze || 0) + 1;
        }
      });
      
      if(Object.keys(updates).length){
        await update(ref(db), updates);
      }
    }


    // Pubblico: visualizza la formazione
    window.showFormazionePubblica = async(matchId, avversaria)=>{
      window.showPublicSection('formazione-pubblica-section');
      const box = byId('formazione-pubblica-content');
      box.innerHTML = '<div class="help">Caricamento formazione...</div>';

      const [snapMatch, snapRosa] = await Promise.all([
        get(ref(db,`calendario/${matchId}`)),
        get(ref(db,'rosa'))
      ]);

      const match = snapMatch.val() || {};
      const rosa = snapRosa.val() || {};
      
      if (!match.formazionePubblicata || !match.formazione || !match.formazione['0']) {
        box.innerHTML = `<div class="help" style="color:var(--red)">La formazione per la partita vs <b>${avversaria}</b> non Ã¨ ancora stata pubblicata.</div>`;
        return;
      }

      const firstFrame = match.formazione['0'];
      const titolariIds = firstFrame.formazione || {};
      const panchinaIds = firstFrame.panchina || [];
      const subs = match.sostituzioniSuggestite || [];

      // Mappa ID a Dati Giocatore
      const getPlayerInfo = (id) => rosa[id] ? `${rosa[id].nome} ${rosa[id].cognome} (#${rosa[id].numero})` : 'Giocatore Sconosciuto';
      const getPlayerRuolo = (id) => rosa[id] ? rosa[id].ruolo : 'Ruolo Sconosciuto';

      // --- Titolari Markup ---
      let titolariHtml = Object.entries(POS_331).map(([key, label]) => {
          const playerId = titolariIds[key];
          const playerInfo = playerId ? getPlayerInfo(playerId) : '--- Slot Vuoto ---';
          const playerRuolo = playerId ? getPlayerRuolo(playerId) : label;
          return `
            <div class="card" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
              <div class="player-title" style="color:var(--red)">${key}</div>
              <div class="player-sub">${playerInfo}</div>
              <div class="pill" style="margin-top:6px">${playerRuolo}</div>
            </div>`;
        }).join('');

      // --- Panchina Markup ---
      let panchinaHtml = panchinaIds.length > 0
        ? panchinaIds.map(id => {
            const playerInfo = getPlayerInfo(id);
            const playerRuolo = getPlayerRuolo(id);
            return `<li class="card"><b>${playerInfo}</b> â¢ ${playerRuolo}</li>`;
          }).join('')
        : '<li class="help">Nessuna riserva.</li>';
      
      // --- Sostituzioni Markup (Visualizza i suggerimenti se presenti) ---
      let subsHtml = subs.length > 0
          ? subs.map(s => {
              const outPlayer = getPlayerInfo(s.out);
              const inPlayer = getPlayerInfo(s.in);
              return `
                <div class="card" style="background:#f9f9f9">
                  <div style="font-size:1.1rem; font-weight:700">Minuto ${s.minuto}</div>
                  <div class="player-sub" style="margin-top:4px">
                    <span style="color:var(--red)">OUT: ${outPlayer}</span><br>
                    <span style="color:green">IN: ${inPlayer}</span>
                  </div>
                </div>`;
            }).join('')
          : '<div class="help" style="grid-column:1/3">Nessuna sostituzione pianificata.</div>';


      box.innerHTML = `
        <h3 style="margin-top:0">Titolari vs ${avversaria}</h3>
        <div class="help">Formazione iniziale e posizioni in campo (Schema 3-3-1).</div>
        <div class="grid cols-4" style="margin-top:10px">${titolariHtml}</div>
        
        <hr style="margin:20px 0">
        
        <h3>Panchina</h3>
        <div class="help">Giocatori disponibili in panchina.</div>
        <ul class="grid cols-3" style="margin-top:10px">${panchinaHtml}</ul>
        
        <hr style="margin:20px 0">
        
        <h3>Sostituzioni Pianificate</h3>
        <div class="help">Queste sono le sostituzioni suggerite per equitÃ  di tempo di gioco.</div>
        <div class="grid cols-2" style="margin-top:10px">${subsHtml}</div>
        `;
    };

    // --- Inserimento Risultato (Admin) ---
    window.showRisultatoForm = async(matchId, avversaria)=>{
      if(!isAdmin) return;
      window.showAdminSection('admin-statistiche-section'); // Riutilizza la sezione statistiche admin
      const box = byId('admin-statistiche-form');
      box.innerHTML = '';

      const snap = await get(ref(db,`calendario/${matchId}`));
      const match = snap.val() || {};
      const currentRisultato = match.risultato || 'N/D';

      box.innerHTML = `
        <h3>Admin Â· Inserimento Risultato vs ${avversaria}</h3>
        <form onsubmit="saveRisultato(event, '${matchId}')">
          <label>Risultato (Es: 3-2)</label>
          <input id="risultato-input" type="text" value="${escapeHtml(currentRisultato)}" required />
          <div class="actions">
            <button class="btn btn--admin" type="submit">Salva Risultato</button>
            <button class="btn" type="button" onclick="showAdminSection('admin-calendario-section')">Annulla</button>
          </div>
        </form>`;
    };
    
    window.saveRisultato = async(e, matchId)=>{
      e.preventDefault(); if(!isAdmin) return;
      const risultato = v('risultato-input').trim().toUpperCase();
      if(!risultato) return alert("Inserisci il risultato.");
      
      try{
        const updates = {};
        updates[`/calendario/${matchId}/risultato`] = risultato;
        
        await update(ref(db), updates);
        alert('Risultato salvato!');
        await loadProssimeGiornate(true);
        await loadStatistiche();
        window.showAdminSection('admin-calendario-section');
      }catch(err){ alert('Errore: '+err.message); }
    };

    // --- Admin: Gestione Dati (CRUD) ---
    
    window.loadCrudGiocatori = async()=>{
      const body = byId('crud-giocatori-body');
      body.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const data = snap.val()||{};
      const rows = Object.entries(data).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      if(!rows.length){ body.innerHTML = `<tr><td colspan="9"><div class="help">Nessun giocatore.</div></td></tr>`; return; }

      const ruoli = ['Portiere','Terzino sinistro','Terzino destro','Difensore centrale','Centrocampista centrale','Centrocampista sinistro','Centrocampista destro','Attaccante centrale'];
      const stati = ['Attivo','Infortunato','Sospeso'];

      for(const [id,g] of rows){
        const tr = document.createElement('tr');
        const avgVoto = (g.voto||0) / (g.presenze||1);
        tr.innerHTML = `
          <td><input data-gi="${id}" data-k="nome" value="${escapeHtml(g.nome||'')}" /></td>
          <td><input data-gi="${id}" data-k="cognome" value="${escapeHtml(g.cognome||'')}" /></td>
          <td><input data-gi="${id}" data-k="numero" type="number" value="${g.numero||''}" style="width:50px"/></td>
          <td>
            <select data-gi="${id}" data-k="ruolo">
              ${ruoli.map(r=>`<option value="${r}" ${g.ruolo===r?'selected':''}>${r}</option>`).join('')}
            </select>
          </td>
          <td>
            <select data-gi="${id}" data-k="stato">
              ${stati.map(s=>`<option value="${s}" ${g.stato===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td><input data-gi="${id}" data-k="presenze" type="number" value="${g.presenze||0}" style="width:50px"/></td>
          <td><input data-gi="${id}" data-k="goal" type="number" value="${g.goal||0}" style="width:50px"/></td>
          <td><input data-gi="${id}" data-k="voto" type="number" value="${g.voto||0}" style="width:50px"/></td>
          <td class="row" style="gap:6px">
            <button class="btn btn--admin" onclick="crudSaveGiocatore('${id}')">Salva</button>
            <button class="btn" onclick="crudDeleteGiocatore('${id}')">Elimina</button>
          </td>
        `;
        body.appendChild(tr);
      }
    };
    
    window.crudSaveGiocatore = async(id)=>{
      if(!isAdmin) return;
      const fields = byId('crud-giocatori-body').querySelectorAll(`[data-gi="${id}"]`);
      const updates = {};
      fields.forEach(f=>{
        let val = f.value;
        if(f.type==='number'){ val = +val; }
        if(f.dataset.k!=='nome' && f.dataset.k!=='cognome' && !val) { val=0; }
        updates[f.dataset.k] = val;
      });
      await update(ref(db,'rosa/'+id),updates);
      alert('Salvato.');
      window.loadCrudGiocatori(); loadRosa(); loadStatistiche();
    };

    window.crudDeleteGiocatore = async(id)=>{
      if(!isAdmin) return;
      if(!confirm('Eliminare questo giocatore?')) return;
      await remove(ref(db,'rosa/'+id));
      alert('Eliminato.');
      window.loadCrudGiocatori(); loadRosa();
    };

    window.loadCrudPartite = async ()=>{
      const body = byId('crud-partite-body');
      body.innerHTML='';
      const snap = await get(ref(db,'calendario'));
      const data = snap.val()||{};
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      const rows = Object.entries(data).sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
      if(!rows.length){ body.innerHTML = `<tr><td colspan="9"><div class="help">Nessuna partita.</div></td></tr>`; return; }

      for(const [id,m] of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input data-mi="${id}" data-k="avversaria" value="${escapeHtml(m.avversaria||'')}" /></td>
          <td><input data-mi="${id}" data-k="data" value="${escapeHtml(m.data||'')}" placeholder="gg/mm/aaaa" style="width:130px"/></td>
          <td><input data-mi="${id}" data-k="orario" value="${escapeHtml(m.orario||'')}" style="width:110px"/></td>
          <td><input data-mi="${id}" data-k="campo" value="${escapeHtml(m.campo||'')}" /></td>
          <td>
            <select data-mi="${id}" data-k="casa">
              <option value="true" ${m.casa?'selected':''}>Casa</option>
              <option value="false" ${!m.casa?'selected':''}>Trasferta</option>
            </select>
          </td>
          <td><input data-mi="${id}" data-k="risultato" value="${escapeHtml(m.risultato||'N/D')}" style="width:100px"/></td>
          <td>
            <select data-mi="${id}" data-k="formazionePubblicata">
              <option value="true" ${m.formazionePubblicata?'selected':''}>SÃ¬</option>
              <option value="false" ${!m.formazionePubblicata?'selected':''}>No</option>
            </select>
          </td>
          <td class="row" style="gap:6px">
            <button class="btn btn--admin" onclick="crudSavePartita('${id}')">Salva</button>
            <button class="btn" onclick="crudDeletePartita('${id}')">Elimina</button>
          </td>
          <td>
            <button class="btn" onclick="showCandidatureEditor('${id}','${escapeHtml(m.avversaria||'')}')">Candidature...</button>
          </td>
        `;
        body.appendChild(tr);
      }
    };
    
    window.crudSavePartita = async(id)=>{
      if(!isAdmin) return;
      const fields = byId('crud-partite-body').querySelectorAll(`[data-mi="${id}"]`);
      const updates = {};
      fields.forEach(f=>{
        let val = f.value;
        if(f.dataset.k==='casa' || f.dataset.k==='formazionePubblicata'){ val = val==='true'; }
        updates[f.dataset.k] = val;
      });
      await update(ref(db,'calendario/'+id),updates);
      alert('Salvato.');
      window.loadCrudPartite(); loadProssimeGiornate(true); loadProssimeGiornate(false);
    };

    window.crudDeletePartita = async(id)=>{
      if(!isAdmin) return;
      if(!confirm('Eliminare questa partita (e tutte le formazioni/candidature associate)?')) return;
      await remove(ref(db,'calendario/'+id));
      alert('Eliminata.');
      window.loadCrudPartite(); loadProssimeGiornate(true); loadProssimeGiornate(false);
    };

    // Admin: Gestione Candidature in CRUD
    let currentCandidatureMatchId = null;

    window.showCandidatureEditor = async(matchId, avversaria)=>{
      if(!isAdmin) return;
      currentCandidatureMatchId = matchId;
      byId('crud-candidature-title').textContent = `Candidature vs ${avversaria}`;
      byId('crud-partite').style.display='none';
      byId('crud-candidature').style.display='block';
      byId('crud-candidature-panel').style.display='block';
      
      const body = byId('crud-candidature-body');
      body.innerHTML = '<tr><td colspan="3">Caricamento...</td></tr>';

      const [snapUtenti, snapRosa, snapMatch] = await Promise.all([
        get(ref(db,'utenti')),
        get(ref(db,'rosa')),
        get(ref(db,`calendario/${matchId}`))
      ]);

      const utenti = snapUtenti.val() || {};
      const rosa = snapRosa.val() || {};
      const match = snapMatch.val() || {};
      const currentCandidature = match.candidature || {};

      const playerMap = Object.entries(rosa).reduce((acc, [id, g]) => {
        const key = `${g.nome} ${g.cognome}`;
        acc[key] = id; // Mappa Nome+Cognome -> Player ID
        return acc;
      }, {});

      const utentiData = Object.entries(utenti).map(([uid, u]) => ({
        uid: uid,
        nomeCompleto: `${u.nome} ${u.cognome}`.trim(),
        email: u.email,
        playerId: playerMap[`${u.nome} ${u.cognome}`] || null
      })).filter(u => u.playerId); // Filtra solo gli utenti collegati a un giocatore in rosa

      if(!utentiData.length){
         body.innerHTML = `<tr><td colspan="3"><div class="help">Nessun utente collegato a un giocatore della rosa.</div></td></tr>`;
         return;
      }
      
      body.innerHTML = utentiData.map(u => {
        const isCandidato = currentCandidature[u.uid] === true;
        return `
          <tr>
            <td>${escapeHtml(u.nomeCompleto)}</td>
            <td>${escapeHtml(u.email)}</td>
            <td><input type="checkbox" data-uid="${u.uid}" ${isCandidato ? 'checked' : ''} /></td>
          </tr>
        `;
      }).join('');
      
      byId('crud-candidature-save').onclick = () => saveCandidatureEditor(matchId);
    };

    const saveCandidatureEditor = async(matchId)=>{
      if(!isAdmin) return;
      const checkboxes = byId('crud-candidature-body').querySelectorAll('input[type="checkbox"]');
      const updates = {};
      checkboxes.forEach(cb => {
        updates[`/calendario/${matchId}/candidature/${cb.dataset.uid}`] = cb.checked;
      });
      
      await update(ref(db), updates);
      alert('Candidature salvate.');
      window.closeCandidatureEditor();
      loadProssimeGiornate(true); loadProssimeGiornate(false);
    };

    window.closeCandidatureEditor = ()=>{
      byId('crud-candidature-panel').style.display='none';
      byId('crud-candidature').style.display='none';
      byId('crud-partite').style.display='block';
    };

    // Admin: valutazioni (incrementi)
    window.showValutazioneForm = async ()=>{
      window.showAdminSection('admin-statistiche-section');
      const box = byId('admin-statistiche-form');
      box.innerHTML='';
      
      const snap = await get(ref(db,'rosa'));
      const val = snap.val()||{};
      const options = Object.entries(val).map(([id,g])=>`<option value="${id}">${g.nome} ${g.cognome} (#${g.numero})</option>`).join('');

      box.innerHTML = `
        <h3>Valutazione singolo giocatore (Incremento)</h3>
        <div class="help">Usa questa sezione per aggiungere valori dopo una partita. Per correzioni totali usa Gestione dati &rarr; Giocatori.</div>
        <form onsubmit="savePlayerStats(event)">
          <label>Giocatore</label>
          <select id="stat-player" required><option value="">Seleziona</option>${options}</select>
          <label>Voto (numero intero, somma progressiva)</label>
          <input id="stat-voto" type="number" step="1" value="0">
          <label>Presenze (incremento)</label>
          <input id="stat-presenze" type="number" step="1" value="0">
          <label>Goal (incremento)</label>
          <input id="stat-goal" type="number" step="1" value="0">
          <div class="actions"><button class="btn btn--admin" type="submit">Salva</button><button class="btn" type="button" onclick="showAdminSection('admin-calendario-section')">Torna alle partite</button></div>
        </form>`;
    };

    window.savePlayerStats = async (e)=>{
      e.preventDefault(); if(!isAdmin) return;
      const id = v('stat-player'); if(!id) return;
      const votoInc = +v('stat-voto')||0;
      const presInc = +v('stat-presenze')||0;
      const goalInc = +v('stat-goal')||0;
      
      const snap = await get(ref(db,'rosa/'+id));
      const g = snap.val();
      if(!g) return alert('Giocatore non trovato');
      
      const upd = { 
        voto:(g.voto||0)+votoInc,
        presenze:(g.presenze||0)+presInc,
        goal:(g.goal||0)+goalInc
      };
      
      await update(ref(db,'rosa/'+id),upd);
      alert('Statistiche aggiornate');
      window.showValutazioneForm();
      loadStatistiche();
    };

    // Admin: visualizzazione candidature compatta
    async function loadCandidature(){
      if(!isAdmin) return;
      const ul = byId('candidature-list');
      if(!ul) return;
      ul.innerHTML = 'Caricamento candidature...';

      const [snapUtenti, snapCal] = await Promise.all([
        get(ref(db,'utenti')),
        get(ref(db,'calendario'))
      ]);
      const utenti = snapUtenti.val()||{};
      const matches = snapCal.val()||{};
      let matchEntries = Object.entries(matches);
      
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      matchEntries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
      
      if(!matchEntries.length){ ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; return; }

      let html='';
      for(const [matchId, m] of matchEntries){
        const cand = m.candidature || {};
        const candidati = Object.keys(cand).filter(uid=>cand[uid]).map(uid=>{
          const u = utenti[uid];
          return u? `${u.nome||''} ${u.cognome||''}`.trim() || (u.email||uid) : uid;
        });

        html += `<li class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">vs ${m.avversaria} (${m.data})</div>
              <div class="player-sub">Candidati: <b>${candidati.length}</b></div>
            </div>
            <button class="btn" onclick="showCandidatureEditor('${matchId}','${escapeHtml(m.avversaria||'')}')">Modifica Candidature</button>
          </div>
          <div class="help" style="margin-top:8px">${candidati.join(', ') || 'Nessun candidato.'}</div>
        </li>`;
      }
      ul.innerHTML = html;
    }


  </script>

</head>
<body>

  <div id="video-modal">
    <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button" style="position:absolute; top:-10px; right:-10px; z-index:110; font-size:1.2rem; line-height:1.2;">Ã</button>
      <div id="video-iframe-container">
        </div>
    </div>
  </div>


  <header>
    <div class="hero">
      <img src="logo.png" alt="AC Tuscolano Logo">
      <div class="brand">
        <h1 class="club">AC Tuscolano</h1>
        <p class="tag">Gestione Squadra</p>
      </div>
      <button id="auth-toggle-btn" class="btn">Login</button>
    </div>
  </header>

  <div id="admin-menu">
    <div class="nav-wrap">
      <button class="tab" data-admin-target="admin-inserimento-giocatori-section" onclick="showAdminSection('admin-inserimento-giocatori-section')">Giocatori</button>
      <button class="tab" data-admin-target="admin-inserimento-giornate-section" onclick="showAdminSection('admin-inserimento-giornate-section')">Partita (Add)</button>
      <button class="tab" data-admin-target="admin-calendario-section" onclick="showAdminSection('admin-calendario-section')">Calendario (Edit)</button>
      <button class="tab" data-admin-target="admin-candidature-section" onclick="showAdminSection('admin-candidature-section')">Candidature</button>
      <button class="tab" data-admin-target="admin-gestione-dati-section" onclick="showAdminSection('admin-gestione-dati-section')">Gestione Dati</button>
      <button class="tab" data-admin-target="admin-statistiche-section" onclick="showValutazioneForm()">Valutazione</button>
      <button class="tab" data-admin-target="admin-utenti-section" onclick="showAdminSection('admin-utenti-section')">Utenti (Add)</button>
      <button class="tab" data-admin-target="admin-video-section" onclick="showAdminSection('admin-video-section')">Video</button>
    </div>
  </div>

  <nav>
    <div class="nav-wrap">
      <button class="tab" data-target="rosa-section" id="rosa-tab" onclick="showPublicSection('rosa-section')">Rosa</button>
      <button class="tab" data-target="calendario-section" id="calendario-tab" onclick="showPublicSection('calendario-section')">Calendario</button>
      <button class="tab" data-target="classifica-section" id="classifica-tab" onclick="showPublicSection('classifica-section')">Classifica</button>
      <button class="tab" data-target="statistiche-section" id="statistiche-tab" onclick="showPublicSection('statistiche-section')">Statistiche</button>
      <button class="tab" data-target="video-section" id="video-tab" onclick="showPublicSection('video-section')">Video</button>
    </div>
  </nav>

  <main>

    <section id="login-section" class="content-section" style="display:none">
      <h2>Accesso area admin</h2>
      <form id="login-form">
        <label>Email</label><input id="login-email" type="email" required />
        <label>Password</label><input id="login-password" type="password" required />
        <div class="actions"><button class="btn btn--accent" type="submit">Login</button></div>
      </form>
    </section>

    <section id="rosa-section" class="content-section">
      <h2>Rosa Giocatori</h2>
      <ul id="rosa-list"></ul>
    </section>

    <section id="calendario-section" class="content-section" style="display:none">
      <h2>Prossime Partite & Risultati</h2>
      <div class="help">Clicca "Candidatura" per dare disponibilitÃ . Se pubblicata, puoi vedere la formazione ufficiale. Ordinato dalla piÃ¹ recente.</div>
      <ul id="calendario-list" class="grid cols-3"></ul>
    </section>
    
    <section id="classifica-section" class="content-section" style="display:none">
      <h2>Classifica</h2>
      <div id="classifica-content" style="overflow-x:auto;">
        
      </div>
    </section>

    <section id="statistiche-section" class="content-section" style="display:none">
      <h2>Prestazioni</h2>
      
      <h3>Risultati squadra</h3>
      <ul id="statistiche-risultati-list" class="grid cols-2"></ul>
      
      <h3>Giocatori</h3>
      <ul id="statistiche-voti-list" class="grid cols-2"></ul>
    </section>
    
    <section id="video-section" class="content-section" style="display:none">
      <h2>Video Partite Concluse</h2>
      <ul id="video-list-ul" style="display:grid; gap:16px;">
        </ul>
    </section>

    <section id="formazione-pubblica-section" class="content-section" style="display:none">
      <h2>Formazione Ufficiale</h2>
      <div id="formazione-pubblica-content"></div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showPublicSection('calendario-section')">Torna al calendario</button></div>
    </section>

    <section id="admin-inserimento-giocatori-section" style="display:none">
      <h2>Admin Â· Inserimento giocatori</h2>
      <form id="giocatore-form" onsubmit="addPlayer(event)">
        <label>Nome</label><input id="giocatore-nome" required />
        <label>Cognome</label><input id="giocatore-cognome" required />
        <label>Numero maglia</label><input id="giocatore-numero" type="number" min="1" max="99" required />
        <label>Ruolo</label>
        <select id="giocatore-ruolo" required>
          <option value="">Seleziona</option>
          <option>Portiere</option>
          <option>Terzino sinistro</option>
          <option>Terzino destro</option>
          <option>Difensore centrale</option>
          <option>Centrocampista centrale</option>
          <option>Centrocampista sinistro</option>
          <option>Centrocampista destro</option>
          <option>Attaccante centrale</option>
        </select>
        <label>Stato</label>
        <select id="giocatore-stato" required>
          <option>Attivo</option>
          <option>Infortunato</option>
          <option>Sospeso</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Aggiungi giocatore</button></div>
      </form>
    </section>
    
    <section id="admin-inserimento-giornate-section" style="display:none">
      <h2>Admin Â· Inserimento Partita</h2>
      <form id="giornata-form">
        <label>Avversaria</label><input id="match-avversaria" required />
        <label>Data (gg/mm/aaaa)</label><input id="match-data" required />
        <label>Orario (hh:mm)</label><input id="match-orario" type="time" required />
        <label>Campo</label><input id="match-campo" placeholder="Es: 'Campo Roma' o 'Trasferta'" required />
        <label>Casa/Trasferta</label>
        <select id="match-casa" required>
          <option value="true">Casa</option>
          <option value="false">Trasferta</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Aggiungi Partita</button></div>
      </form>
    </section>

    <section id="admin-calendario-section" style="display:none">
      <h2>Admin Â· Calendario & Gestione Partite</h2>
      <div class="help">Usa i bottoni per gestire formazione e risultati. Ordinato dalla piÃ¹ recente.</div>
      <ul id="admin-calendario-list" class="grid cols-3"></ul>
    </section>

    <section id="admin-formazione-section" style="display:none">
      <h2 id="formazione-title">Admin Â· Formazione</h2>
      <div id="formazione-content">
        </div>
    </section>
    
    <section id="admin-statistiche-section" style="display:none">
      <h2 id="admin-statistiche-title">Admin Â· Statistiche & Risultato</h2>
      <div id="admin-statistiche-form">
        </div>
    </section>
    
    <section id="admin-candidature-section" style="display:none">
      <h2>Admin Â· Candidature</h2>
      <div class="help">Riassunto delle candidature per ogni partita. Clicca sul bottone per la gestione.</div>
      <ul id="candidature-list" style="display:grid; gap:16px;">
        </ul>
    </section>
    
    <section id="admin-gestione-dati-section" style="display:none">
      <h2>Admin Â· Gestione Dati (CRUD)</h2>
      <div class="actions">
        <button class="btn" onclick="document.getElementById('crud-giocatori').style.display='block';document.getElementById('crud-partite').style.display='none';window.loadCrudGiocatori()">Giocatori</button>
        <button class="btn" onclick="document.getElementById('crud-giocatori').style.display='none';document.getElementById('crud-partite').style.display='block';window.loadCrudPartite()">Partite</button>
      </div>

      <div id="crud-giocatori" style="display:block">
        <h3>Giocatori</h3>
        <div class="help">Modifica i campi e premi <b>Salva</b> o <b>Elimina</b>. Nota: per la media voto devi modificare il Voto totale.</div>
        <table class="table">
          <thead><tr>
            <th>Nome</th><th>Cognome</th><th>#</th><th>Ruolo</th><th>Stato</th><th>Pres.</th><th>Goal</th><th>Voto</th><th>Azioni</th>
          </tr></thead>
          <tbody id="crud-giocatori-body"></tbody>
        </table>
      </div>

      <div id="crud-partite" style="display:none">
        <h3>Partite</h3>
        <div class="help">Modifica i campi e premi <b>Salva</b> o <b>Elimina</b>. Apri <b>Candidatureâ¦</b> per impostare la disponibilitÃ  dei giocatori.</div>
        <table class="table">
          <thead><tr>
            <th>Avversaria</th><th>Data</th><th>Orario</th><th>Campo</th><th>Casa</th><th>Ris.</th><th>Publ. Form.</th><th>Azioni</th><th>Extra</th>
          </tr></thead>
          <tbody id="crud-partite-body"></tbody>
        </table>
      </div>
      
      <div id="crud-candidature" style="display:none">
        <h3 id="crud-candidature-title">Candidature</h3>
        <div id="crud-candidature-panel" class="card" style="display:none">
          <div class="help">Spunta i giocatori disponibili (richiede che il giocatore abbia un utente collegato con lo stesso Nome e Cognome in <code>/utenti</code>).</div>
          <table class="table">
            <thead><tr><th>Giocatore</th><th>UID collegato</th><th>Disponibile</th></tr></thead>
            <tbody id="crud-candidature-body"></tbody>
          </table>
          <div class="actions" style="margin-top:10px">
            <button id="crud-candidature-save" class="btn btn--admin" type="button">Salva candidature</button>
            <button class="btn" type="button" onclick="closeCandidatureEditor()">Chiudi</button>
          </div>
        </div>
      </div>
    </section>

    <section id="admin-utenti-section" style="display:none">
      <h2>Admin Â· Inserimento utenti</h2>
      <form id="create-user-form">
        <label>Nome Giocatore</label><input id="new-nome" required />
        <label>Cognome Giocatore</label><input id="new-cognome" required />
        <label>Email</label><input id="new-email" type="email" required />
        <label>Password</label><input id="new-password" type="password" required />
        <div class="actions"><button class="btn btn--admin" type="submit">Crea utenza</button></div>
      </form>
      <div class="help">Lâadmin resta connesso durante la creazione grazie allâautenticazione secondaria.</div>
    </section>
    
    <section id="admin-video-section" style="display:none">
      <h2>Admin Â· Gestione Video</h2>
      <div class="help">Associa un link YouTube valido (non accetta solo ID) a una partita conclusa.</div>
      <form onsubmit="event.preventDefault(); saveVideoLink();">
        <label for="video-partita-select">Seleziona Partita Conclusa</label>
        <select id="video-partita-select" required style="max-width: none !important;">
          <option value="">Caricamento...</option>
        </select>
        
        <label for="video-link-input" style="margin-top:15px;">Link YouTube</label>
        <input id="video-link-input" type="url" placeholder="Es: https://www.youtube.com/watch?v=VIDEO_ID" required />
        
        <div class="actions">
          <button id="save-video-btn" class="btn btn--admin" type="submit">Salva Link Video</button>
        </div>
      </form>
    </section>

  </main>

  <footer>
    <p>&copy; 2024 AC Tuscolano. Tutti i diritti riservati.</p>
  </footer>

</body>
</html>
