<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <script>
    /* ===== EFFETTO FADE NAVIGAZIONE (solo .content-section, fix visibilità completa) ===== */
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const target = tab.getAttribute('data-target');
          const current = document.querySelector('.content-section.active');
          const next = document.getElementById(target);
          if (!next || current === next) return;

          if (current) {
            current.style.opacity = '0';
            current.style.pointerEvents = 'none';
            setTimeout(() => {
              current.classList.remove('active');
              next.classList.add('active');
              next.style.opacity = '0';
              next.style.pointerEvents = 'all';
              setTimeout(() => { next.style.opacity = '1'; }, 50);
            }, 400);
          } else {
            next.classList.add('active');
            next.style.opacity = '1';
            next.style.pointerEvents = 'all';
          }

          // Aggiorna contenuto dinamico
          if (target === 'classifica-section' && typeof loadClassifica === 'function') {
            setTimeout(() => loadClassifica(), 600);
          }
        });
      });
      
      const firstSection = document.querySelector('.content-section') || document.querySelector('section');
      if (firstSection) firstSection.classList.add('active');
    });
  </script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }
    
    /* NUOVI STILI: Barre Voto */
    .voto-bar-container{
        background: #f0f0f0;
        border-radius: 8px;
        height: 8px;
        overflow: hidden;
        margin-top: 4px;
    }
    .voto-bar{
        height: 100%;
        transition: width var(--duration) var(--ease);
    }
    .voto-bar.red{ background-color: var(--red); }
    .voto-bar.yellow{ background-color: var(--yellow); }
    .voto-bar.green{ background-color: #0e7a0d; }


    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  

/* === Effetti di transizione per le sezioni visibili (.content-section) === */
.content-section {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
}
.content-section.active {
  opacity: 1;
  pointer-events: all;
}


</style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; // Usato nella sezione admin-video-section
    const MATCH_DURATION_MINUTES = 60; // Durata partita per calcolo sostituzioni

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section', 'prestazioni-partita-section', 'video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section', // Mantenuto per la logica di showFormazioneForm
      'admin-statistiche-section', // Mantenuta per il form "Risultato"
      'admin-prestazioni-partita-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section',
      'admin-classifica-section' // NUOVO
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; // Includo il login per nasconderlo

    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      ALL_SECTIONS.forEach(secId => { 
        const el = byId(secId); 
        if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
      });
      document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
      document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dall'admin
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); // Protezione base
        
        ALL_SECTIONS.forEach(secId => { 
          const el = byId(secId); 
          if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dal pubblico
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
            t.setAttribute('aria-current', t.dataset.adminTarget===id ? 'page' : 'false');
        });

        // Ricarica i dati specifici per la sezione admin (dal tuo codice originale)
        if(id==='admin-calendario-section'){ window.loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ loadCandidature(); }
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') loadPartitePerVideoAdmin(); 
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             // Se l'admin fa logout, torna alla sezione pubblica di default
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); // Nasconde il form di login dopo lo stato di auth
      toggleAdminUI(); // Aggiorna la UI
      
      // Assicura che una sezione sia visibile al cambio di stato
      if(user && isAdmin) {
         // Se admin loggato, mostra la sezione predefinita admin (es. inserimento giocatori)
         if(byId('admin-inserimento-giocatori-section').style.display === 'none'){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         // Se loggout o utente normale, mostra la sezione pubblica predefinita
         window.showPublicSection('rosa-section');
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          // Ricarica la sezione pubblica dopo il logout
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded',()=>{
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) – usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      window.showPublicSection('rosa-section');
      loadRosa(); 
      window.loadProssimeGiornate(false); // Carica calendario
      loadStatistiche(); // Carica solo risultati
      window.loadPrestazioniAggregato(); // Carica aggregato giocatori
      window.loadClassifica(); // Carica classifica da cache
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);

      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
      byId('rosa-tab')?.addEventListener('click', loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => window.loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', () => {
          loadStatistiche(); 
          window.loadPrestazioniAggregato();
      });
      byId('video-tab')?.addEventListener('click', loadVideoList);
      byId('classifica-tab')?.addEventListener('click', window.loadClassifica);
    });
    
    
    /**
     * NUOVA Funzione Classifica:
     * Legge SOLO dalla cache di Firebase.
     */
    window.loadClassifica = async () => {
      const classificaContent = byId('classifica-content');
      if (!classificaContent) return;
      classificaContent.innerHTML = `<div class="help">Caricamento classifica...</div>`;
      try {
        const snap = await get(ref(db, 'classifica_cache'));
        const cache = (snap.exists() && snap.val()) ? snap.val() : {};
        if (cache.html) {
          classificaContent.innerHTML = cache.html;
        } else {
          classificaContent.innerHTML = `<div class="help">Classifica non ancora disponibile. L'amministratore deve aggiornarla.</div>`;
        }
      } catch (e) {
        console.error("Errore caricamento classifica:", e);
        classificaContent.innerHTML = `<div class="help" style="color:red">Errore caricamento classifica.</div>`;
      }
    };

    /**
     * NUOVA Funzione Admin:
     * Aggiorna la classifica dal sito e la salva su Firebase.
     */
    window.updateClassificaFromSito = async () => {
      if (!isAdmin) return alert('Accesso negato. Solo gli amministratori possono aggiornare la classifica.');
      
      alert('Aggiornamento classifica in corso... Attendere prego.');

      try {
        const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
        const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
        const response = await fetch(proxy);
        const data = await response.json();

        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "text/html");

        const remoteTable = doc.querySelector(".table-responsive table, table.table, table");
        if (!remoteTable) {
          alert('Errore: Impossibile trovare la tabella della classifica sul sito remoto.');
          return;
        }

        // Riduci loghi
        remoteTable.querySelectorAll("img").forEach(img => {
          img.style.maxWidth = "25px";
          img.style.height = "auto";
          img.style.verticalAlign = "middle";
        });

        // Estrai intestazioni e righe
        const headerNodes = remoteTable.querySelectorAll("thead th");
        const headers = headerNodes.length ? Array.from(headerNodes).map(th => th.textContent.trim())
          : Array.from(remoteTable.querySelectorAll("tr:first-child th, tr:first-child td")).map(el => el.textContent.trim());

        const rows = remoteTable.querySelectorAll("tbody tr");
        const bodyRows = rows.length ? Array.from(rows) : Array.from(remoteTable.querySelectorAll("tr")).slice(1);

        // Calcola numero colonne e larghezze uniformi
        const colCount = headers.length || (bodyRows[0]?.children.length || 8);
        const widthPercent = (100 / colCount).toFixed(4) + '%';

        // Costruisci thead
        let theadHTML = '';
        if (headers.length) {
          theadHTML = '<thead><tr>' + headers.map(h => 
            `<th style="width:${widthPercent};padding:8px;text-align:center;border-bottom:2px solid #ccc;background:#8B0000;color:#fff;font-weight:600;font-size:14px;word-wrap:break-word">${h}</th>`
          ).join('') + '</tr></thead>';
        }

        // Costruisci tbody con celle uniformi
        const tbodyHTML = bodyRows.map((tr, idx) => {
          const cells = Array.from(tr.children);
          const rowHTML = cells.map(td => 
            `<td style="width:${widthPercent};padding:8px;text-align:center;border-bottom:1px solid #ddd;font-size:13px;word-wrap:break-word">${td.innerHTML}</td>`
          ).join('');
          const bg = idx % 2 === 1 ? ' style="background:#f8f8f8"' : '';
          return `<tr${bg}>${rowHTML}</tr>`;
        }).join('');

        const normalizedHTML = `
          <div class="help">Classifica aggiornata manualmente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
          <div style="overflow-x:auto">
            <table class="table" style="width:100%;border-collapse:collapse;table-layout:fixed;margin-top:8px">
              ${theadHTML}
              <tbody>${tbodyHTML}</tbody>
            </table>
          </div>
          <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
        `;

        // Salva cache
        await set(ref(db, 'classifica_cache'), {
          html: normalizedHTML,
          timestamp: Date.now()
        });

        // Aggiorna la vista
        await window.loadClassifica();
        alert('Classifica aggiornata con successo!');

      } catch (e) {
        console.error('Errore aggiornamento classifica:', e);
        alert('Errore durante l\'aggiornamento della classifica: ' + e.message);
      }
    };


    /* ===== NUOVE FUNZIONI VIDEO (INTEGRATE) ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; // Ferma la riproduzione
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); // Usa 'calendario' come il resto del tuo codice
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => {
          const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const dateA = toDate(partite[a].data);
          const dateB = toDate(partite[b].data);
          return dateB - dateA;
        });

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="window.openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    // Carica le partite per il menu a tendina Admin (solo quelle concluse)
    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // Aggiorna il campo input quando la partita selezionata cambia
    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    // Salva il link video nel database
    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");

      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");

      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;

        await update(ref(db), updates);

        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); // Aggiorna anche la sezione pubblica immediatamente
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Originali dell'Utente (Integrate) ===== */
    
    async function loadRosa(){
      const ul = byId('rosa-list'); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const val = snap.val() || {};
      const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      if(!rows.length){ ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>'; return; }
      ul.className='grid cols-2';
      rows.forEach(([id,g])=>{
        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
              <div class="player-sub">Ruolo: <b>${g.ruolo}</b> • Stato: <b>${g.stato}</b></div>
            </div>
          </div>`;
        ul.appendChild(li);
      });
    }

    /**
     * FUNZIONE loadProssimeGiornate 
     * Include il pulsante "Prestazioni" (pubblico) e RIMUOVE "Valuta" (admin)
     * Layout pulsanti pubblici corretto (singola riga)
     *
     * MODIFICA: Aggiunto calcolo e visualizzazione ESITO (VITTORIA, PAREGGIO, SCONFITTA)
     */
    window.loadProssimeGiornate = async function(asAdmin){
      const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
      const ul = byId(listId); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'calendario'));
      const val = snap.val() || {};
      let entries = Object.entries(val);
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      const today = new Date(); today.setHours(0,0,0,0);
      entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
      if(!entries.length){ ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; return; }
      ul.className='grid cols-3';
      for(const [matchId,m] of entries){
        const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
        const cand = candSnap.val() || {};
        const candCount = Object.values(cand).filter(Boolean).length;
        const isPublished = m.formazionePubblicata === true;
        const matchDate = toDate(m.data);
        const isPast = matchDate < today;

        // Candidatura
        let candButton = '';
        if (isPast) {
          candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`;
        } else {
          candButton = `<button class="btn btn--accent" onclick="candidati('${matchId}')">Candidatura</button>`;
        }

        // Prestazioni: sempre mostrato. Attivo solo se partita passata con risultato valido.
        let prestazioniBtn = '';
        const risultatoValido = (m.risultato && m.risultato !== 'N/D');
        if (isPast && risultatoValido) {
          // Passa anche il nome avversaria alla funzione
          prestazioniBtn = `<button class="btn" onclick="showPrestazioniPubbliche('${matchId}','${escapeHtml(m.avversaria||'')}')">Prestazioni</button>`;
        } else {
          prestazioniBtn = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Prestazioni</button>`;
        }

        // NUOVA LOGICA: Calcolo Esito per display in Calendario [MODIFICA 1: ESITO]
        let esitoPill = '';
        if (m.risultato && m.risultato !== 'N/D') {
          const [scoreCasa, scoreOspite] = m.risultato.split('-').map(s => parseInt(s.trim()));
          if (!isNaN(scoreCasa) && !isNaN(scoreOspite)) {
            let esito = '';
            let esitoColor = '';
            // AC Tuscolano score depends on 'casa' flag
            const scoreTuscolano = m.casa ? scoreCasa : scoreOspite;
            const scoreAvversaria = m.casa ? scoreOspite : scoreCasa;
            if (scoreTuscolano > scoreAvversaria) {
              esito = 'VITTORIA';
              esitoColor = 'background:#0e7a0d; color:#fff;'; // Green
            } else if (scoreTuscolano < scoreAvversaria) {
              esito = 'SCONFITTA';
              esitoColor = 'background:var(--red); color:#fff;'; // Red
            } else {
              esito = 'PAREGGIO';
              esitoColor = 'background:var(--yellow); color:#111;'; // Yellow
            }
            // Add the esito pill to be displayed
            esitoPill = `<span class="pill" style="${esitoColor} margin-left: 10px; flex-shrink:0;">${esito}</span>`;
          }
        }
        // FINE NUOVA LOGICA

        const li = document.createElement('li'); li.className = 'card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start; width:100%;">
            <div>
              <div class="player-title" style="display:flex; align-items:center;">
                vs ${escapeHtml(m.avversaria)} ${m.risultato && m.risultato !== 'N/D' ? `(${m.risultato})` : ''} ${esitoPill}
              </div>
              <div class="player-sub">
                ${m.data} ${m.orario ? `• ${m.orario}` : ''}<br>
                Campo: ${escapeHtml(m.campo)} • ${m.casa ? 'Casa' : 'Trasferta'}
              </div>
              ${!isPast && candCount > 0 && !asAdmin ? `<div class="pill" style="margin-top:4px;">${candCount} disponibilità</div>` : ''}
            </div>
            <div class="actions" style="margin:0; flex:0 0 auto; display:flex; flex-direction:column; gap:6px;">
              ${asAdmin ? `
                <button class="btn btn--admin" onclick="showFormazioneForm('${matchId}','${escapeHtml(m.avversaria||'')}')">Formazione</button>
                <button class="btn btn--admin" onclick="openCandidatureEditor('${matchId}','${escapeHtml(m.avversaria||'')}')">${candCount} Candidature</button>
                ${isPast ? `<button class="btn btn--admin" onclick="showValutazionePartitaForm('${matchId}','${escapeHtml(m.avversaria||'')}')">Valuta</button>` : ''}
              ` : `
                ${isPublished ? `<button class="btn" onclick="showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria||'')}')">Formazione</button>` : ''}
                ${candButton}
                ${prestazioniBtn}
              `}
            </div>
          </div>`;
        ul.appendChild(li);
      }
    };
    
    // Funzione Pubblica: Gestione Candidatura
    window.candidati = async (matchId) => {
      const user = auth.currentUser;
      if(!user) return alert("Devi effettuare l'accesso per candidarti.");

      const snap = await get(ref(db,`utenti/${user.uid}`));
      const userData = snap.val();
      if(!userData || !userData.nome || !userData.cognome) return alert("I tuoi dati (nome e cognome) non sono completi. Contatta l'amministratore.");
      
      const conf = confirm("Confermi la tua disponibilità per questa partita?");
      if(conf){
        const updates = {};
        updates[`/calendario/${matchId}/candidature/${user.uid}`] = true;
        await update(ref(db), updates);
        alert('Candidatura confermata! Grazie.');
        window.loadProssimeGiornate(false); // Ricarica il calendario
      }
    };
    
    // Funzione Pubblica: Mostra Formazione
    window.showFormazionePubblica = async (matchId, avv) => {
      const content = byId('formazione-pubblica-content');
      content.innerHTML = 'Caricamento formazione...';
      window.showPublicSection('formazione-pubblica-section');

      const [snapRosa, snapMatch] = await Promise.all([ 
        get(ref(db,'rosa')), 
        get(ref(db,`calendario/${matchId}`)) 
      ]);
      
      const rosa = snapRosa.val() || {};
      const matchData = snapMatch.val() || {};
      const allFormations = matchData.formazioni || {};
      const panchinaIds = matchData.panchina || [];
      const sostituzioni = matchData.sostituzioni || [];
      
      if (Object.keys(allFormations).length === 0) {
        content.innerHTML = `<h3>Formazione vs ${escapeHtml(avv)}</h3><p>Formazione non ancora pubblicata.</p>`;
        return;
      }
      
      // Visualizza tutte le formazioni (pre-esistente)
      const formationMaps = allFormations;
      
      const html = [];
      html.push(`<h2>Formazione Ufficiale vs ${escapeHtml(avv)}</h2>`);
      
      // 1. Titolari iniziali (minuto 0)
      const titolariIniziali = allFormations['0']?.formazione || {};
      
      html.push(`<h4>Titolari (Inizio Partita)</h4>`);
      html.push(`<div class="field">`);
      Object.entries(titolariIniziali).forEach(([ruolo, pid])=>{
        const pl = rosa[pid];
        const pos = POS_331[ruolo]; // Usa POS_331 globale
        if(!pl||!pos) return;
        const cognome = pl.cognome;
        html.push(`
          <div class="marker" style="top:${pos.top}; left:${pos.left}">
            <b>${escapeHtml(cognome)}</b><br>${ruolo}
          </div>
        `);
      });
      html.push(`</div>`);
      
      // 2. Panchina
      if (panchinaIds.length > 0) {
        html.push(`<h4>Panchina</h4>`);
        html.push(`<ul class="grid cols-3">`);
        panchinaIds.forEach(pid => {
          const pl = rosa[pid];
          if (pl) {
            html.push(`<li class="card"><b>${escapeHtml(pl.nome)} ${escapeHtml(pl.cognome)}</b> (#${pl.numero})</li>`);
          }
        });
        html.push(`</ul>`);
      }
      
      // 3. Sostituzioni
      if (sostituzioni.length > 0) {
        html.push(`<h4>Sostituzioni Effettuate</h4>`);
        html.push(`<ul class="grid cols-2">`);
        sostituzioni.forEach(s => {
          // Trova nome giocatore
          const plEntra = rosa[s.entra];
          const plEsce = rosa[s.esce];
          html.push(`
            <li class="card">
              <div style="font-weight:700">Minuto ${s.minuto}</div>
              Entra: <b>${plEntra ? plEntra.cognome : '?'}</b> • Esce: <b>${plEsce ? plEsce.cognome : '?'}</b>
            </li>
          `);
        });
        html.push(`</ul>`);
      }
      
      content.innerHTML = html.join('');
    };

    // Funzione Pubblica: Mostra Prestazioni Partita
    window.showPrestazioniPubbliche = async (matchId, avv) => {
      const content = byId('prestazioni-partita-content');
      content.innerHTML = 'Caricamento prestazioni...';
      window.showPublicSection('prestazioni-partita-section');
      
      try {
        const prestsPath = `prestazioni/${matchId}`;
        const [snapRosa, snapPrests, snapCandidature] = await Promise.all([ 
          get(ref(db, 'rosa')), 
          get(ref(db, prestsPath)),
          get(ref(db, `calendario/${matchId}/candidature`))
        ]);
        
        const rosa = snapRosa.val() || {};
        const prestazioni = snapPrests.val() || {};
        const candidature = snapCandidature.val() || {};
        
        // Filtra solo i giocatori candidati (o comunque presenti nel DB prestazioni)
        const availablePids = new Set(Object.keys(prestazioni));
        
        const finalRows = Object.entries(prestazioni)
          .filter(([pid, data]) => availablePids.has(pid)) // FILTRA PER CANDIDATURA (implicitamente, perché le prestazioni sono inserite solo per i candidati)
          .map(([pid, data]) => {
            const player = rosa[pid] || { nome: 'Giocatore', cognome: 'Sconosciuto', numero: '?' };
            let voto = data.voto; 
            // Formatta il voto
            if (voto === null || Number.isNaN(voto)) {
              voto = '—';
            }
            return {
              nome: `${player.nome} ${player.cognome}`,
              numero: player.numero,
              voto: voto,
              goal: data.goal || 0 // goal is always a number (or 0)
            };
          })
          // Ordina per Voto (numeri prima, '—' dopo), poi Goal
          .sort((a, b) => {
            const votoA = a.voto === '—' ? -1 : a.voto;
            const votoB = b.voto === '—' ? -1 : b.voto;
            if (votoB !== votoA) return votoB - votoA;
            return (b.goal || 0) - (a.goal || 0);
          });

        if (finalRows.length === 0) {
          content.innerHTML = `<h3>vs ${escapeHtml(avv)}</h3><p>Nessun giocatore ha ricevuto prestazioni per questa partita.</p>`;
          return;
        }

        let tableHtml = `<table class="table"><thead><tr><th>#</th><th>Giocatore</th><th>Voto</th><th>Goal</th></tr></thead><tbody>`;
        finalRows.forEach(r => {
          tableHtml += `<tr><td>${r.numero}</td><td>${escapeHtml(r.nome)}</td><td><b>${r.voto}</b></td><td>${r.goal}</td></tr>`;
        });
        tableHtml += `</tbody></table>`;

        content.innerHTML = `<h2>Prestazioni Partita vs ${escapeHtml(avv)}</h2>` + tableHtml;
      } catch (err) {
        console.error('Errore caricamento prestazioni partita:', err);
        content.innerHTML = `<h2>Prestazioni Partita vs ${escapeHtml(avv)}</h2><p style="color:red">Impossibile caricare le prestazioni.</p>`;
      }
    };


    // Funzione Statistiche (Risultati Partite)
    async function loadStatistiche(){
      const ul = byId('statistiche-risultati-list');
      if(!ul) return;
      ul.innerHTML='<li>Caricamento risultati...</li>';
      const snap = await get(ref(db,'calendario'));
      const val = snap.val() || {};
      let entries = Object.entries(val);
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
      ul.innerHTML='';

      for(const [matchId, p] of entries){
        if (p.risultato && p.risultato !== 'N/D') {
          let esitoPill = `<span class="pill" style="background:#ccc; color:#555; padding:2px 8px;">N/D</span>`;
          const [scoreCasa, scoreOspite] = p.risultato.split('-').map(s => parseInt(s.trim()));
          
          if (!isNaN(scoreCasa) && !isNaN(scoreOspite)) {
            let esito = '';
            let esitoColor = '';
            
            // AC Tuscolano score depends on 'casa' flag
            const scoreTuscolano = p.casa ? scoreCasa : scoreOspite;
            const scoreAvversaria = p.casa ? scoreOspite : scoreCasa;
            
            if (scoreTuscolano > scoreAvversaria) {
              esito = 'VITTORIA';
              esitoColor = 'background:#0e7a0d; color:#fff;'; // Green
            } else if (scoreTuscolano < scoreAvversaria) {
              esito = 'SCONFITTA';
              esitoColor = 'background:var(--red); color:#fff;'; // Red
            } else {
              esito = 'PAREGGIO';
              esitoColor = 'background:var(--yellow); color:#111;'; // Yellow
            }
            esitoPill = `<span class="pill" style="${esitoColor} padding:2px 8px; font-size:.75rem">${esito}</span>`;
          }

          const li = document.createElement('li'); 
          li.className = 'card';
          li.style.marginBottom = '6px';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          li.style.padding = '10px 16px';
          
          li.innerHTML = `
            <div style="flex: 0 0 100px;">${p.data || 'N/D'}</div>
            <div style="flex: 1;">vs ${escapeHtml(p.avversaria)}</div>
            <div style="flex: 0 0 80px; text-align:center;"><b>${p.risultato}</b></div>
            <div style="flex: 0 0 100px; text-align:right;">${esitoPill}</div>
          `;
          ul.appendChild(li);
        }
      }
      if(ul.children.length === 0){
        ul.innerHTML = '<li><div class="help">Nessun risultato inserito.</div></li>';
      }
    }

    /**
     * NUOVA FUNZIONE: Calcolo e Visualizzazione Prestazioni Aggregate (Media Voti e Goal)
     */
    window.loadPrestazioniAggregato = async () => {
      const content = byId('prestazioni-aggregate-content');
      const container = byId('prestazioni-aggregate-list');
      if (!content) return;
      content.querySelector('.help').textContent = 'Calcolo in corso...';
      
      try {
        const [snapRosa, snapPrests] = await Promise.all([
          get(ref(db, 'rosa')),
          get(ref(db, 'prestazioni'))
        ]);
        
        const rosa = snapRosa.val() || {};
        const prestazioniPerPartita = snapPrests.val() || {};
        
        const aggregatedData = {}; // pid -> { nome, cognome, numero, totalVoto, countVoto, goal, partite }

        // 1. Aggrega i dati da tutte le partite
        Object.values(prestazioniPerPartita).forEach(prestazioniPartita => {
          Object.entries(prestazioniPartita).forEach(([pid, data]) => {
            if (!rosa[pid]) return; // Salta se il giocatore non esiste più

            if (!aggregatedData[pid]) {
              aggregatedData[pid] = {
                nome: rosa[pid].nome,
                cognome: rosa[pid].cognome,
                numero: rosa[pid].numero,
                totalVoto: 0,
                countVoto: 0,
                goal: 0,
                partite: 0
              };
            }

            const agg = aggregatedData[pid];
            agg.partite++;
            agg.goal += (data.goal || 0);

            // Solo conta se il voto è un numero (esclude null o NaN)
            const voto = data.voto;
            if (typeof voto === 'number' && !isNaN(voto)) {
              agg.totalVoto += voto;
              agg.countVoto++;
            }
          });
        });

        // 2. Calcola la media e ordina
        const rows = Object.values(aggregatedData).map(a => {
          const media = a.countVoto > 0 ? a.totalVoto / a.countVoto : null;
          return { ...a, mediaVoto: media !== null ? Number(media.toFixed(2)) : null };
        }).sort((a,b)=> {
          // Ordina per media voto (decrescente), poi goal (decrescente)
          const am = a.mediaVoto===null ? -1 : a.mediaVoto;
          const bm = b.mediaVoto===null ? -1 : b.mediaVoto;
          
          if (bm !== am) return bm - am;
          if (b.goal !== a.goal) return b.goal - a.goal;
          
          return a.nome.localeCompare(b.nome);
        });

        // 3. Genera HTML
        const rowsHtml = rows.map(r => {
          let mediaVotoDisplay = '—';
          let bar = '';
          
          if (r.mediaVoto !== null) {
            const votoNum = r.mediaVoto;
            mediaVotoDisplay = `<b>${votoNum.toFixed(2)}</b>`;
            
            // Calcolo barra (0 a 100%)
            const perc = Math.max(0, Math.min(100, Math.round((votoNum/10)*100)));
            const color = (votoNum >= 7 ? 'green' : (votoNum >= 6 ? 'yellow' : 'red'));
            
            bar = `
              <div class="voto-bar-container">
                <div class="voto-bar ${color}" style="width:${perc}%;"></div>
              </div>`;
          }
          
          return `
            <li class="card">
              <div class="row" style="justify-content:space-between; align-items:flex-start;">
                <div>
                  <div class="player-title">${r.nome} ${r.cognome} <span class="pill">#${r.numero}</span></div>
                  <div class="player-sub">Partite con voto: <b>${r.countVoto}</b> su ${r.partite} giocate.</div>
                </div>
                <div style="text-align:right;">
                  <div class="player-title">Voto Medio: ${mediaVotoDisplay}</div>
                  <div class="player-sub">Goal: <b>${r.goal}</b></div>
                </div>
              </div>
              ${bar}
            </li>`;
        }).join('');

        const finalHtml = `<ul id="prestazioni-aggregate-list" class="grid cols-2">${rowsHtml}</ul>`;

        content.querySelector('.help').textContent = `Dati aggregati da ${Object.keys(prestazioniPerPartita).length} partite.`;
        if(container) container.innerHTML = rowsHtml;
        else content.innerHTML += finalHtml;


      } catch (e) {
        console.error("Errore caricamento aggregato:", e);
        content.querySelector('.help').textContent = `Errore nel caricamento dei dati aggregati.`;
      }
    };
    
    /* Posizioni modulo 3-3-1 (Calcio a 8) */
    const POS_331 = {
      'Portiere': { top: '50%', left: '8%' },
      'Difensore centrale': { top: '50%', left: '30%' },
      'Terzino destro': { top: '25%', left: '20%' },
      'Terzino sinistro': { top: '75%', left: '20%' },
      'Centrocampista centrale': { top: '50%', left: '50%' },
      'Centrocampista destro': { top: '25%', left: '50%' },
      'Centrocampista sinistro': { top: '75%', left: '50%' },
      'Attaccante centrale': { top: '50%', left: '78%' }
    };
    
    /* ===== Admin: Modulo Formazione (Più complesso) ===== */

    window.showFormazioneForm = async (matchId, avv) => {
      if(!isAdmin) return;
      window.showAdminSection('admin-formazione-section');
      const formContainer = byId('formazione-form-container');
      formContainer.innerHTML = 'Caricamento giocatori e formazioni...';
      
      // 1. Fetch Dati
      const [snapRosa, snapCandidature, snapUtenti, snapMatch] = await Promise.all([
        get(ref(db,'rosa')),
        get(ref(db,`calendario/${matchId}/candidature`)),
        get(ref(db,'utenti')),
        get(ref(db,`calendario/${matchId}`))
      ]);

      const val = snapRosa.val()||{};
      const candidatureMap = snapCandidature.val()||{};
      const utentiMap = snapUtenti.val()||{};
      const matchData = snapMatch.val() || {};
      
      const currentTitolari = matchData.formazioni?.['0']?.formazione || {};
      const currentPanchina = matchData.panchina || [];
      const substitutions = matchData.sostituzioni || [];
      const allFormations = matchData.formazioni || {};
      
      // Helper: Mappa nome completo -> UID
      const nameToUid = {};
      Object.entries(utentiMap).forEach(([uid,u])=>{
        if(u.nome&&u.cognome) nameToUid[`${u.nome} ${u.cognome}`]=uid;
      });

      // 2. Filtrare i giocatori disponibili (candidati)
      const availablePlayers = Object.entries(val).map(([id, g]) => {
        const playerName = `${g.nome} ${g.cognome}`;
        const uid = nameToUid[playerName];
        const isAvailable = uid && candidatureMap[uid] === true;
        
        // Recupera 'presenze' da /rosa (come dato manuale o fallback)
        const presenze = g.presenze || 0; 
        
        return { 
          id, uid, isAvailable, nome:g.nome, cognome:g.cognome, numero:g.numero, 
          ruolo: g.ruolo, presenze: presenze, 
          label: `${g.nome} ${g.cognome} (#${g.numero}) — ${presenze} pres.` 
        };
      }).filter(p => p.isAvailable)
      .sort((a, b) => (a.presenze - b.presenze) || a.ruolo.localeCompare(b.ruolo));

      if (availablePlayers.length < 8) {
        formContainer.innerHTML = `<h3>Formazione vs ${escapeHtml(avv)}</h3><p style="color:red">Attenzione: Solo ${availablePlayers.length} giocatori hanno dato disponibilità. Servono almeno 8.</p>`;
        return;
      }
      
      // Helper per generare le opzioni del select, selezionando l'ID corrente
      const opts = (currentId, roleFilter = null) => {
        let options = '<option value="">Seleziona...</option>';
        availablePlayers.forEach(p => {
          if (roleFilter && p.ruolo !== roleFilter) return;
          const selected = p.id === currentId ? 'selected' : '';
          options += `<option value="${p.id}" ${selected}>${p.label}</option>`;
        });
        return options;
      };
      
      // Mappa delle posizioni (basata sulle chiavi di POS_331)
      const roles = Object.keys(POS_331);
      
      // Funzioni per raccogliere i dati dal form
      const collectTitolariMap = () => {
        const map = {};
        roles.forEach(role => {
          map[role] = v(`titolare-${role}`);
        });
        return map;
      };

      const collectPanchina = () => {
        const panchina = [];
        for(let i=1; i<=availablePlayers.length - 8; i++) {
          panchina.push(v(`panchina-${i}`));
        }
        return panchina.filter(Boolean); // Rimuove le stringhe vuote
      };

      const collectSubstitutions = () => {
          const subs = [];
          for(let i=1; i<=5; i++) {
              const minuto = parseInt(v(`minuto-${i}`) || '0', 10);
              const entra = v(`entra-${i}`);
              const esce = v(`esce-${i}`);
              if (minuto > 0 && entra && esce) {
                  subs.push({ minuto, entra, esce });
              }
          }
          // Riordina per minuto
          return subs.sort((a,b)=>a.minuto-b.minuto);
      };
      
      // --- Generazione UI ---
      let html = `
        <h2>Admin · Formazione vs ${escapeHtml(avv)}</h2>
        <form id="formazione-match-form">
          <div class="grid cols-2">
            <div id="titolari" class="card">
              <h3>Titolari (8)</h3>
              ${roles.map(role => {
                const currentId = currentTitolari[role] || '';
                return `
                  <label>${role}</label>
                  <select id="titolare-${role}" data-role="${role}">${opts(currentId, role)}</select>
                `;
              }).join('')}
            </div>
            <div id="preview-field-container">
              <h3>Anteprima Formazione</h3>
              <div id="preview-field" class="field"></div>
            </div>
          </div>
          
          <div id="panchina" class="card" style="margin-top:16px;">
            <h3>Panchina (max ${availablePlayers.length - 8})</h3>
            <div id="panchina-selects" class="grid cols-3">
            ${(new Array(availablePlayers.length - 8).fill(0)).map((_, i) => {
              const panchinaId = currentPanchina[i] || '';
              return `
                <div>
                  <label>Riserva ${i+1}</label>
                  <select id="panchina-${i+1}" data-panchina-idx="${i}"></select>
                </div>
              `;
            }).join('')}
            </div>
          </div>
          
          <div id="sostituzioni" class="card" style="margin-top:16px;">
            <h3>Sostituzioni (Max 5)</h3>
            <div id="substitutions-container">
              </div>
          </div>

          <div class="actions">
            <button class="btn btn--accent" type="submit" onclick="saveFormation(event,'${matchId}','${avv}', ${JSON.stringify(allFormations)})">Salva Formazione</button>
            ${matchData.formazionePubblicata ? 
              `<button class="btn" type="button" onclick="window.confirmPublish('${matchId}', false)">Nascondi Formazione</button>` :
              `<button class="btn btn--admin" type="button" onclick="window.confirmPublish('${matchId}', true)">Pubblica Formazione</button>`
            }
          </div>
          <div id="all-formations-preview">
            <h3>Storico Formazioni Salvate</h3>
            <div id="formations-preview-content"></div>
          </div>
        </form>
      `;
      formContainer.innerHTML = html;
      
      // Funzione per aggiornare il contenuto dei select di panchina e rendere le sostituzioni
      const renderPanchinaAndSubstitutions = (titolariInizialiIds, currentPanchinaIds) => {
        // 1. Aggiorna i select della panchina
        document.querySelectorAll('#panchina select').forEach((select, i) => {
          const panchinaId = currentPanchinaIds[i] || '';
          // Giocatori disponibili per la panchina: non titolari, non già in panchina.
          const panchinaOptions = availablePlayers
            .filter(p => !titolariInizialiIds.includes(p.id) && 
                          (currentPanchinaIds.findIndex(id => id === p.id) === -1 || p.id === panchinaId))
            .map(p => {
              const selected = p.id === panchinaId ? 'selected' : '';
              return `<option value="${p.id}" ${selected}>${p.label}</option>`;
            }).join('');
          select.innerHTML = '<option value="">Seleziona...</option>' + panchinaOptions;
          select.value = panchinaId;
        });

        // 2. Renderizza l'UI delle Sostituzioni
        renderSubstitutionsUI(titolariInizialiIds, currentPanchinaIds, substitutions);
        visualizeAllFormations(avv, allFormations); // Aggiorna anche lo storico formazioni
      };

      const renderSubstitutionsUI = (titolariInizialiIds, panchinaIds, currentSubs) => {
          const container = byId('substitutions-container');
          container.innerHTML = '';
          
          // Mappa lo stato attuale di chi può entrare/uscire
          let availableForSubIn = [...panchinaIds]; // Lista di chi è in panchina e non è ancora entrato
          let currentInField = [...titolariInizialiIds]; // Lista di chi è in campo
          
          let subRowsHTML = '';
          
          for(let i=1; i<=5; i++){
              const sub = currentSubs[i-1] || {};
              const minuto = sub.minuto || '';
              const entraSel = sub.entra || '';
              const esceSel = sub.esce || '';
              
              // Calcola le opzioni per "Entra"
              const entraOptions = availablePlayers
                  .filter(p => availableForSubIn.includes(p.id)) // Solo chi può ancora entrare
                  .map(p => {
                      const selected = p.id === entraSel ? 'selected' : '';
                      return `<option value="${p.id}" ${selected}>${p.label}</option>`;
                  }).join('');
                  
              // Calcola le opzioni per "Esce"
              const esceOptions = availablePlayers
                  .filter(p => currentInField.includes(p.id) && !panchinaIds.includes(p.id)) // Solo chi è in campo e non è riserva (cioè titolare iniziale)
                  .map(p => {
                      const role = Object.keys(collectTitolariMap()).find(r => collectTitolariMap()[r] === p.id);
                      const selected = p.id === esceSel ? 'selected' : '';
                      return `<option value="${p.id}" ${selected}>${p.label} (${role || 'N/D'})</option>`;
                  }).join('');
                  
              // Aggiorna lo stato per il prossimo turno se la sostituzione è valida
              if (entraSel && esceSel && minuto > 0) {
                  // Rimuovi chi è entrato dalla lista 'availableForSubIn'
                  availableForSubIn = availableForSubIn.filter(id => id !== entraSel);
                  
                  // Aggiorna chi è in campo
                  currentInField = currentInField.filter(id => id !== esceSel);
                  currentInField.push(entraSel);
              }
              
              subRowsHTML += `
                  <div class="row card" style="align-items:flex-end; padding:8px;">
                      <div style="flex:1;"><label>Minuto</label><input id="minuto-${i}" type="number" min="1" max="${MATCH_DURATION_MINUTES}" value="${minuto}" style="width:100px; max-width:100px;" /></div>
                      <div style="flex:2; min-width:180px"><label>Entra</label><select id="entra-${i}" data-sub-idx="${i-1}"><option value="">Seleziona...</option>${entraOptions}</select></div>
                      <div style="flex:2; min-width:180px"><label>Esce</label><select id="esce-${i}" data-sub-idx="${i-1}"><option value="">Seleziona...</option>${esceOptions}</select></div>
                  </div>
              `;
          }
          container.innerHTML = subRowsHTML;
          // Ricollega gli event listener (non ricorsivi)
          document.querySelectorAll('#sostituzioni select, #sostituzioni input').forEach(el=>el.addEventListener('change', updatePreviewAndSubstitutions));
      };

      const updatePreview = () => {
        const map = collectTitolariMap();
        const field = byId('preview-field');
        field.innerHTML='';
        Object.entries(map).forEach(([ruolo, pid])=>{
          const p = availablePlayers.find(x=>x.id===pid);
          const pos = POS_331[ruolo];
          if(!p||!pos) return;
          const mk = document.createElement('div');
          mk.className='marker';
          mk.style.top = pos.top;
          mk.style.left = pos.left;
          const cognome = p.cognome;
          mk.innerHTML = `<b>${escapeHtml(cognome)}</b><br>${ruolo}`;
          field.appendChild(mk);
        });
      }
      
      const updatePreviewAndSubstitutions = () => {
        const titolariIds = Object.values(collectTitolariMap()).filter(Boolean);
        const panchinaIds = collectPanchina();
        const allSelected = [...titolariIds, ...panchinaIds]; 

        // Verifica duplicati (logica di validazione client-side)
        const uniqueSet = new Set(allSelected);
        if (allSelected.length !== uniqueSet.size) {
          // Alert non bloccante, la vera validazione è nel salvataggio
          console.warn("Attenzione: un giocatore è stato selezionato più volte (titolare e/o riserva). Correggi la selezione prima di procedere.");
        }
        updatePreview();
        renderPanchinaAndSubstitutions(titolariIds, panchinaIds);
      }

      // --- Logica di Salvataggio aggiornata --- 
      window.saveFormation = async (e,matchId,avv, allFormationsCurrent)=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        
        const titolari = collectTitolariMap();
        const panchina = collectPanchina();
        const sostituzioni = collectSubstitutions();
        
        const titolariIds = Object.values(titolari).filter(Boolean);
        const allSelected = [...titolariIds, ...panchina].filter(Boolean);
        
        // 1. Validazione Base
        if (titolariIds.length !== roles.length) return alert("Devi selezionare 8 titolari.");
        if (allSelected.length !== new Set(allSelected).size) return alert("Attenzione: un giocatore è stato selezionato più volte (titolare e/o riserva). Correggi la selezione.");
        
        // 2. Calcolo formazioni complete
        const formationsToSave = {'0': { formazione: titolari }}; // Formazione iniziale (Minuto 0)
        let currentFormation = { ...titolari };
        
        sostituzioni.forEach(sub => {
            if (formationsToSave[sub.minuto]) {
                alert(`Errore: Ci sono due sostituzioni allo stesso minuto (${sub.minuto}). Correggi.`);
                throw new Error("Sostituzione duplicata.");
            }
            // Aggiorna la formazione
            const ruoloEsce = Object.keys(currentFormation).find(r => currentFormation[r] === sub.esce);
            if (!ruoloEsce) {
                alert(`Errore: Il giocatore in uscita (${availablePlayers.find(p=>p.id===sub.esce)?.label||'?'}) non è in campo al minuto ${sub.minuto}.`);
                throw new Error("Giocatore in uscita non in campo.");
            }
            currentFormation[ruoloEsce] = sub.entra; // L'entrante prende il ruolo dell'uscente
            
            // Salva la nuova mappa
            formationsToSave[sub.minuto] = { formazione: { ...currentFormation } };
        });

        // 3. Salvataggio su Firebase
        try {
          const updates = {};
          updates[`/calendario/${matchId}/formazioni`] = formationsToSave;
          updates[`/calendario/${matchId}/panchina`] = panchina; // Salva la panchina iniziale
          updates[`/calendario/${matchId}/sostituzioni`] = sostituzioni; // Salva la lista di sostituzioni

          await update(ref(db), updates);
          alert('Formazione salvata con successo!');
          window.loadProssimeGiornate(isAdmin); // Aggiorna la vista admin/pubblica
          visualizeAllFormations(avv, formationsToSave);
        } catch(err) {
          alert('Errore salvataggio: ' + err.message);
          console.error(err);
        }
      };
      
      // Funzione per visualizzare tutte le formazioni (storico)
      function visualizeAllFormations(avv,formazioni){
        const content = byId('formations-preview-content');
        if(!content) return;
        content.innerHTML = `<h3>${Object.keys(formazioni).length} Formazioni vs ${escapeHtml(avv)}</h3>
                             <div class="help">Titolare (0’) + mappe dopo ogni sostituzione.</div>`;
        const wrap = document.createElement('div');
        wrap.className='grid cols-3';
        content.appendChild(wrap);
        
        // Ordina le chiavi (minuti)
        const sortedMinutes = Object.keys(formazioni).map(Number).sort((a,b)=>a-b);

        sortedMinutes.forEach(min => {
          const pane = document.createElement('div');
          pane.className='card';
          pane.innerHTML = `<div style="font-weight:800;margin-bottom:6px">Minuto ${min}${min===0?' (Titolare)':''}</div><div class="field"></div>`;
          wrap.appendChild(pane);
          const field = pane.querySelector('.field');
          const f = formazioni[min].formazione;
          
          Object.entries(f).forEach(([ruolo,pid])=>{
            const pl = availablePlayers.find(p=>p.id===pid); // Cerca il giocatore tra quelli disponibili
            const pos = POS_331[ruolo];
            if(!pl||!pos) return;
            const mk = document.createElement('div');
            mk.className='marker';
            mk.style.top = pos.top;
            mk.style.left = pos.left;
            const cognome = pl.cognome;
            mk.innerHTML = `<b>${escapeHtml(cognome)}</b><br>${ruolo}`;
            field.appendChild(mk);
          });
        });
      };
      
      // Funzione per pubblicare/nascondere la formazione
      window.confirmPublish = async (matchId, shouldPublish) => {
        if (!isAdmin) return;
        const action = shouldPublish ? 'pubblicare' : 'nascondere';
        const msg = `Sei sicuro di voler ${action} la formazione per questa partita?`;
        
        if (confirm(msg)) {
          try {
            const updates = {};
            updates[`/calendario/${matchId}/formazionePubblicata`] = shouldPublish;
            await update(ref(db), updates);
            alert(`Formazione ${shouldPublish ? 'pubblicata' : 'nascosta'} con successo!`);
            window.loadProssimeGiornate(isAdmin); // Aggiorna la vista
          } catch (e) {
            alert(`Errore durante l'operazione: ${e.message}`);
          }
        }
      };

      // --- Inizializzazione e Event Listeners ---
      const titolariIds = Object.values(collectTitolariMap()).filter(Boolean);
      renderPanchinaAndSubstitutions(titolariIds, currentPanchina); // Inizializza tutto
      updatePreview(); // Mostra l'anteprima iniziale

      // Event listeners per titolari e panchina per ricalcolare e renderizzare le sostituzioni
      document.querySelectorAll('#titolari select, #panchina select').forEach(sel=>sel.addEventListener('change', updatePreviewAndSubstitutions));
      
      // Event listener generico per l'anteprima quando cambia la sostituzione
      // (Già aggiunto in renderSubstitutionsUI)
    };


    /* ===== NUOVE FUNZIONI ADMIN: GESTIONE PRESTAZIONI PARTITA ===== */
    window.showValutazionePartitaForm = async (matchId, avv) => {
      if(!isAdmin) return;
      window.showAdminSection('admin-prestazioni-partita-section');
      const formContainer = byId('prestazioni-form-container');
      formContainer.innerHTML = 'Caricamento...';
      
      const prestsPath = `prestazioni/${matchId}`;
      const [snapRosa, snapPrests] = await Promise.all([ 
        get(ref(db, 'rosa')), 
        get(ref(db, prestsPath)) 
      ]);
      
      const rosa = snapRosa.val() || {};
      const prestazioni = snapPrests.val() || {};
      
      // Filtra i giocatori che sono stati selezionati per la formazione iniziale (titolari + panchina)
      // Nota: potresti voler filtrare solo quelli che hanno dato disponibilità
      // Per semplicità, consideriamo tutti i giocatori della rosa. Se non hanno prestazioni, non appariranno nel DB 'prestazioni'
      const players = Object.entries(rosa).map(([pid, g]) => {
        const prest = prestazioni[pid] || {};
        return { 
          pid, 
          nome: g.nome, 
          cognome: g.cognome, 
          numero: g.numero, 
          voto: prest.voto, 
          goal: prest.goal 
        };
      }).sort((a,b)=> (a.numero||0)-(b.numero||0));

      let tableHtml = `
        <h2>Admin · Valuta Partita vs ${escapeHtml(avv)}</h2>
        <form id="valutazioni-form">
          <table class="table" style="width:100%">
            <thead>
              <tr>
                <th style="width:40px">#</th>
                <th style="width:35%">Giocatore</th>
                <th style="width:30%">Voto (1-10)</th>
                <th style="width:25%">Goal</th>
              </tr>
            </thead>
            <tbody>
              ${players.map(p => `
                <tr>
                  <td>${p.numero}</td>
                  <td>${escapeHtml(p.nome)} ${escapeHtml(p.cognome)}</td>
                  <td>
                    <input type="number" step="0.5" min="1" max="10" 
                           value="${p.voto !== undefined ? (p.voto === null ? '' : p.voto) : ''}" 
                           data-pid="${p.pid}" data-key="voto" 
                           style="width:100%; max-width:120px;" placeholder="N/D" />
                  </td>
                  <td>
                    <input type="number" min="0" 
                           value="${p.goal !== undefined ? p.goal : ''}" 
                           data-pid="${p.pid}" data-key="goal" 
                           style="width:100%; max-width:80px;" placeholder="0" />
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <div class="actions">
            <button class="btn btn--accent" type="button" onclick="saveValutazioni(event, '${matchId}')">Salva Valutazioni</button>
            <button class="btn" type="button" onclick="window.showAdminSection('admin-calendario-section')">Annulla</button>
          </div>
          <div class="help" style="margin-top:10px;">Lascia il campo Voto vuoto per "Non Votato" (equivalente a null). Goal: 0 se vuoto.</div>
        </form>
      `;
      formContainer.innerHTML = tableHtml;
    };
    
    window.saveValutazioni = async (e, matchId) => {
      e.preventDefault();
      if(!isAdmin) return;

      const inputs = document.querySelectorAll('#valutazioni-form input[data-pid]');
      const updates = {}; // { pid: { voto: number|null, goal: number } }

      inputs.forEach(input => {
        const pid = input.getAttribute('data-pid');
        const key = input.getAttribute('data-key');
        
        if (!updates[pid]) updates[pid] = {};

        let value;
        if (key === 'voto') {
          // Voto: stringa vuota o non numerica = null, altrimenti numero
          const rawValue = input.value.trim();
          value = (rawValue === '' || isNaN(parseFloat(rawValue))) ? null : parseFloat(rawValue);
          if(value !== null && (value < 1 || value > 10)) {
             alert(`Il voto per ${updates[pid].nome||pid} deve essere tra 1 e 10.`);
             throw new Error("Voto fuori range");
          }
        } else if (key === 'goal') {
          // Goal: stringa vuota = 0, altrimenti numero
          value = Number(input.value || 0);
        }
        
        updates[pid][key] = value;
      });

      const finalUpdates = {}; 
      // Filtra i giocatori che hanno almeno un dato (voto o goal)
      Object.entries(updates).forEach(([pid, data]) => {
        const votoValid = (data.voto === null || typeof data.voto === 'number');
        const goalValid = typeof data.goal === 'number';

        // Solo salva se c'è almeno un dato valido
        if (votoValid || data.goal > 0) {
           // Se voto è valido, lo salviamo. Se goal è valido, lo salviamo (minimo 0).
           if (votoValid && goalValid) {
               finalUpdates[pid] = { voto: data.voto, goal: data.goal };
           } else if (votoValid) {
               finalUpdates[pid] = { voto: data.voto, goal: 0 }; // Se mancano i goal, li forziamo a 0
           }
        }
      });
      
      try {
        await set(ref(db, `prestazioni/${matchId}`), finalUpdates);
        alert('Valutazioni salvate con successo!');
        window.showAdminSection('admin-calendario-section');
        // Aggiorna l'aggregato in background
        window.loadPrestazioniAggregato();
        loadStatistiche(); // Aggiorna anche la lista risultati
      } catch (err) {
        alert('Errore salvataggio: ' + err.message);
        console.error(err);
      }
    };
    
    /* ===== Admin: Candidature (CRUD Esterno) ===== */

    window.loadCandidature = async () => {
      if(!isAdmin) return;
      const list = byId('admin-candidature-list');
      if(!list) return;
      list.innerHTML = 'Caricamento candidature...';
      
      const snap = await get(ref(db,'calendario'));
      const val = snap.val() || {};
      let entries = Object.entries(val);
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      const today = new Date(); today.setHours(0,0,0,0);
      entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
      
      list.innerHTML = '';
      for(const [matchId,m] of entries){
        const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
        const cand = candSnap.val() || {};
        const candCount = Object.values(cand).filter(Boolean).length;
        const isPast = toDate(m.data) < today;

        const li = document.createElement('li'); 
        li.className = 'card';
        li.style.marginBottom = '6px';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.padding = '10px 16px';
        
        li.innerHTML = `
          <div>
            <strong>vs ${escapeHtml(m.avversaria)}</strong> (${m.data})<br>
            <span class="player-sub">${escapeHtml(m.campo)}</span>
          </div>
          <div style="text-align:right;">
             <span class="pill">${candCount} Candidati</span><br>
             <button class="btn btn--admin" style="margin-top:6px" onclick="openCandidatureEditor('${matchId}', '${escapeHtml(m.avversaria)}')">${isPast ? 'Visualizza' : 'Modifica'}</button>
          </div>
        `;
        list.appendChild(li);
      }
      if(list.children.length === 0){
        list.innerHTML = '<li><div class="help">Nessuna partita a calendario.</div></li>';
      }
    };

    window.openCandidatureEditor = async (matchId, avv) => {
      if(!isAdmin) return;
      byId('crud-candidature-panel').style.display='block';
      byId('crud-partite').style.display='none';
      byId('crud-candidature').style.display='none';
      
      const panel = byId('crud-candidature-panel');
      panel.querySelector('h2').textContent = `Admin · Modifica Candidature vs ${avv}`;
      
      const tbody = byId('crud-candidature-tbody');
      tbody.innerHTML = 'Caricamento...';
      
      const [snapRosa, snapCandidature, snapUtenti] = await Promise.all([
        get(ref(db,'rosa')),
        get(ref(db,`calendario/${matchId}/candidature`)),
        get(ref(db,'utenti'))
      ]);
      
      const rosa = snapRosa.val()||{};
      const cand = snapCandidature.val()||{};
      const utentiMap = snapUtenti.val()||{};

      const nameToUid = {};
      Object.entries(utentiMap).forEach(([uid,u])=>{
        if(u.nome&&u.cognome) nameToUid[`${u.nome} ${u.cognome}`]=uid;
      });

      const rows = Object.entries(rosa).map(([pid, g]) => {
        const display = `${g.nome} ${g.cognome} (#${g.numero})`;
        const uid = nameToUid[`${g.nome} ${g.cognome}`] || null;
        const checked = uid ? !!cand[uid] : false;
        return {pid, display, uid, checked};
      }).sort((a,b)=> a.display.localeCompare(b.display,'it'));

      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.display)}</td>
          <td>${r.uid ? r.uid : '<span class="help">Nessun utente collegato</span>'}</td>
          <td><input type="checkbox" ${r.checked?'checked':''} data-cand="${r.uid||''}" ${r.uid?'':'disabled'} /></td>`;
        tbody.appendChild(tr);
      }
      
      // Aggancia il pulsante Salva
      const saveBtn = byId('crud-candidature-save');
      saveBtn.onclick = async ()=>{
        if(!isAdmin) return;
        const inputs = tbody.querySelectorAll('input[type="checkbox"][data-cand]');
        const updates = {};
        inputs.forEach(chk=>{
          const uid = chk.getAttribute('data-cand');
          if(!uid) return;
          updates[`/calendario/${matchId}/candidature/${uid}`] = chk.checked;
        });
        
        await update(ref(db), updates);
        alert('Candidature aggiornate.');
        window.loadProssimeGiornate(true);
        window.loadProssimeGiornate(false);
        window.loadCandidature();
        window.closeCandidatureEditor();
      };
    };

    window.closeCandidatureEditor = ()=>{
      byId('crud-candidature-panel').style.display='none';
      byId('crud-candidature').style.display='block';
      byId('crud-partite').style.display='none';
    };

    
    /* ===== Admin: inserimenti base e funzioni di salvataggio (dal tuo codice) ===== */
    window.addPlayer = async (e)=>{
      e?.preventDefault();
      if(!isAdmin) return alert('Accesso negato.');
      const nome = v('giocatore-nome');
      const cognome = v('giocatore-cognome');
      const numero = parseInt(v('giocatore-numero')||'0',10);
      const ruolo = v('giocatore-ruolo');
      const stato = v('giocatore-titolare');

      if(!nome||!cognome||!numero||!ruolo) return alert('Compila tutti i campi');

      try{
        const newRef = push(ref(db, 'rosa')); // Crea un ID univoco
        await set(newRef, { 
          nome, cognome, numero, ruolo, stato,
          presenze: 0 // Inizializza a 0 per la logica di formazione
        });
        alert('Giocatore aggiunto con successo!');
        e.target.reset();
        loadRosa();
        window.loadCrudGiocatori(); // Aggiorna la lista
      }catch(err){ alert('Errore: '+err.message); }
    };

    window.addMatch = async (e)=>{
      e?.preventDefault();
      if(!isAdmin) return alert('Accesso negato.');
      const data = v('match-data');
      const orario = v('match-ora');
      const avversaria = v('match-avversaria');
      const campo = v('match-campo');
      const casa = v('match-casa') === 'casa';

      if(!data||!avversaria||!campo) return alert('Compila i campi obbligatori.');

      try{
        const newRef = push(ref(db, 'calendario'));
        await set(newRef, { 
          data, orario, avversaria, campo, casa,
          risultato: 'N/D',
          formazionePubblicata: false
        });
        alert('Partita aggiunta con successo!');
        e.target.reset();
        window.loadProssimeGiornate(true); // Aggiorna il calendario admin
        window.loadCrudPartite(); // Aggiorna la lista
      }catch(err){ alert('Errore: '+err.message); }
    };
    
    
    /* ===== Admin: CRUD Giocatori ===== */
    let currentPlayerId = null;
    let currentMatchId = null;

    window.loadCrudGiocatori = async () => {
        const table = byId('crud-giocatori-tbody');
        if(!table) return;
        table.innerHTML = '<tr><td colspan="6">Caricamento...</td></tr>';
        
        const snap = await get(ref(db,'rosa'));
        const rosa = snap.val() || {};
        
        let html = '';
        Object.entries(rosa).sort((a,b)=>(a[1].numero||0)-(b[1].numero||0)).forEach(([id, g]) => {
            html += `
                <tr>
                    <td>${g.numero}</td>
                    <td>${escapeHtml(g.nome)} ${escapeHtml(g.cognome)}</td>
                    <td>${g.ruolo}</td>
                    <td>${g.stato}</td>
                    <td>${g.presenze || 0}</td>
                    <td>
                        <button class="btn" style="padding:4px 8px;" onclick="editPlayer('${id}', '${escapeHtml(g.nome)}', '${escapeHtml(g.cognome)}', ${g.numero}, '${g.ruolo}', '${g.stato}', ${g.presenze||0})">Modifica</button>
                        <button class="btn btn--accent" style="padding:4px 8px; background:#e00;" onclick="deletePlayer('${id}', '${escapeHtml(g.nome)} ${escapeHtml(g.cognome)}')">Elimina</button>
                    </td>
                </tr>
            `;
        });
        table.innerHTML = html || '<tr><td colspan="6">Nessun giocatore.</td></tr>';
        byId('crud-giocatori').style.display = 'block';
        byId('crud-giocatori-form-panel').style.display = 'none';
        
        // Assicura che la vista sia corretta dopo l'inizializzazione
        document.getElementById('crud-giocatori').style.display='block';
        document.getElementById('crud-partite').style.display='none';
        document.getElementById('crud-candidature').style.display='none';
    };

    window.editPlayer = (id, nome, cognome, numero, ruolo, stato, presenze) => {
        currentPlayerId = id;
        byId('player-edit-title').textContent = `Modifica ${nome} ${cognome}`;
        byId('edit-nome').value = nome;
        byId('edit-cognome').value = cognome;
        byId('edit-numero').value = numero;
        byId('edit-ruolo').value = ruolo;
        byId('edit-titolare').value = stato;
        byId('edit-presenze').value = presenze;
        
        byId('crud-giocatori').style.display = 'none';
        byId('crud-giocatori-form-panel').style.display = 'block';
    };
    
    window.savePlayer = async (e) => {
        e.preventDefault();
        if(!isAdmin || !currentPlayerId) return alert('Errore di sistema o non admin.');

        const updates = {
            nome: v('edit-nome'),
            cognome: v('edit-cognome'),
            numero: parseInt(v('edit-numero')||'0', 10),
            ruolo: v('edit-ruolo'),
            stato: v('edit-titolare'),
            presenze: parseInt(v('edit-presenze')||'0', 10)
        };

        try{
            await update(ref(db, 'rosa/' + currentPlayerId), updates);
            alert('Giocatore aggiornato con successo!');
            currentPlayerId = null;
            window.loadCrudGiocatori();
            loadRosa(); // Aggiorna anche la rosa pubblica
        }catch(err){ alert('Errore: '+err.message); }
    };

    window.deletePlayer = async (id, name) => {
        if(!isAdmin || !confirm(`Sei sicuro di voler eliminare ${name}?`)) return;
        try{
            await remove(ref(db, 'rosa/' + id));
            alert('Giocatore eliminato.');
            window.loadCrudGiocatori();
            loadRosa();
        }catch(err){ alert('Errore: '+err.message); }
    };
    
    window.closePlayerEditor = () => {
        currentPlayerId = null;
        byId('crud-giocatori').style.display = 'block';
        byId('crud-giocatori-form-panel').style.display = 'none';
    };


    /* ===== Admin: CRUD Partite ===== */

    window.loadCrudPartite = async () => {
        const table = byId('crud-partite-tbody');
        if(!table) return;
        table.innerHTML = '<tr><td colspan="7">Caricamento...</td></tr>';
        
        const snap = await get(ref(db,'calendario'));
        const calendario = snap.val() || {};
        
        let html = '';
        Object.entries(calendario).reverse().forEach(([id, m]) => { // Inverti per mostrare le più recenti
            html += `
                <tr>
                    <td>${m.data || 'N/D'}</td>
                    <td>${m.avversaria}</td>
                    <td>${m.risultato}</td>
                    <td>${m.campo}</td>
                    <td>${m.casa ? 'Casa' : 'Trasferta'}</td>
                    <td>${m.formazionePubblicata ? 'SI' : 'NO'}</td>
                    <td>
                        <button class="btn" style="padding:4px 8px;" onclick="editMatch('${id}', '${escapeHtml(m.data)}', '${escapeHtml(m.orario||'')}', '${escapeHtml(m.avversaria)}', '${escapeHtml(m.campo)}', '${m.casa}', '${escapeHtml(m.risultato)}', '${m.linkVideo||''}')">Modifica</button>
                        <button class="btn btn--accent" style="padding:4px 8px; background:#e00;" onclick="deleteMatch('${id}', '${escapeHtml(m.avversaria)}')">Elimina</button>
                    </td>
                </tr>
            `;
        });
        table.innerHTML = html || '<tr><td colspan="7">Nessuna partita.</td></tr>';
        byId('crud-partite').style.display = 'block';
        byId('crud-partite-form-panel').style.display = 'none';
    };

    window.editMatch = (id, data, orario, avversaria, campo, casa, risultato, linkVideo) => {
        currentMatchId = id;
        byId('match-edit-title').textContent = `Modifica Partita vs ${avversaria}`;
        byId('edit-match-data').value = data;
        byId('edit-match-ora').value = orario;
        byId('edit-match-avversaria').value = avversaria;
        byId('edit-match-campo').value = campo;
        byId('edit-match-casa').value = casa === 'true' ? 'casa' : 'trasferta'; // Conversione booleana
        byId('edit-match-risultato').value = risultato;
        byId('edit-match-linkvideo').value = linkVideo;

        // Inizializza DatePicker solo se non è già inizializzato
        if (!$("#edit-match-data").data('datepicker')) {
            $("#edit-match-data").datepicker({ dateFormat:"dd/mm/yy" });
        }
        
        byId('crud-partite').style.display = 'none';
        byId('crud-partite-form-panel').style.display = 'block';
    };
    
    window.saveMatch = async (e) => {
        e.preventDefault();
        if(!isAdmin || !currentMatchId) return alert('Errore di sistema o non admin.');

        const updates = {
            data: v('edit-match-data'),
            orario: v('edit-match-ora'),
            avversaria: v('edit-match-avversaria'),
            campo: v('edit-match-campo'),
            casa: v('edit-match-casa') === 'casa',
            risultato: v('edit-match-risultato') || 'N/D',
            linkVideo: v('edit-match-linkvideo') || null
        };

        try{
            await update(ref(db, 'calendario/' + currentMatchId), updates);
            alert('Partita aggiornata con successo!');
            currentMatchId = null;
            window.loadCrudPartite();
            window.loadProssimeGiornate(true); // Aggiorna il calendario admin
            window.loadProssimeGiornate(false); // Aggiorna il calendario pubblico
            loadStatistiche();
        }catch(err){ alert('Errore: '+err.message); }
    };

    window.deleteMatch = async (id, name) => {
        if(!isAdmin || !confirm(`Sei sicuro di voler eliminare la partita vs ${name}?`)) return;
        try{
            // Rimuove la partita e le prestazioni associate
            await remove(ref(db, 'calendario/' + id));
            await remove(ref(db, 'prestazioni/' + id));
            alert('Partita eliminata.');
            window.loadCrudPartite();
            window.loadProssimeGiornate(true);
            window.loadProssimeGiornate(false);
            loadStatistiche();
            window.loadPrestazioniAggregato();
        }catch(err){ alert('Errore: '+err.message); }
    };
    
    window.closeMatchEditor = () => {
        currentMatchId = null;
        byId('crud-partite').style.display = 'block';
        byId('crud-partite-form-panel').style.display = 'none';
    };
    
  </script>
</head>
<body>
  <header>
    <div class="hero" role="banner">
      <img src="Logo.png" alt="Logo AC Tuscolano" />
      <div class="brand">
        <h1 class="club">AC Tuscolano</h1>
        <p class="tag">Football Club</p>
      </div>
    </div>
  </header>

  <nav aria-label="Navigazione principale">
    <div class="nav-wrap">
      <button id="rosa-tab" class="tab" data-target="rosa-section" aria-current="page" onclick="showPublicSection('rosa-section')">La nostra Rosa</button>
      <button id="calendario-tab" class="tab" data-target="calendario-section" onclick="showPublicSection('calendario-section')">Calendario & Partite</button>
      <button id="classifica-tab" class="tab" data-target="classifica-section" onclick="showPublicSection('classifica-section')">Classifica</button>
      <button id="statistiche-tab" class="tab" data-target="statistiche-section" onclick="showPublicSection('statistiche-section')">Statistiche & Voti</button>
      <button id="video-tab" class="tab" data-target="video-section" onclick="showPublicSection('video-section')">Video</button>
      <a href="https://www.romatornei.it/calcio-a-8-over-40-roma-sud" target="_blank" class="tab" style="text-decoration:none;">Torneo</a>
      <button id="auth-toggle-btn" class="btn" onclick="handleAuthToggle()">Login</button>
    </div>
  </nav>

  <div id="admin-menu" style="display:none">
    <nav class="nav-wrap" aria-label="Menu Admin">
        <button class="tab" data-admin-target="admin-inserimento-giocatori-section" onclick="showAdminSection('admin-inserimento-giocatori-section')">Giocatori</button>
        <button class="tab" data-admin-target="admin-inserimento-giornate-section" onclick="showAdminSection('admin-inserimento-giornate-section')">Partita</button>
        <button class="tab" data-admin-target="admin-calendario-section" onclick="showAdminSection('admin-calendario-section')">Calendario Admin</button>
        <button class="tab" data-admin-target="admin-gestione-dati-section" onclick="showAdminSection('admin-gestione-dati-section')">Gestione Dati</button>
        <button class="tab" data-admin-target="admin-candidature-section" onclick="showAdminSection('admin-candidature-section')">Candidature</button>
        <button class="tab" data-admin-target="admin-video-section" onclick="showAdminSection('admin-video-section')">Gestione Video</button>
        <button class="tab" data-admin-target="admin-classifica-section" onclick="showAdminSection('admin-classifica-section')">Classifica Admin</button>
        <button class="tab" data-admin-target="admin-utenti-section" onclick="showAdminSection('admin-utenti-section')">Utenti</button>
    </nav>
  </div>

  <main>
    <section id="rosa-section">
      <h2>La nostra Rosa</h2>
      <div class="help">Lista dei giocatori, ordinata per numero di maglia.</div>
      <ul id="rosa-list" class="grid cols-2">
        <li>Caricamento giocatori...</li>
      </ul>
    </section>

    <section id="calendario-section" style="display:none">
      <h2>Calendario & Prossime Partite</h2>
      <div class="help">Lista ordinata dalla partita più recente.</div>
      <ul id="calendario-list" class="grid cols-3"></ul>
    </section>

    <section id="classifica-section" style="display:none">
      <h2>Classifica</h2>
      <div id="classifica-content" style="overflow-x:auto;">
        </div>
    </section>

    <section id="statistiche-section" style="display:none">
      <h2>Prestazioni</h2>
      
      <h3>Risultati squadra</h3>
      <div class="help">Lista ordinata dalla partita più recente.</div>
      <ul id="statistiche-risultati-list"> 
      </ul>

      <div id="prestazioni-aggregate-content">
        <h3>Riepilogo Giocatori</h3>
        <div class="help">Calcolo media voti e goal in corso…</div>
        </div>
    </section>

    <section id="video-section" style="display:none">
      <h2>Video Partite Concluse</h2>
      <ul id="video-list-ul" style="display:grid; gap:16px;">
        </ul>
    </section>

    <section id="formazione-pubblica-section" style="display:none">
      <h2>Formazione Ufficiale</h2>
      <div id="formazione-pubblica-content"></div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showPublicSection('calendario-section')">Torna al calendario</button></div>
    </section>

    <section id="prestazioni-partita-section" style="display:none">
      <h2>Prestazioni Partita</h2>
      <div id="prestazioni-partita-content"></div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="showPublicSection('calendario-section')">Torna al calendario</button></div>
    </section>

    <section id="admin-inserimento-giocatori-section" style="display:none">
      <h2>Admin · Inserimento giocatori</h2>
      <form id="giocatore-form" onsubmit="addPlayer(event)">
        <label>Nome</label><input id="giocatore-nome" required />
        <label>Cognome</label><input id="giocatore-cognome" required />
        <label>Numero Maglia</label><input id="giocatore-numero" type="number" min="1" max="99" required />
        <label>Ruolo</label>
        <select id="giocatore-ruolo" required>
          <option value="">Seleziona ruolo</option>
          <option>Portiere</option>
          <option>Terzino sinistro</option>
          <option>Terzino destro</option>
          <option>Difensore centrale</option>
          <option>Centrocampista centrale</option>
          <option>Centrocampista sinistro</option>
          <option>Centrocampista destro</option>
          <option>Attaccante centrale</option>
        </select>
        <label>Stato Giocatore</label>
        <select id="giocatore-titolare" required>
          <option>Tesserato</option>
          <option>In prova</option>
          <option>Sospeso</option>
          <option>Non Disponibile</option>
        </select>
        <div class="actions">
          <button class="btn btn--accent" type="submit">Aggiungi Giocatore</button>
        </div>
      </form>
    </section>

    <section id="admin-inserimento-giornate-section" style="display:none">
      <h2>Admin · Inserimento Partita</h2>
      <form id="match-form" onsubmit="addMatch(event)">
        <label>Data Partita</label><input id="match-data" required readonly />
        <label>Ora Partita</label><input id="match-ora" type="time" placeholder="HH:MM" />
        <label>Avversaria</label><input id="match-avversaria" required />
        <label>Campo</label><input id="match-campo" required />
        <label>Tipo Partita</label>
        <select id="match-casa" required>
          <option value="casa">Casa</option>
          <option value="trasferta">Trasferta</option>
        </select>
        <div class="actions">
          <button class="btn btn--accent" type="submit">Aggiungi Partita</button>
        </div>
      </form>
    </section>

    <section id="admin-calendario-section" style="display:none">
      <h2>Admin · Gestione Calendario & Partite</h2>
      <div class="help">Gestisci formazione, candidature e votazioni.</div>
      <ul id="admin-calendario-list" class="grid cols-3">
        <li>Caricamento partite...</li>
      </ul>
    </section>
    
    <section id="admin-formazione-section" style="display:none">
      <div id="formazione-form-container"></div>
    </section>

    <section id="admin-prestazioni-partita-section" style="display:none">
      <div id="prestazioni-form-container"></div>
    </section>

    <section id="admin-candidature-section" style="display:none">
      <h2>Admin · Gestione Candidature</h2>
      <div class="help">Gestione candidature per singola partita. Clicca su Modifica.</div>
      
      <div id="crud-candidature">
        <ul id="admin-candidature-list" class="grid cols-2"></ul>
      </div>
      
      <div id="crud-candidature-panel" style="display:none;">
        <h2>Admin · Modifica Candidature</h2>
        <table class="table" style="margin-top:10px;">
          <thead>
            <tr>
              <th>Giocatore</th>
              <th>UID Utente</th>
              <th style="width:100px;">Disponibile</th>
            </tr>
          </thead>
          <tbody id="crud-candidature-tbody">
            </tbody>
        </table>
        <div class="actions">
          <button id="crud-candidature-save" class="btn btn--accent" type="button">Salva Candidature</button>
          <button class="btn" type="button" onclick="closeCandidatureEditor()">Chiudi</button>
        </div>
      </div>
    </section>

    <section id="admin-gestione-dati-section" style="display:none">
      <h2>Admin · Gestione dati</h2>
      <div class="card" style="margin-bottom:14px">
        <div class="row">
          <button class="tab" aria-current="page" onclick="document.getElementById('crud-giocatori').style.display='block';document.getElementById('crud-partite').style.display='none';document.getElementById('crud-candidature').style.display='none';loadCrudGiocatori()">Giocatori</button>
          <button class="tab" onclick="document.getElementById('crud-giocatori').style.display='none';document.getElementById('crud-partite').style.display='block';document.getElementById('crud-candidature').style.display='none';loadCrudPartite()">Partite</button>
          <button class="tab" onclick="document.getElementById('crud-giocatori').style.display='none';document.getElementById('crud-partite').style.display='none';document.getElementById('crud-candidature').style.display='block';loadCandidature()">Candidature</button>
        </div>
      </div>

      <div id="crud-giocatori" style="display:none">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Giocatore</th>
              <th>Ruolo</th>
              <th>Stato</th>
              <th>Pres.</th>
              <th style="width:150px">Azioni</th>
            </tr>
          </thead>
          <tbody id="crud-giocatori-tbody">
            </tbody>
        </table>
      </div>

      <div id="crud-giocatori-form-panel" style="display:none;">
          <h3 id="player-edit-title">Modifica Giocatore</h3>
          <form onsubmit="savePlayer(event)">
              <label>Nome</label><input id="edit-nome" required />
              <label>Cognome</label><input id="edit-cognome" required />
              <label>Numero Maglia</label><input id="edit-numero" type="number" min="1" max="99" required />
              <label>Ruolo</label>
              <select id="edit-ruolo" required>
                <option>Portiere</option><option>Terzino sinistro</option><option>Terzino destro</option>
                <option>Difensore centrale</option><option>Centrocampista centrale</option><option>Centrocampista sinistro</option>
                <option>Centrocampista destro</option><option>Attaccante centrale</option>
              </select>
              <label>Stato Giocatore</label>
              <select id="edit-titolare" required>
                <option>Tesserato</option><option>In prova</option><option>Sospeso</option><option>Non Disponibile</option>
              </select>
              <label>Presenze Manuali (per ordinamento)</label><input id="edit-presenze" type="number" min="0" />
              <div class="actions">
                  <button class="btn btn--accent" type="submit">Salva Modifiche</button>
                  <button class="btn" type="button" onclick="closePlayerEditor()">Annulla</button>
              </div>
          </form>
      </div>

      <div id="crud-partite" style="display:none">
        <table class="table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Avversaria</th>
              <th>Risultato</th>
              <th>Campo</th>
              <th>Casa/Trasf.</th>
              <th>Form. Pub.</th>
              <th style="width:150px">Azioni</th>
            </tr>
          </thead>
          <tbody id="crud-partite-tbody">
            </tbody>
        </table>
      </div>

      <div id="crud-partite-form-panel" style="display:none;">
        <h3 id="match-edit-title">Modifica Partita</h3>
        <form onsubmit="saveMatch(event)">
            <label>Data Partita</label><input id="edit-match-data" required readonly />
            <label>Ora Partita</label><input id="edit-match-ora" type="time" placeholder="HH:MM" />
            <label>Avversaria</label><input id="edit-match-avversaria" required />
            <label>Campo</label><input id="edit-match-campo" required />
            <label>Tipo Partita</label>
            <select id="edit-match-casa" required>
              <option value="casa">Casa</option>
              <option value="trasferta">Trasferta</option>
            </select>
            <label>Risultato (Es: 3-2)</label><input id="edit-match-risultato" placeholder="N/D" />
            <label>Link Video YouTube</label><input id="edit-match-linkvideo" placeholder="Opzionale" />
            <div class="actions">
                <button class="btn btn--accent" type="submit">Salva Modifiche</button>
                <button class="btn" type="button" onclick="closeMatchEditor()">Annulla</button>
            </div>
        </form>
      </div>

    </section>

    <section id="admin-classifica-section" style="display:none">
        <h2>Admin · Aggiorna Classifica</h2>
        <div class="help">Questa funzione scarica la classifica più recente dal sito ufficiale e la memorizza nel database per la visualizzazione pubblica.</div>
        <div class="actions">
            <button class="btn btn--accent" type="button" onclick="updateClassificaFromSito()">Aggiorna Classifica Ora</button>
        </div>
        <div id="admin-classifica-status" class="help" style="margin-top:10px;">
          </div>
    </section>

    <section id="admin-utenti-section" style="display:none">
      <h2>Admin · Creazione Utenti</h2>
      <form id="create-user-form">
        <label>Nome</label><input id="new-nome" required />
        <label>Cognome</label><input id="new-cognome" required />
        <label>Email (Username)</label><input id="new-email" type="email" required />
        <label>Password (Temporanea)</label><input id="new-password" type="password" required />
        <div class="actions">
          <button class="btn btn--accent" type="submit">Crea Utente</button>
        </div>
      </form>
      <div class="help">L’admin resta connesso durante la creazione grazie all’autenticazione secondaria.</div>
    </section>

    <section id="admin-video-section" style="display:none">
      <h2>Admin · Gestione Video</h2>
      <div class="help">Inserisci o aggiorna il link YouTube di una partita conclusa.</div>
      <label>Seleziona Partita</label>
      <select id="video-partita-select"></select>
      <label>Link YouTube</label>
      <input id="video-link-input" placeholder="https://www.youtube.com/watch?v=..." />
      <div class="actions">
        <button id="save-video-btn" class="btn btn--accent" type="button" disabled>Salva Link Video</button>
      </div>
    </section>

    <section id="login-section" style="display:none">
      <h2>Accesso</h2>
      <form id="login-form">
        <label>Email</label><input id="login-email" type="email" required />
        <label>Password</label><input id="login-password" type="password" required />
        <div class="actions">
          <button class="btn btn--accent" type="submit">Accedi</button>
        </div>
      </form>
    </section>
  </main>

  <div id="video-modal">
    <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button" style="position:absolute; top:-15px; right:-15px; z-index:110; width:30px; height:30px; padding:0; line-height:30px;">X</button>
      <div id="video-iframe-container">
        </div>
    </div>
  </div>

  <footer>
    &copy; AC Tuscolano Football Club
  </footer>
</body>
</html>
